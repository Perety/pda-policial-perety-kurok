<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Sistema Policial Global - Seguro</title>
<style>
:root{--bg-1:#06121a;--bg-2:#071729;--muted:#9fb3bd;--text:#e6f0f6;--accent:#7c3aed;--accent-2:#06b6a4;--danger:#ff6b6b;--glass:rgba(255,255,255,0.03);--card-grad:linear-gradient(180deg,rgba(255,255,255,0.014),rgba(255,255,255,0.006));--radius:12px;--shadow:0 14px 40px rgba(2,6,10,0.6);font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Arial}
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%;background:radial-gradient(800px 300px at 12% 8%,rgba(124,58,237,0.06),transparent),linear-gradient(180deg,var(--bg-2) 0%,var(--bg-1) 60%);color:var(--text);-webkit-font-smoothing:antialiased}
.bg{position:fixed;inset:0;z-index:0;pointer-events:none;overflow:hidden}
.nebula{position:absolute;width:60vmax;height:60vmax;left:-10vmin;top:-8vmin;background:radial-gradient(circle at 30% 30%,rgba(124,58,237,0.24),transparent 30%),radial-gradient(circle at 70% 70%,rgba(6,182,164,0.12),transparent 25%);filter:blur(56px) saturate(120%);animation:float 12s ease-in-out infinite}
.nebula.r{right:-10vmin;left:auto;top:6vmin;background:radial-gradient(circle at 70% 20%,rgba(255,80,120,0.20),transparent 30%),radial-gradient(circle at 30% 80%,rgba(110,231,183,0.12),transparent 25%);animation-duration:10s;animation-direction:reverse}
@keyframes float{0%,100%{transform:translateY(-8px)}50%{transform:translateY(8px)}}
.wrap{max-width:1200px;margin:22px auto;padding:20px;position:relative;z-index:2}
header{display:flex;align-items:center;justify-content:space-between;gap:18px;margin-bottom:20px;flex-wrap:wrap}
.brand{display:flex;gap:12px;align-items:center}
.logo{width:60px;height:60px;border-radius:12px;background:linear-gradient(135deg,var(--accent-2),var(--accent));display:flex;align-items:center;justify-content:center;font-weight:900;color:#031018;font-size:28px}
h1{font-size:18px}
.subtitle{color:var(--muted);font-size:13px}
.top-right{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.pill{background:var(--glass);padding:8px 12px;border-radius:999px;font-weight:700;color:var(--muted);font-size:13px}
.btn{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#031018;padding:8px 16px;border-radius:10px;border:none;cursor:pointer;font-weight:800;transition:all .2s;font-size:13px}
.btn:hover{transform:translateY(-2px);opacity:0.9}
.btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.08);color:var(--muted);padding:7px 12px;border-radius:10px;cursor:pointer;transition:all .2s;font-weight:600;font-size:13px}
.btn-ghost:hover{border-color:var(--accent);color:var(--text)}
.btn-danger{background:linear-gradient(90deg,#ef4444,#dc2626);color:white}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:16px;margin-top:20px}
.card{background:var(--card-grad);border-radius:var(--radius);padding:20px;border:1px solid rgba(255,255,255,0.04);box-shadow:var(--shadow);min-height:140px;transition:all .18s;cursor:pointer;position:relative}
.card:hover{transform:translateY(-8px);box-shadow:0 30px 60px rgba(0,0,0,0.7);border-color:rgba(140,80,240,0.12)}
.card .icon{font-size:42px;margin-bottom:12px}
.card .title{font-weight:900;font-size:18px;margin-bottom:4px}
.card .desc{color:var(--muted);font-size:13px}
.card .badge{position:absolute;top:12px;right:12px;background:rgba(124,58,237,0.2);padding:4px 10px;border-radius:12px;font-size:11px;font-weight:800;color:var(--accent)}
.expanded{margin-top:20px;border-radius:12px;padding:24px;background:linear-gradient(180deg,rgba(255,255,255,0.012),rgba(255,255,255,0.006));border:1px solid rgba(255,255,255,0.04);box-shadow:0 16px 44px rgba(0,0,0,0.55);animation:slideUp .3s ease}
@keyframes slideUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:none}}
.list{display:flex;flex-direction:column;gap:10px;max-height:500px;overflow-y:auto;padding-right:4px}
.list::-webkit-scrollbar{width:6px}
.list::-webkit-scrollbar-track{background:rgba(0,0,0,0.2);border-radius:10px}
.list::-webkit-scrollbar-thumb{background:rgba(124,58,237,0.3);border-radius:10px}
.item{padding:14px;border-radius:10px;background:rgba(255,255,255,0.012);border:1px solid rgba(255,255,255,0.03);transition:all .2s;display:flex;justify-content:space-between;align-items:center;gap:12px}
.item:hover{background:rgba(255,255,255,0.02);border-color:rgba(140,80,240,0.08)}
input,textarea,select{background:rgba(0,0,0,0.25);border:1px solid rgba(255,255,255,0.06);padding:10px 12px;border-radius:8px;color:var(--text);font:inherit;transition:all .2s;width:100%}
input:focus,textarea:focus,select:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px rgba(124,58,237,0.1)}
textarea{min-height:100px;resize:vertical}
label{display:block;margin-bottom:6px;font-size:13px;font-weight:600;color:var(--muted)}
.overlay{position:fixed;inset:0;background:rgba(2,6,10,0.92);backdrop-filter:blur(12px);display:none;align-items:center;justify-content:center;z-index:9999}
.overlay.show{display:flex}
.modal{width:480px;max-width:95%;background:linear-gradient(180deg,#0a1628,#061421);padding:32px;border-radius:14px;border:1px solid rgba(255,255,255,0.08);box-shadow:0 25px 70px rgba(0,0,0,0.9)}
.modal h3{font-size:24px;margin-bottom:8px}
.muted{color:var(--muted)}
.small{font-size:13px}
.mt-2{margin-top:8px}
.mt-3{margin-top:12px}
.flex{display:flex}
.flex-col{flex-direction:column}
.gap-2{gap:8px}
.grid-2{display:grid;grid-template-columns:2fr 1fr;gap:20px}
.sync-indicator{position:fixed;bottom:20px;right:20px;background:var(--glass);backdrop-filter:blur(10px);padding:10px 16px;border-radius:999px;border:1px solid rgba(255,255,255,0.1);display:flex;align-items:center;gap:8px;z-index:1000}
.sync-dot{width:8px;height:8px;background:#4ade80;border-radius:50%;animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.5}}
footer{margin-top:40px;text-align:center;color:var(--muted);font-size:12px;padding-bottom:20px}
@keyframes slideIn{from{transform:translateX(100%)}to{transform:translateX(0)}}
@keyframes slideOut{from{transform:translateX(0)}to{transform:translateX(100%)}}
</style>
</head>
<body>
<div class="bg"><div class="nebula"></div><div class="nebula r"></div></div>
<div class="wrap">
<header>
<div class="brand">
<div class="logo">üõ°Ô∏è</div>
<div><h1>Sistema Policial Global</h1><div class="subtitle">üåç Sincronizaci√≥n mundial con Supabase</div></div>
</div>
<div class="top-right">
<div id="userDisplay" class="pill">Conectando...</div>
<button id="btnLogin" class="btn-ghost">Entrar</button>
<button id="btnLogout" class="btn-ghost" style="display:none">Salir</button>
<div id="adminIndicator" style="display:none" class="pill">üëë Admin</div>
</div>
</header>
<div class="grid" id="cardsGrid"></div>
<div id="expandedArea"></div>
<footer>Sistema Policial Global ‚Ä¢ Sincronizado con Supabase ‚Ä¢ 100% Gratis ‚Ä¢ Seguro</footer>
</div>
<div class="sync-indicator">
<div class="sync-dot"></div>
<span class="small">Sincronizado</span>
</div>
<div id="loginModal" class="overlay">
<div class="modal">
<h3>Iniciar Sesi√≥n</h3>
<div class="muted small">‚ö†Ô∏è Acceso solo para usuarios autorizados</div>
<div style="margin-top:24px">
<label>Usuario</label>
<input id="loginUser" placeholder="Usuario">
<label style="margin-top:12px">Contrase√±a</label>
<input id="loginPass" type="password" placeholder="Contrase√±a">
<div class="flex gap-2 mt-3">
<button id="btnDoLogin" class="btn" style="flex:1">Entrar</button>
<button id="btnCancelLogin" class="btn-ghost">Cancelar</button>
</div>
<div id="loginError" class="muted small mt-2" style="color:var(--danger);display:none"></div>
</div>
<div style="margin-top:24px;padding-top:16px;border-top:1px solid rgba(255,255,255,0.05)">
<div class="muted small">‚ö†Ô∏è Solo usuarios autorizados. Contacte al administrador para obtener acceso.</div>
</div>
</div>
</div>
<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

const SUPABASE_URL = 'https://lqwyoobsvfbetqqjjdkt.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imxxd3lvb2JzdmZiZXRxcWpqZGt0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMzOTczMTIsImV4cCI6MjA3ODk3MzMxMn0.F80qOvvwWnj_HquIM4B3LDBSDVU3_9zmKUVaCfAwXcc';

const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

// STATE flags to control loads and avoid race-conditions
const STATE={currentUser:null,loading:false,loadingAll:false,data:{usuarios:[],ciudadanos:[],multas:[],arrestos:[],vehiculos:[],denuncias:[],investigaciones:[],llamadas:[],bolo:[],alertas:[],auditoria:[]}};
const $=(s,r=document)=>r.querySelector(s);
const html=s=>(s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));

async function hashPassword(pass){
  const encoder=new TextEncoder();
  const data=encoder.encode(pass+'POLICE_SECURE_SALT_2024_X9Z');
  const hash=await crypto.subtle.digest('SHA-256',data);
  return Array.from(new Uint8Array(hash)).map(b=>b.toString(16).padStart(2,'0')).join('');
}

async function loadData(table){
  try{
    const {data,error}=await supabase.from(table).select('*').order('id',{ascending:false});
    if(error)throw error;
    return data||[];
  }catch(e){
    console.error(`Error cargando ${table}:`,e);
    return[];
  }
}

async function saveData(table,item){
  STATE.loading=true;
  try{
    const {error}=await supabase.from(table).insert([item]);
    if(error)throw error;
    showNotif('‚úì Guardado correctamente','success');
    // refresh all data (updates UI)
    await loadAllData();
    return true;
  }catch(e){
    console.error('Error:',e);
    showNotif('‚úó Error: '+(e.message||e),'error');
    return false;
  }finally{
    STATE.loading=false;
  }
}

async function deleteData(table,id){
  STATE.loading=true;
  try{
    const {error}=await supabase.from(table).delete().eq('id',id);
    if(error)throw error;
    showNotif('‚úì Eliminado','success');
    await loadAllData();
    return true;
  }catch(e){
    console.error('Error:',e);
    showNotif('‚úó Error al eliminar','error');
    return false;
  }finally{
    STATE.loading=false;
  }
}

async function registrarAuditoria(a){
  try{
    await supabase.from('auditoria').insert([{accion:a,usuario:STATE.currentUser?.nombre||'Sistema',fecha:new Date().toISOString()}]);
  }catch(e){
    console.error('Error auditor√≠a:',e);
  }
}

async function loadAllData(){
  if(STATE.loadingAll){
    // wait a bit for previous full load to finish (avoid early return)
    let waited=0;
    while(STATE.loadingAll && waited < 3000){
      await new Promise(r=>setTimeout(r,50));
      waited+=50;
    }
    if(STATE.loadingAll){
      console.warn('loadAllData: previous full load still running; continuing anyway.');
    } else {
      return;
    }
  }
  STATE.loadingAll = true;
  STATE.loading = true;
  try{
    const [usuarios,ciudadanos,multas,arrestos,vehiculos,denuncias,investigaciones,llamadas,bolo,alertas,auditoria]=await Promise.all([
      loadData('usuarios'),
      loadData('ciudadanos'),
      loadData('multas'),
      loadData('arrestos'),
      loadData('vehiculos'),
      loadData('denuncias'),
      loadData('investigaciones'),
      loadData('llamadas'),
      loadData('bolo'),
      loadData('alertas'),
      loadData('auditoria')
    ]);
    STATE.data={usuarios:usuarios||[],ciudadanos:ciudadanos||[],multas:multas||[],arrestos:arrestos||[],vehiculos:vehiculos||[],denuncias:denuncias||[],investigaciones:investigaciones||[],llamadas:llamadas||[],bolo:bolo||[],alertas:alertas||[],auditoria:auditoria||[]};
    updateCardBadges();
    updateUI();
  }catch(e){
    console.error('Error cargando datos:',e);
  }finally{
    STATE.loading=false;
    STATE.loadingAll=false;
  }
}

function showNotif(m,t='info'){...}    
function updateCardBadges(){...}    
</script>
</body>
</html>