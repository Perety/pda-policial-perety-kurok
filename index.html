<!doctype html><html lang="es"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Sistema Policial</title><style>:root{--bg-1:#06121a;--bg-2:#071729;--muted:#9fb3bd;--text:#e6f0f6;--accent:#7c3aed;--accent-2:#06b6a4;--danger:#ff6b6b;--glass:rgba(255,255,255,0.03);--card-grad:linear-gradient(180deg,rgba(255,255,255,0.014),rgba(255,255,255,0.006));--radius:12px;--shadow:0 14px 40px rgba(2,6,10,0.6);font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Arial}*{box-sizing:border-box;margin:0;padding:0}html,body{height:100%;background:radial-gradient(800px 300px at 12% 8%,rgba(124,58,237,0.06),transparent),linear-gradient(180deg,var(--bg-2) 0%,var(--bg-1) 60%);color:var(--text);-webkit-font-smoothing:antialiased}#app-container{display:flex;min-height:100vh}header{width:250px;background:var(--card-grad);border-right:1px solid var(--glass);padding:20px;display:flex;flex-direction:column;justify-content:space-between;position:sticky;top:0;height:100vh}#logo{font-size:1.8em;font-weight:700;color:var(--accent-2);text-shadow:0 0 10px rgba(6,182,164,0.3)}#nav-menu ul{list-style:none;padding:0;margin-top:40px}#nav-menu .nav-item{display:flex;align-items:center;padding:12px 15px;margin:8px 0;cursor:pointer;border-radius:var(--radius);transition:background-color .2s,color .2s}#nav-menu .nav-item:hover{background:var(--glass)}#nav-menu .nav-item.active{background:var(--accent);color:var(--text);box-shadow:0 4px 10px rgba(124,58,237,0.4)}#nav-menu .nav-item i{margin-right:10px}#user-info{padding-top:20px;border-top:1px solid var(--glass);text-align:center}#user-info p{margin-bottom:10px;color:var(--muted)}#btnLogout{background-color:var(--danger);color:var(--text);padding:8px 15px;border:none;border-radius:var(--radius);cursor:pointer;transition:background-color .2s}#btnLogout:hover{background-color:#c23636}main{flex-grow:1;padding:40px}#logged-out-view{display:none;align-items:center;justify-content:center;height:80vh}#main-content{background:var(--bg-2);padding:30px;border-radius:var(--radius);box-shadow:var(--shadow)}h2{color:var(--text);margin-bottom:20px}table.data-table{width:100%;border-collapse:collapse;margin-top:20px}table.data-table th,table.data-table td{padding:12px 15px;text-align:left;border-bottom:1px solid var(--glass)}table.data-table th{background-color:rgba(124,58,237,0.1);color:var(--text);font-weight:600}table.data-table td{color:var(--muted)}table.data-table tr:hover td{background-color:rgba(255,255,255,0.02)}table.data-table .no-data{text-align:center;color:var(--muted)}button.btn-icon{background:0 0;border:none;color:var(--accent);cursor:pointer;margin:0 5px;transition:color .2s}button.btn-icon:hover{color:var(--accent-2)}button.btn-icon.btn-delete{color:var(--danger)}button.btn-icon.btn-delete:hover{color:#c23636}.modal{display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;overflow:auto;background-color:rgba(0,0,0,0.8);backdrop-filter:blur(5px);align-items:center;justify-content:center}.modal.show{display:flex}.modal-content{background-color:var(--bg-1);padding:30px;border-radius:var(--radius);box-shadow:var(--shadow);width:90%;max-width:500px;position:relative}.modal-content h3{margin-top:0;color:var(--accent-2)}.close-modal{position:absolute;top:15px;right:25px;font-size:30px;font-weight:700;color:var(--muted);cursor:pointer}.close-modal:hover{color:var(--text)}form label{display:block;margin-top:15px;margin-bottom:5px;font-weight:600}form input,form select{width:100%;padding:10px;margin-bottom:10px;border:1px solid var(--glass);border-radius:var(--radius);background-color:var(--bg-2);color:var(--text);transition:border-color .2s}form input:focus,form select:focus{outline:none;border-color:var(--accent)}form button.btn-submit{background-color:var(--accent);color:var(--text);padding:10px 20px;border:none;border-radius:var(--radius);cursor:pointer;margin-top:20px;transition:background-color .2s}form button.btn-submit:hover{background-color:#652ecf}#login-form-card{width:100%;max-width:350px;padding:30px;background:var(--card-grad);border:1px solid var(--glass);border-radius:var(--radius);box-shadow:var(--shadow);text-align:center}#login-form-card h3{margin-bottom:20px}#loginError{color:var(--danger);margin-top:10px;display:none}.notification-container{position:fixed;bottom:20px;right:20px;z-index:2000}.notification{background-color:var(--bg-2);color:var(--text);padding:15px 20px;border-radius:var(--radius);margin-top:10px;box-shadow:0 6px 20px rgba(0,0,0,0.5);opacity:1;transition:opacity .5s,transform .5s;min-width:250px}.notification.hide{opacity:0;transform:translateX(100%)}.notification.info{border-left:5px solid var(--accent)}.notification.success{border-left:5px solid var(--accent-2)}.notification.danger{border-left:5px solid var(--danger)}.header-tools{display:flex;justify-content:space-between;align-items:center}.btn-accent{background-color:var(--accent-2);color:var(--text);padding:10px 15px;border:none;border-radius:var(--radius);cursor:pointer;transition:background-color .2s}.btn-accent:hover{background-color:#059685}.status-activo{color:var(--accent-2);font-weight:700}.status-expirado{color:var(--muted);font-weight:700}.status-revocado{color:var(--danger);font-weight:700}.search-filter-controls{display:flex;gap:10px;margin-bottom:15px;margin-top:10px}.search-filter-controls input,.search-filter-controls select{flex:1;padding:8px;border-radius:var(--radius);border:1px solid var(--glass);background-color:var(--bg-2);color:var(--text)}.pagination-controls{display:flex;justify-content:center;align-items:center;gap:15px;margin-top:20px}.btn-page{background-color:var(--glass);color:var(--text);padding:8px 15px;border:none;border-radius:var(--radius);cursor:pointer;transition:background-color .2s}.btn-page:hover:not(:disabled){background-color:rgba(255,255,255,0.1)}.btn-page:disabled{opacity:.5;cursor:not-allowed}.hidden{display:none!important}</style><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"></head><body><div id="app-container"><header><div id="menu-section"><div id="logo">Policía Admin</div><nav id="nav-menu"><ul><li class="nav-item active" id="nav-ciudadanos"><i class="fas fa-users"></i>Ciudadanos</li><li class="nav-item" id="nav-permisos"><i class="fas fa-file-contract"></i>Permisos</li><li class="nav-item" id="nav-vehiculos"><i class="fas fa-car"></i>Vehículos</li><li class="nav-item" id="nav-auditoria"><i class="fas fa-history"></i>Auditoría</li><li class="nav-item" id="nav-usuarios"><i class="fas fa-user-shield"></i>Usuarios</li></ul></nav></div><div id="user-info"><p id="user-display">Sesión no iniciada</p><button id="btnLogout">Cerrar Sesión</button></div></header><main><div id="logged-out-view"><div id="login-form-card"><h3>Acceso al Sistema</h3><form id="loginForm"><label for="loginUser">Usuario</label><input type="text" id="loginUser" required><label for="loginPass">Contraseña</label><input type="password" id="loginPass" required><button type="submit" class="btn-submit">Ingresar</button><p id="loginError"></p></form></div></div><div id="logged-in-view" style="display:none"><div id="main-content"></div></div></main><div class="notification-container" id="notif-container"></div><div id="loginModal" class="modal show"><div class="modal-content"><h3 id="loginTitle">Iniciar Sesión</h3><span class="close-modal">&times;</span><form id="loginModalForm"><label for="loginUser">Usuario</label><input type="text" id="loginUserModal" required><label for="loginPass">Contraseña</label><input type="password" id="loginPassModal" required><button type="submit" class="btn-submit">Ingresar</button><p id="loginErrorModal"></p></form></div></div><div id="addCiuModal" class="modal"><div class="modal-content"><h3 id="addCiuTitle">Nuevo Ciudadano</h3><span class="close-modal">&times;</span><form id="addCiuForm" data-mode="add"><label for="ciuDni">DNI</label><input type="text" id="ciuDni" required><label for="ciuNombre">Nombre Completo</label><input type="text" id="ciuNombre" required><label for="ciuTelefono">Teléfono (opcional)</label><input type="text" id="ciuTelefono"><label for="ciuDireccion">Dirección (opcional)</label><input type="text" id="ciuDireccion"><label for="ciuRol">Rol</label><select id="ciuRol" required><option value="ciud">Ciudadano</option><option value="emp">Empresa</option></select><button type="submit" class="btn-submit">Guardar Ciudadano</button></form></div></div><div id="addPerModal" class="modal"><div class="modal-content"><h3 id="addPerTitle">Nuevo Permiso</h3><span class="close-modal">&times;</span><form id="addPerForm" data-mode="add"><label for="perDni">DNI de Ciudadano</label><input type="text" id="perDni" required><label for="perTipo">Tipo de Permiso</label><input type="text" id="perTipo" required><label for="perDesc">Descripción (opcional)</label><input type="text" id="perDesc"><label for="perFechaExp">Fecha de Expiración (opcional)</label><input type="date" id="perFechaExp"><label for="perEstado">Estado</label><select id="perEstado" required><option value="activo">Activo</option><option value="revocado">Revocado</option></select><button type="submit" class="btn-submit">Guardar Permiso</button></form></div></div><div id="addVehModal" class="modal"><div class="modal-content"><h3 id="addVehTitle">Nuevo Vehículo</h3><span class="close-modal">&times;</span><form id="addVehForm" data-mode="add"><label for="vehPlaca">Placa</label><input type="text" id="vehPlaca" required><label for="vehModelo">Modelo</label><select id="vehModelo" required><option value="coche">Coche</option><option value="moto">Moto</option><option value="camion">Camión</option><option value="otro">Otro</option></select><label for="vehColor">Color</label><input type="text" id="vehColor"><label for="vehDniPropietario">DNI del Propietario</label><input type="text" id="vehDniPropietario" required><button type="submit" class="btn-submit">Guardar Vehículo</button></form></div></div><div id="addUsrModal" class="modal"><div class="modal-content"><h3 id="addUsrTitle">Nuevo Usuario</h3><span class="close-modal">&times;</span><form id="addUsrForm" data-mode="add"><label for="usrUsername">Nombre de Usuario</label><input type="text" id="usrUsername" required><label for="usrNombre">Nombre Completo</label><input type="text" id="usrNombre" required><label for="usrRol">Rol</label><select id="usrRol" required><option value="pol">Policía</option><option value="admin">Administrador</option><option value="ciud">Ciudadano</option></select><label for="usrDni">DNI Asociado (opcional)</label><input type="text" id="usrDni"><div id="addUsrPassGroup"><label for="usrPassword">Contraseña</label><input type="password" id="usrPassword" required></div><button type="submit" class="btn-submit">Guardar Usuario</button></form></div></div></div><script type="module">import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.44.2/+esm';const a = 'https://lqwyoobsvfbetqqjjdkt.supabase.co';const t = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imxxd3lvb2JzdmZiZXRxcWpqZGt0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMzOTczMTIsImV4cCI6MjA3ODk3MzMxMn0.F80qOvvwWnj_HquIM4B3LDBSDVU3_9zmKUVaCfAwXcc';const o = createClient(a, t);const e = { data: {}, currentUser: null, filters: {}, currentPage: 1, itemsPerPage: 10 };const c = r => document.querySelector(r);const n = r => document.querySelectorAll(r);async function s(r) { const a = 'POLICE_SECURE_SALT_2024_X9Z';const t = r + a;const o = new TextEncoder();const c = o.encode(t);const n = await crypto.subtle.digest('SHA-256', c);const s = Array.from(new Uint8Array(n));const l = s.map(r => r.toString(16).padStart(2, '0')).join('');return l;}async function l(r) { if (!e.currentUser) return;const { error: a } = await o.from('auditoria').insert([{ usuario_id: e.currentUser.id, accion: r }]);if (a) { console.error('Error al registrar auditoría:', a.message);}}function u(r, a = 'info', t = 4000) { const o = c('#notif-container');if (!o) return;const e = document.createElement('div');e.className = `notification ${a}`;e.textContent = r;o.appendChild(e);setTimeout(() => { e.classList.add('hide');e.addEventListener('transitionend', () => e.remove());}, t);}function d() { const r = c('#logged-out-view');const a = c('#logged-in-view');const t = c('#user-display');if (e.currentUser) { if (r) r.style.display = 'none';if (a) a.style.display = 'flex';if (t) t.textContent = `Bienvenido, ${e.currentUser.nombre} (${e.currentUser.rol.toUpperCase()})`;p();} else { if (r) r.style.display = 'flex';if (a) a.style.display = 'none';}}async function p() { u('Cargando datos...', 'info');const [r, a, t, n, s] = await Promise.all([o.from('ciudadanos').select('*').order('id', { ascending: true }), o.from('permisos').select('*').order('id', { ascending: true }), o.from('vehiculos').select('*').order('id', { ascending: true }), o.from('auditoria').select('*, usuarios(username)').order('fecha', { ascending: false }), o.from('usuarios').select('*').order('id', { ascending: true })]);e.data.ciudadanos = r.data || [];e.data.permisos = a.data || [];e.data.vehiculos = t.data || [];e.data.auditoria = n.data || [];e.data.usuarios = s.data || [];if (r.error || a.error || t.error || n.error || s.error) { console.error('Error al cargar datos:', r.error, a.error, t.error, n.error, s.error);u('Error al cargar datos. Ver consola.', 'danger');return;}u('Datos cargados correctamente.', 'success');v();}function f() { const r = c('#main-content');if (!r) return;r.innerHTML = `\n    <div class="header-tools">\n      <h2>Ciudadanos Registrados</h2>\n      <button class="btn btn-accent" id="btn-add-ciudadano">\n        <i class="fas fa-plus"></i> Nuevo Ciudadano\n      </button>\n    </div>\n    <div class="search-filter-controls">\n      <input type="text" id="filter-ciu-dni" placeholder="Filtrar por DNI...">\n      <input type="text" id="filter-ciu-nombre" placeholder="Filtrar por Nombre...">\n      <select id="filter-ciu-rol">\n        <option value="">Todos los Roles</option>\n        <option value="ciud">Ciudadano</option>\n        <option value="emp">Empresa</option>\n      </select>\n    </div>\n    <table class="data-table">\n      <thead>\n        <tr>\n          <th>ID</th>\n          <th>DNI</th>\n          <th>Nombre</th>\n          <th>Teléfono</th>\n          <th>Rol</th>\n          <th>Acciones</th>\n        </tr>\n      </thead>\n      <tbody id="ciudadanos-table-body">\n      </tbody>\n    </table>\n    <div class="pagination-controls" id="pagination-ciu-controls"></div>\n  `;c('#filter-ciu-dni')?.addEventListener('input', r => h('ciudadanos', 'dni', r.target.value));c('#filter-ciu-nombre')?.addEventListener('input', r => h('ciudadanos', 'nombre', r.target.value));c('#filter-ciu-rol')?.addEventListener('change', r => h('ciudadanos', 'rol', r.target.value));c('#btn-add-ciudadano')?.addEventListener('click', O);i('ciudadanos');}function m() { const r = c('#main-content');if (!r) return;r.innerHTML = `\n    <div class="header-tools">\n      <h2>Permisos Otorgados</h2>\n      <button class="btn btn-accent" id="btn-add-permiso">\n        <i class="fas fa-plus"></i> Nuevo Permiso\n      </button>\n    </div>\n    <div class="search-filter-controls">\n      <input type="text" id="filter-per-dni" placeholder="Filtrar por DNI de Ciudadano...">\n      <input type="text" id="filter-per-tipo" placeholder="Filtrar por Tipo de Permiso...">\n      <select id="filter-per-estado">\n        <option value="">Todos los Estados</option>\n        <option value="activo">Activo</option>\n        <option value="expirado">Expirado</option>\n        <option value="revocado">Revocado</option>\n      </select>\n    </div>\n    <table class="data-table">\n      <thead>\n        <tr>\n          <th>ID</th>\n          <th>DNI Ciudadano</th>\n          <th>Tipo</th>\n          <th>Fecha Exp.</th>\n          <th>Estado</th>\n          <th>Acciones</th>\n        </tr>\n      </thead>\n      <tbody id="permisos-table-body">\n      </tbody>\n    </table>\n    <div class="pagination-controls" id="pagination-per-controls"></div>\n  `;c('#filter-per-dni')?.addEventListener('input', r => h('permisos', 'dni', r.target.value));c('#filter-per-tipo')?.addEventListener('input', r => h('permisos', 'tipo', r.target.value));c('#filter-per-estado')?.addEventListener('change', r => h('permisos', 'estado', r.target.value));c('#btn-add-permiso')?.addEventListener('click', q);i('permisos');}function _() { const r = c('#main-content');if (!r) return;r.innerHTML = `\n    <div class="header-tools">\n      <h2>Vehículos Registrados</h2>\n      <button class="btn btn-accent" id="btn-add-vehiculo">\n        <i class="fas fa-plus"></i> Nuevo Vehículo\n      </button>\n    </div>\n    <div class="search-filter-controls">\n      <input type="text" id="filter-veh-dni" placeholder="Filtrar por DNI de Propietario...">\n      <input type="text" id="filter-veh-placa" placeholder="Filtrar por Placa...">\n      <select id="filter-veh-modelo">\n        <option value="">Todos los Modelos</option>\n        <option value="coche">Coche</option>\n        <option value="moto">Moto</option>\n        <option value="camion">Camión</option>\n      </select>\n    </div>\n    <table class="data-table">\n      <thead>\n        <tr>\n          <th>ID</th>\n          <th>Placa</th>\n          <th>Modelo</th>\n          <th>Color</th>\n          <th>DNI Propietario</th>\n          <th>Acciones</th>\n        </tr>\n      </thead>\n      <tbody id="vehiculos-table-body">\n      </tbody>\n    </table>\n    <div class="pagination-controls" id="pagination-veh-controls"></div>\n  `;c('#filter-veh-dni')?.addEventListener('input', r => h('vehiculos', 'dni_propietario', r.target.value));c('#filter-veh-placa')?.addEventListener('input', r => h('vehiculos', 'placa', r.target.value));c('#filter-veh-modelo')?.addEventListener('change', r => h('vehiculos', 'modelo', r.target.value));c('#btn-add-vehiculo')?.addEventListener('click', N);i('vehiculos');}function g() { const r = c('#main-content');if (!r) return;if (e.currentUser && e.currentUser.rol !== 'admin') { r.innerHTML = '<p class="error-message">Acceso denegado: Solo los administradores pueden ver esta sección.</p>';return;}r.innerHTML = `\n    <div class="header-tools">\n      <h2>Registro de Auditoría</h2>\n    </div>\n    <div class="search-filter-controls">\n      <input type="text" id="filter-aud-user" placeholder="Filtrar por Usuario (Username)...">\n      <input type="text" id="filter-aud-accion" placeholder="Filtrar por Acción...">\n    </div>\n    <table class="data-table">\n      <thead>\n        <tr>\n          <th>ID</th>\n          <th>Usuario</th>\n          <th>Acción</th>\n          <th>Fecha</th>\n        </tr>\n      </thead>\n      <tbody id="auditoria-table-body">\n      </tbody>\n    </table>\n    <div class="pagination-controls" id="pagination-aud-controls"></div>\n  `;c('#filter-aud-user')?.addEventListener('input', r => h('auditoria', 'usuario', r.target.value));c('#filter-aud-accion')?.addEventListener('input', r => h('auditoria', 'accion', r.target.value));i('auditoria');}function y() { const r = c('#main-content');if (!r) return;if (e.currentUser && e.currentUser.rol !== 'admin') { r.innerHTML = '<p class="error-message">Acceso denegado: Solo los administradores pueden ver esta sección.</p>';return;}r.innerHTML = `\n    <div class="header-tools">\n      <h2>Gestión de Usuarios</h2>\n      <button class="btn btn-accent" id="btn-add-usuario">\n        <i class="fas fa-plus"></i> Nuevo Usuario\n      </button>\n    </div>\n    <div class="search-filter-controls">\n      <input type="text" id="filter-us-username" placeholder="Filtrar por Nombre de Usuario...">\n      <select id="filter-us-rol">\n        <option value="">Todos los Roles</option>\n        <option value="admin">Administrador</option>\n        <option value="ciud">Ciudadano</option>\n        <option value="pol">Policía</option>\n      </select>\n    </div>\n    <table class="data-table">\n      <thead>\n        <tr>\n          <th>ID</th>\n          <th>Username</th>\n          <th>Nombre</th>\n          <th>Rol</th>\n          <th>Acciones</th>\n        </tr>\n      </thead>\n      <tbody id="usuarios-table-body">\n      </tbody>\n    </table>\n    <div class="pagination-controls" id="pagination-us-controls"></div>\n  `;c('#filter-us-username')?.addEventListener('input', r => h('usuarios', 'username', r.target.value));c('#filter-us-rol')?.addEventListener('change', r => h('usuarios', 'rol', r.target.value));c('#btn-add-usuario')?.addEventListener('click', P);i('usuarios');}function v() { const r = e.currentView || 'ciudadanos';switch (r) { case 'ciudadanos':f();break;case 'permisos':m();break;case 'vehiculos':_();break;case 'auditoria':g();break;case 'usuarios':y();break;default:f();}}function changeView(r) { e.currentView = r;e.currentPage = 1;e.filters = {};const a = n('.nav-item');a.forEach(r => r.classList.remove('active'));c(`#nav-${r}`)?.classList.add('active');v();}function h(r, a, t) { e.filters[r] = e.filters[r] || {};if (t) { e.filters[r][a] = t.toLowerCase().trim();} else { delete e.filters[r][a];}e.currentPage = 1;i(r);}function i(r) { const a = c(`#${r}-table-body`);if (!a) return;let t = e.data[r] || [];const o = e.filters[r];if (o) { t = t.filter(a => { let t = true;for (const e in o) { const c = o[e];let n = a[e];if (r === 'auditoria' && e === 'usuario') { n = a.usuarios?.username;}if (n !== undefined && n !== null) { const s = String(n).toLowerCase();if (!s.includes(c)) { t = false;break;}} else if (c) { t = false;break;}}return t;});}const n = t.length;const s = Math.ceil(n / e.itemsPerPage);e.currentPage = Math.min(e.currentPage, Math.max(1, s));const l = (e.currentPage - 1) * e.itemsPerPage;const u = l + e.itemsPerPage;const d = t.slice(l, u);a.innerHTML = '';if (d.length === 0) { a.innerHTML = '<tr><td colspan="6" class="no-data">No se encontraron registros.</td></tr>';} else { d.forEach(t => { const o = document.createElement('tr');let c = '';switch (r) { case 'ciudadanos':c = `\n            <td>${t.id}</td>\n            <td>${t.dni}</td>\n            <td>${t.nombre}</td>\n            <td>${t.telefono || 'N/A'}</td>\n            <td>${t.rol || 'ciud'}</td>\n            <td>\n              <button class="btn-icon btn-edit" data-id="${t.id}" data-table="${r}"><i class="fas fa-edit"></i></button>\n              <button class="btn-icon btn-delete" data-id="${t.id}" data-table="${r}"><i class="fas fa-trash-alt"></i></button>\n            </td>\n          `;break;case 'permisos':let a = t.fecha_expiracion ? (new Date(t.fecha_expiracion) > new Date() ? 'activo' : 'expirado') : 'activo';if (t.estado === 'revocado') a = 'revocado';c = `\n            <td>${t.id}</td>\n            <td>${t.dni_ciudadano}</td>\n            <td>${t.tipo}</td>\n            <td>${t.fecha_expiracion ? new Date(t.fecha_expiracion).toLocaleDateString() : 'Permanente'}</td>\n            <td class="status-${a}">${a.toUpperCase()}</td>\n            <td>\n              <button class="btn-icon btn-edit" data-id="${t.id}" data-table="${r}"><i class="fas fa-edit"></i></button>\n              <button class="btn-icon btn-delete" data-id="${t.id}" data-table="${r}"><i class="fas fa-trash-alt"></i></button>\n            </td>\n          `;break;case 'vehiculos':c = `\n            <td>${t.id}</td>\n            <td>${t.placa}</td>\n            <td>${t.modelo}</td>\n            <td>${t.color}</td>\n            <td>${t.dni_propietario}</td>\n            <td>\n              <button class="btn-icon btn-edit" data-id="${t.id}" data-table="${r}"><i class="fas fa-edit"></i></button>\n              <button class="btn-icon btn-delete" data-id="${t.id}" data-table="${r}"><i class="fas fa-trash-alt"></i></button>\n            </td>\n          `;break;case 'auditoria':c = `\n            <td>${t.id}</td>\n            <td>${t.usuarios.username}</td>\n            <td>${t.accion}</td>\n            <td>${new Date(t.fecha).toLocaleString()}</td>\n            <td></td>\n          `;break;case 'usuarios':c = `\n            <td>${t.id}</td>\n            <td>${t.username}</td>\n            <td>${t.nombre}</td>\n            <td>${t.rol.toUpperCase()}</td>\n            <td>\n              <button class="btn-icon btn-edit" data-id="${t.id}" data-table="${r}"><i class="fas fa-edit"></i></button>\n              <button class="btn-icon btn-delete" data-id="${t.id}" data-table="${r}"><i class="fas fa-trash-alt"></i></button>\n            </td>\n          `;break;}o.innerHTML = c;a.appendChild(o);});}k(r, s);a.querySelectorAll('.btn-edit').forEach(r => r.addEventListener('click', $));a.querySelectorAll('.btn-delete').forEach(r => r.addEventListener('click', z));}function k(r, a) { const t = c(`#pagination-${r.substring(0, 3)}-controls`);if (!t) return;t.innerHTML = '';if (a <= 1) return;const o = document.createElement('button');o.textContent = 'Anterior';o.className = 'btn-page';o.disabled = e.currentPage === 1;o.addEventListener('click', () => { e.currentPage--;i(r);});t.appendChild(o);const n = document.createElement('span');n.textContent = `Página ${e.currentPage} de ${a}`;t.appendChild(n);const s = document.createElement('button');s.textContent = 'Siguiente';s.className = 'btn-page';s.disabled = e.currentPage === a;s.addEventListener('click', () => { e.currentPage++;i(r);});t.appendChild(s);}function M(r) { const a = c(r);if (a) a.classList.add('show');}function w(r) { const a = c(r);if (a) a.classList.remove('show');}function O() { const r = c('#addCiuTitle');const a = c('#addCiuForm');if (r) r.textContent = 'Nuevo Ciudadano';if (a) a.dataset.mode = 'add';M('#addCiuModal');}function q() { const r = c('#addPerTitle');const a = c('#addPerForm');if (r) r.textContent = 'Nuevo Permiso';if (a) a.dataset.mode = 'add';M('#addPerModal');}function N() { const r = c('#addVehTitle');const a = c('#addVehForm');if (r) r.textContent = 'Nuevo Vehículo';if (a) a.dataset.mode = 'add';M('#addVehModal');}function P() { const r = c('#addUsrTitle');const a = c('#addUsrForm');if (r) r.textContent = 'Nuevo Usuario';if (a) a.dataset.mode = 'add';c('#addUsrPassGroup')?.classList.remove('hidden');M('#addUsrModal');}function $(r) { const a = r.currentTarget.dataset.id;const t = r.currentTarget.dataset.table;const o = e.data[t].find(r => String(r.id) === a);if (!o) return u('Error: No se encontró el registro.', 'danger');switch (t) { case 'ciudadanos':C(o);break;case 'permisos':E(o);break;case 'vehiculos':A(o);break;case 'usuarios':T(o);break;default:u('Error: Tabla no soportada para edición.', 'danger');}}function C(r) { const a = c('#addCiuTitle');const t = c('#addCiuForm');if (a) a.textContent = 'Editar Ciudadano (ID: ' + r.id + ')';if (t) { t.dataset.mode = 'edit';t.dataset.id = r.id;c('#ciuDni').value = r.dni || '';c('#ciuNombre').value = r.nombre || '';c('#ciuTelefono').value = r.telefono || '';c('#ciuDireccion').value = r.direccion || '';c('#ciuRol').value = r.rol || 'ciud';}M('#addCiuModal');}function E(r) { const a = c('#addPerTitle');const t = c('#addPerForm');if (a) a.textContent = 'Editar Permiso (ID: ' + r.id + ')';if (t) { t.dataset.mode = 'edit';t.dataset.id = r.id;c('#perDni').value = r.dni_ciudadano || '';c('#perTipo').value = r.tipo || '';c('#perDesc').value = r.descripcion || '';c('#perFechaExp').value = r.fecha_expiracion ? r.fecha_expiracion.substring(0, 10) : '';c('#perEstado').value = r.estado || 'activo';}M('#addPerModal');}function A(r) { const a = c('#addVehTitle');const t = c('#addVehForm');if (a) a.textContent = 'Editar Vehículo (ID: ' + r.id + ')';if (t) { t.dataset.mode = 'edit';t.dataset.id = r.id;c('#vehPlaca').value = r.placa || '';c('#vehModelo').value = r.modelo || 'coche';c('#vehColor').value = r.color || '';c('#vehDniPropietario').value = r.dni_propietario || '';}M('#addVehModal');}function T(r) { const a = c('#addUsrTitle');const t = c('#addUsrForm');if (a) a.textContent = 'Editar Usuario (ID: ' + r.id + ')';if (t) { t.dataset.mode = 'edit';t.dataset.id = r.id;c('#usrUsername').value = r.username || '';c('#usrNombre').value = r.nombre || '';c('#usrRol').value = r.rol || 'pol';c('#usrDni').value = r.dni || '';}c('#addUsrPassGroup')?.classList.add('hidden');M('#addUsrModal');}async function L(r) { r.preventDefault();const a = r.target;const t = a.dataset.mode;const o = a.dataset.id;const e = c('#ciuDni')?.value.trim();const n = c('#ciuNombre')?.value.trim();const s = c('#ciuTelefono')?.value.trim();const u = c('#ciuDireccion')?.value.trim();const d = c('#ciuRol')?.value;if (!e || !n || !d) { u('Complete DNI, Nombre y Rol.', 'danger');return;}const p = { dni: e, nombre: n, telefono: s, direccion: u, rol: d };let f;let m;if (t === 'add') { f = await o.from('ciudadanos').insert([p]).select();m = `Creación de Ciudadano DNI: ${e}`;} else if (t === 'edit') { f = await o.from('ciudadanos').update(p).eq('id', o).select();m = `Edición de Ciudadano ID: ${o} (DNI: ${e})`;} else { return;}if (f.error) { console.error('Error al guardar ciudadano:', f.error.message);u(`Error al guardar ciudadano: ${f.error.message}`, 'danger');} else { u('Ciudadano guardado exitosamente.', 'success');w('#addCiuModal');a.reset();await l(m);await p();}}async function B(r) { r.preventDefault();const a = r.target;const t = a.dataset.mode;const o = a.dataset.id;const e = c('#perDni')?.value.trim();const n = c('#perTipo')?.value.trim();const s = c('#perDesc')?.value.trim();const u = c('#perFechaExp')?.value || null;const d = c('#perEstado')?.value;if (!e || !n) { u('Complete DNI de Ciudadano y Tipo de Permiso.', 'danger');return;}const p = { dni_ciudadano: e, tipo: n, descripcion: s, fecha_expiracion: u, estado: d };let f;let m;if (t === 'add') { f = await o.from('permisos').insert([p]).select();m = `Creación de Permiso (${n}) para DNI: ${e}`;} else if (t === 'edit') { f = await o.from('permisos').update(p).eq('id', o).select();m = `Edición de Permiso ID: ${o} (${n}) para DNI: ${e}`;} else { return;}if (f.error) { console.error('Error al guardar permiso:', f.error.message);u(`Error al guardar permiso: ${f.error.message}`, 'danger');} else { u('Permiso guardado exitosamente.', 'success');w('#addPerModal');a.reset();await l(m);await p();}}async function S(r) { r.preventDefault();const a = r.target;const t = a.dataset.mode;const o = a.dataset.id;const e = c('#vehPlaca')?.value.trim();const n = c('#vehModelo')?.value;const s = c('#vehColor')?.value.trim();const u = c('#vehDniPropietario')?.value.trim();if (!e || !n || !u) { u('Complete Placa, Modelo y DNI del Propietario.', 'danger');return;}const d = { placa: e, modelo: n, color: s, dni_propietario: u };let p;let f;if (t === 'add') { p = await o.from('vehiculos').insert([d]).select();f = `Creación de Vehículo Placa: ${e} (DNI: ${u})`;} else if (t === 'edit') { p = await o.from('vehiculos').update(d).eq('id', o).select();f = `Edición de Vehículo ID: ${o} (Placa: ${e})`;} else { return;}if (p.error) { console.error('Error al guardar vehículo:', p.error.message);u(`Error al guardar vehículo: ${p.error.message}`, 'danger');} else { u('Vehículo guardado exitosamente.', 'success');w('#addVehModal');a.reset();await l(f);await p();}}async function D(r) { r.preventDefault();const a = r.target;const t = a.dataset.mode;const o = a.dataset.id;const n = c('#usrUsername')?.value.trim();const d = c('#usrNombre')?.value.trim();const p = c('#usrRol')?.value;const f = c('#usrDni')?.value.trim();const m = c('#usrPassword')?.value.trim();if (!n || !d || !p) { u('Complete Usuario, Nombre y Rol.', 'danger');return;}const _ = { username: n, nombre: d, rol: p, dni: f || null };let g;if (t === 'add') { if (!m) { u('La contraseña es obligatoria para un nuevo usuario.', 'danger');return;}const r = await s(m);_.password = r;let a = await o.from('usuarios').insert([_]).select();g = `Creación de Usuario: ${n}`;if (a.error) { console.error('Error al guardar usuario:', a.error.message);u(`Error al guardar usuario: ${a.error.message}`, 'danger');return;}} else if (t === 'edit') { let r = await o.from('usuarios').update(_).eq('id', o).select();g = `Edición de Usuario ID: ${o} (Username: ${n})`;if (r.error) { console.error('Error al guardar usuario:', r.error.message);u(`Error al guardar usuario: ${r.error.message}`, 'danger');return;}} else { return;}u('Usuario guardado exitosamente.', 'success');w('#addUsrModal');a.reset();await l(g);await p();}async function z(r) { const a = r.currentTarget.dataset.id;const t = r.currentTarget.dataset.table;if (!confirm(`¿Está seguro de que desea eliminar el registro ID ${a} de la tabla ${t}?`)) { return;}u(`Eliminando registro ID ${a} de ${t}...`, 'info`);const { error: e } = await o.from(t).delete().eq('id', a);if (e) { console.error(`Error al eliminar en ${t}:`, e.message);u(`Error al eliminar el registro: ${e.message}`, 'danger');} else { u(`Registro ID ${a} eliminado exitosamente de ${t}.`, 'success');await l(`Eliminación de registro ID: ${a} en tabla: ${t}`);await p();}}async function R() { await l(`Logout: ${e.currentUser.username}`);e.currentUser = null;e.currentView = 'ciudadanos';d();u('Sesión cerrada.', 'info');}async function x(r) { r.preventDefault();const t = c('#loginUser')?.value.trim(),o = c('#loginPass')?.value.trim(),n = c('#loginError');if (!t || !o) { if (n) { n.textContent = 'Complete todos los campos';n.style.display = 'block';}return;}const l = await s(o);const u = e.data.usuarios.find(r => String(r.username) === t && String(r.password) === l);if (!u) { if (n) { n.textContent = 'Usuario o contraseña incorrectos';n.style.display = 'block';}return;}if (!u.id) { if (n) { n.textContent = 'Error: El usuario no tiene ID registrado. Contacte a soporte.';n.style.display = 'block';}return;}e.currentUser = u;d();const p = c('#loginModal');if (p) p.classList.remove('show');const f = c('#loginUser'),m = c('#loginPass');if (f) f.value = '';if (m) m.value = '';if (n) n.style.display = 'none';u(`✓ Bienvenido ${u.nombre}`, 'success');await l(`Login: ${u.username}`);}(async() => { try { u('Conectando con Supabase...', 'info');const { data: r, error: a } = await o.from('usuarios').select('*');if (a) throw a;e.data.usuarios = r || [];u('Datos iniciales cargados.', 'success');} catch (r) { console.error('Error durante la inicialización:', r);u(`Error de inicialización: ${r.message}`, 'danger');}c('#loginForm')?.addEventListener('submit', x);c('#btnLogout')?.addEventListener('click', R);c('#nav-ciudadanos')?.addEventListener('click', () => changeView('ciudadanos'));c('#nav-permisos')?.addEventListener('click', () => changeView('permisos'));c('#nav-vehiculos')?.addEventListener('click', () => changeView('vehiculos'));c('#nav-auditoria')?.addEventListener('click', () => changeView('auditoria'));c('#nav-usuarios')?.addEventListener('click', () => changeView('usuarios'));n('.close-modal').forEach(r => r.addEventListener('click', r => w(`#${r.target.closest('.modal')?.id}`)));c('#addCiuForm')?.addEventListener('submit', L);c('#addPerForm')?.addEventListener('submit', B);c('#addVehForm')?.addEventListener('submit', S);c('#addUsrForm')?.addEventListener('submit', D);d();M('#loginModal');})();</script></body></html>
