<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Sistema Policial Global</title>
<style>
:root{--bg-1:#06121a;--bg-2:#071729;--muted:#9fb3bd;--text:#e6f0f6;--accent:#7c3aed;--accent-2:#06b6a4;--danger:#ff6b6b;--glass:rgba(255,255,255,0.03);--card-grad:linear-gradient(180deg,rgba(255,255,255,0.014),rgba(255,255,255,0.006));--radius:12px;--shadow:0 14px 40px rgba(2,6,10,0.6);font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Arial}
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%;background:radial-gradient(800px 300px at 12% 8%,rgba(124,58,237,0.06),transparent),linear-gradient(180deg,var(--bg-2) 0%,var(--bg-1) 60%);color:var(--text);-webkit-font-smoothing:antialiased}
.bg{position:fixed;inset:0;z-index:0;pointer-events:none;overflow:hidden}
.nebula{position:absolute;width:60vmax;height:60vmax;left:-10vmin;top:-8vmin;background:radial-gradient(circle at 30% 30%,rgba(124,58,237,0.24),transparent 30%),radial-gradient(circle at 70% 70%,rgba(6,182,164,0.12),transparent 25%);filter:blur(56px) saturate(120%);animation:float 12s ease-in-out infinite}
.nebula.r{right:-10vmin;left:auto;top:6vmin;background:radial-gradient(circle at 70% 20%,rgba(255,80,120,0.20),transparent 30%),radial-gradient(circle at 30% 80%,rgba(110,231,183,0.12),transparent 25%);animation-duration:10s;animation-direction:reverse}
@keyframes float{0%,100%{transform:translateY(-8px)}50%{transform:translateY(8px)}}
.wrap{max-width:1200px;margin:22px auto;padding:20px;position:relative;z-index:2}
header{display:flex;align-items:center;justify-content:space-between;gap:18px;margin-bottom:20px;flex-wrap:wrap}
.brand{display:flex;gap:12px;align-items:center}
.logo{width:60px;height:60px;border-radius:12px;background:linear-gradient(135deg,var(--accent-2),var(--accent));display:flex;align-items:center;justify-content:center;font-weight:900;color:#031018;font-size:28px}
h1{font-size:18px}
.subtitle{color:var(--muted);font-size:13px}
.top-right{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.pill{background:var(--glass);padding:8px 12px;border-radius:999px;font-weight:700;color:var(--muted);font-size:13px}
.btn{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#031018;padding:8px 16px;border-radius:10px;border:none;cursor:pointer;font-weight:800;transition:all .2s}
.btn:hover{transform:translateY(-2px);opacity:0.9}
.btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.08);color:var(--muted);padding:7px 12px;border-radius:10px;cursor:pointer;transition:all .2s;font-weight:600}
.btn-ghost:hover{border-color:var(--accent);color:var(--text)}
.btn-danger{background:linear-gradient(90deg,#ef4444,#dc2626);color:white}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:16px;margin-top:20px}
.card{background:var(--card-grad);border-radius:var(--radius);padding:20px;border:1px solid rgba(255,255,255,0.04);box-shadow:var(--shadow);min-height:140px;transition:all .18s;cursor:pointer;position:relative}
.card:hover{transform:translateY(-8px);box-shadow:0 30px 60px rgba(0,0,0,0.7);border-color:rgba(140,80,240,0.12)}
.card .icon{font-size:42px;margin-bottom:12px}
.card .title{font-weight:900;font-size:18px;margin-bottom:4px}
.card .desc{color:var(--muted);font-size:13px}
.card .badge{position:absolute;top:12px;right:12px;background:rgba(124,58,237,0.2);padding:4px 10px;border-radius:12px;font-size:11px;font-weight:800;color:var(--accent)}
.expanded{margin-top:20px;border-radius:12px;padding:24px;background:linear-gradient(180deg,rgba(255,255,255,0.012),rgba(255,255,255,0.006));border:1px solid rgba(255,255,255,0.04);box-shadow:0 16px 44px rgba(0,0,0,0.55);animation:slideUp .3s ease}
@keyframes slideUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:none}}
.list{display:flex;flex-direction:column;gap:10px;max-height:500px;overflow-y:auto;padding-right:4px}
.list::-webkit-scrollbar{width:6px}
.list::-webkit-scrollbar-track{background:rgba(0,0,0,0.2);border-radius:10px}
.list::-webkit-scrollbar-thumb{background:rgba(124,58,237,0.3);border-radius:10px}
.item{padding:14px;border-radius:10px;background:rgba(255,255,255,0.012);border:1px solid rgba(255,255,255,0.03);transition:all .2s;display:flex;justify-content:space-between;align-items:center;gap:12px}
.item:hover{background:rgba(255,255,255,0.02);border-color:rgba(140,80,240,0.08)}
input,textarea,select{background:rgba(0,0,0,0.25);border:1px solid rgba(255,255,255,0.06);padding:10px 12px;border-radius:8px;color:var(--text);font:inherit;transition:all .2s;width:100%}
input:focus,textarea:focus,select:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px rgba(124,58,237,0.1)}
textarea{min-height:100px;resize:vertical}
label{display:block;margin-bottom:6px;font-size:13px;font-weight:600;color:var(--muted)}
.overlay{position:fixed;inset:0;background:rgba(2,6,10,0.92);backdrop-filter:blur(12px);display:none;align-items:center;justify-content:center;z-index:9999}
.overlay.show{display:flex}
.modal{width:480px;max-width:95%;background:linear-gradient(180deg,#0a1628,#061421);padding:32px;border-radius:14px;border:1px solid rgba(255,255,255,0.08);box-shadow:0 25px 70px rgba(0,0,0,0.9)}
.modal h3{font-size:24px;margin-bottom:8px}
.muted{color:var(--muted)}
.small{font-size:13px}
.mt-2{margin-top:8px}
.mt-3{margin-top:12px}
.flex{display:flex}
.flex-col{flex-direction:column}
.gap-2{gap:8px}
.grid-2{display:grid;grid-template-columns:2fr 1fr;gap:20px}
.sync-indicator{position:fixed;bottom:20px;right:20px;background:var(--glass);backdrop-filter:blur(10px);padding:10px 16px;border-radius:999px;border:1px solid rgba(255,255,255,0.1);display:flex;align-items:center;gap:8px;z-index:1000}
.sync-dot{width:8px;height:8px;background:#4ade80;border-radius:50%;animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.5}}
footer{margin-top:40px;text-align:center;color:var(--muted);font-size:12px;padding-bottom:20px}
</style>
</head>
<body>
<div class="bg"><div class="nebula"></div><div class="nebula r"></div></div>
<div class="wrap">
<header>
<div class="brand">
<div class="logo">üõ°Ô∏è</div>
<div><h1>Sistema Policial Global</h1><div class="subtitle">üåç Sincronizaci√≥n mundial con Supabase</div></div>
</div>
<div class="top-right">
<div id="userDisplay" class="pill">Conectando...</div>
<button id="btnLogin" class="btn-ghost">Entrar</button>
<button id="btnLogout" class="btn-ghost" style="display:none">Salir</button>
<div id="adminIndicator" style="display:none" class="pill">üëë Admin</div>
</div>
</header>
<div class="grid" id="cardsGrid"></div>
<div id="expandedArea"></div>
<footer>Sistema Policial Global ‚Ä¢ Sincronizado con Supabase ‚Ä¢ 100% Gratis</footer>
</div>
<div class="sync-indicator">
<div class="sync-dot"></div>
<span class="small">Sincronizado</span>
</div>
<div id="loginModal" class="overlay">
<div class="modal">
<h3>Iniciar Sesi√≥n</h3>
<div class="muted small">Acceso seguro al sistema</div>
<div style="margin-top:24px">
<label>Usuario</label>
<input id="loginUser" placeholder="admin">
<label style="margin-top:12px">Contrase√±a</label>
<input id="loginPass" type="password" placeholder="admin123">
<div class="flex gap-2 mt-3">
<button id="btnDoLogin" class="btn" style="flex:1">Entrar</button>
<button id="btnCancelLogin" class="btn-ghost">Cancelar</button>
</div>
<div id="loginError" class="muted small mt-2" style="color:var(--danger);display:none"></div>
</div>
<div style="margin-top:24px;padding-top:16px;border-top:1px solid rgba(255,255,255,0.05)">
<div class="muted small">Usuario: <strong>admin</strong> / <strong>admin123</strong></div>
</div>
</div>
</div>
<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

// Configuraci√≥n de Supabase (YA CONFIGURADO)
const SUPABASE_URL = 'https://lqwyoobsvfbetqqjjdkt.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imxxd3lvb2JzdmZiZXRxcWpqZGt0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMzOTczMTIsImV4cCI6MjA3ODk3MzMxMn0.F80qOvvwWnj_HquIM4B3LDBSDVU3_9zmKUVaCfAwXcc';

const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);
const STATE={currentUser:null,data:{usuarios:[],ciudadanos:[],multas:[],arrestos:[],vehiculos:[],denuncias:[],investigaciones:[],llamadas:[],bolo:[],alertas:[],auditoria:[]}};
const $=(s,r=document)=>r.querySelector(s);
const html=s=>(s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));

async function loadData(table){
  try{
    const {data,error}=await supabase.from(table).select('*').order('id',{ascending:false});
    if(error)throw error;
    return data||[];
  }catch(e){
    console.error(`Error cargando ${table}:`,e);
    return[];
  }
}

async function saveData(table,item){
  try{
    const {error}=await supabase.from(table).insert([item]);
    if(error)throw error;
    showNotif('‚úì Guardado y sincronizado','success');
    await loadAllData();
  }catch(e){
    console.error('Error:',e);
    showNotif('‚úó Error al guardar','error');
  }
}

async function deleteData(table,id){
  try{
    const {error}=await supabase.from(table).delete().eq('id',id);
    if(error)throw error;
    showNotif('‚úì Eliminado','success');
    await loadAllData();
  }catch(e){
    console.error('Error:',e);
    showNotif('‚úó Error','error');
  }
}

async function registrarAuditoria(a){
  await saveData('auditoria',{accion:a,usuario:STATE.currentUser?.nombre||'Sistema',fecha:new Date().toISOString()});
}

async function loadAllData(){
  STATE.data.usuarios=await loadData('usuarios');
  STATE.data.ciudadanos=await loadData('ciudadanos');
  STATE.data.multas=await loadData('multas');
  STATE.data.arrestos=await loadData('arrestos');
  STATE.data.vehiculos=await loadData('vehiculos');
  STATE.data.denuncias=await loadData('denuncias');
  STATE.data.investigaciones=await loadData('investigaciones');
  STATE.data.llamadas=await loadData('llamadas');
  STATE.data.bolo=await loadData('bolo');
  STATE.data.alertas=await loadData('alertas');
  STATE.data.auditoria=await loadData('auditoria');
  updateCardBadges();
}

function showNotif(m,t='info'){
  const n=document.createElement('div');
  n.style.cssText=`position:fixed;top:80px;right:20px;z-index:10000;padding:14px 24px;border-radius:10px;background:${t==='success'?'linear-gradient(90deg,#10b981,#059669)':'linear-gradient(90deg,#ef4444,#dc2626)'};color:white;font-weight:700;box-shadow:0 10px 40px rgba(0,0,0,0.6)`;
  n.textContent=m;
  document.body.appendChild(n);
  setTimeout(()=>n.remove(),3000);
}

function updateCardBadges(){
  const b={ciudadanos:STATE.data.ciudadanos.length,multas:STATE.data.multas.length,arrestos:STATE.data.arrestos.length,vehiculos:STATE.data.vehiculos.length,denuncias:STATE.data.denuncias.length,investigaciones:STATE.data.investigaciones.length,llamadas:STATE.data.llamadas.length,bolo:STATE.data.bolo.length,alertas:STATE.data.alertas.length,auditoria:STATE.data.auditoria.length};
  Object.keys(b).forEach(id=>{
    const c=document.querySelector(`[data-card="${id}"]`);
    if(c&&b[id]>0){
      let badge=c.querySelector('.badge');
      if(!badge){badge=document.createElement('div');badge.className='badge';c.appendChild(badge);}
      badge.textContent=b[id];
    }
  });
}

async function initAdmin(){
  const users=await loadData('usuarios');
  if(users.length===0){
    await saveData('usuarios',{username:'admin',password:'admin123',nombre:'Administrador',rol:'admin',placa:'ADMIN-001',fechaCreacion:new Date().toISOString()});
  }
}

const CARDS=[
  {id:'ciudadanos',title:'PDA / Fichas',desc:'Base de datos',icon:'üöì'},
  {id:'llamadas',title:'Llamadas',desc:'Dispatch',icon:'üìû'},
  {id:'buscar',title:'B√∫squeda',desc:'Consultar',icon:'üîç'},
  {id:'multas',title:'Multas',desc:'Infracciones',icon:'üìã'},
  {id:'arrestos',title:'Arrestos',desc:'Detenciones',icon:'‚õìÔ∏è'},
  {id:'vehiculos',title:'Veh√≠culos',desc:'Registro',icon:'üöó'},
  {id:'bolo',title:'BOLO',desc:'Buscados',icon:'üö®'},
  {id:'denuncias',title:'Denuncias',desc:'Reportes',icon:'üìù'},
  {id:'investigaciones',title:'Investigaciones',desc:'Casos',icon:'üî¨'},
  {id:'alertas',title:'Alertas',desc:'Alertas',icon:'‚ö†Ô∏è'},
  {id:'codigos',title:'C√≥digos',desc:'Se√±ales',icon:'üì°'},
  {id:'auditoria',title:'Auditor√≠a',desc:'Registro',icon:'üìú',adminOnly:true},
  {id:'admin',title:'Admin',desc:'Usuarios',icon:'‚öôÔ∏è',adminOnly:true}
];

function renderCards(){
  const g=$('#cardsGrid');
  g.innerHTML='';
  CARDS.forEach(c=>{
    if(c.adminOnly&&(!STATE.currentUser||STATE.currentUser.rol!=='admin'))return;
    const e=document.createElement('div');
    e.className='card';
    e.setAttribute('data-card',c.id);
    e.innerHTML=`<div class="icon">${c.icon}</div><div class="title">${c.title}</div><div class="desc">${c.desc}</div>`;
    e.onclick=()=>openPanel(c.id);
    g.appendChild(e);
  });
  updateCardBadges();
}

function openPanel(id){
  const a=$('#expandedArea');
  a.innerHTML='';
  const p=document.createElement('div');
  p.className='expanded';
  a.appendChild(p);
  
  switch(id){
    case'ciudadanos':renderCiudadanos(p);break;
    case'codigos':renderCodigos(p);break;
    case'admin':renderAdmin(p);break;
    case'auditoria':renderAuditoria(p);break;
    case'buscar':renderBuscar(p);break;
    default:
      p.innerHTML=`<div class="flex" style="justify-content:space-between;margin-bottom:20px"><div><strong style="font-size:20px">${CARDS.find(c=>c.id===id)?.icon} ${CARDS.find(c=>c.id===id)?.title}</strong></div><button class="btn-ghost" onclick="closePanel()">Cerrar</button></div><div class="muted">Panel funcional. Usa PDA/Fichas como referencia para este panel.</div>`;
      break;
  }
  p.scrollIntoView({behavior:'smooth'});
}

function renderCiudadanos(p){
  p.innerHTML=`<div class="flex" style="justify-content:space-between;margin-bottom:20px"><div><strong style="font-size:20px">üöì PDA / Fichas</strong></div><button class="btn-ghost" onclick="closePanel()">Cerrar</button></div><div class="grid-2"><div><input id="searchCiu" placeholder="Buscar..." style="margin-bottom:12px"><div id="listCiu" class="list"></div></div><div><strong>Nueva Ficha</strong><div class="flex flex-col gap-2 mt-3"><input id="cNombre" placeholder="Nombre *"><input id="cDNI" placeholder="DNI *"><input id="cFecha" type="date"><input id="cDir" placeholder="Direcci√≥n"><input id="cTel" placeholder="Tel√©fono"><button class="btn" onclick="window.crearCiu()">Registrar</button></div></div></div>`;
  loadCiu();
  $('#searchCiu').oninput=loadCiu;
  supabase.channel('ciudadanos_changes').on('postgres_changes',{event:'*',schema:'public',table:'ciudadanos'},()=>{loadAllData();loadCiu();}).subscribe();
}

function loadCiu(){
  const l=$('#listCiu');
  if(!l)return;
  const q=($('#searchCiu')?.value||'').toLowerCase();
  const items=STATE.data.ciudadanos.filter(c=>(c.nombre||'').toLowerCase().includes(q)||(c.dni||'').toLowerCase().includes(q));
  const isA=STATE.currentUser&&STATE.currentUser.rol==='admin';
  l.innerHTML=items.length?items.map(c=>`<div class="item"><div style="flex:1"><strong>${html(c.nombre)}</strong><div class="muted small">DNI: ${html(c.dni)}${c.telefono?' ‚Ä¢ '+html(c.telefono):''}</div>${c.direccion?`<div class="muted small">${html(c.direccion)}</div>`:''}</div>${isA?`<button class="btn-danger btn-ghost" onclick="window.eliminarCiu(${c.id})">X</button>`:''}</div>`).join(''):'<div class="muted small">Sin fichas</div>';
}

window.crearCiu=async function(){
  const n=$('#cNombre')?.value.trim(),d=$('#cDNI')?.value.trim();
  if(!n||!d)return showNotif('Complete campos','error');
  await saveData('ciudadanos',{nombre:n,dni:d,fechaNacimiento:$('#cFecha')?.value,direccion:$('#cDir')?.value,telefono:$('#cTel')?.value,oficialRegistro:STATE.currentUser?.nombre||'Sistema',fechaRegistro:new Date().toISOString()});
  await registrarAuditoria(`Ficha creada: ${n}`);
  $('#cNombre').value=$('#cDNI').value=$('#cFecha').value=$('#cDir').value=$('#cTel').value='';
};

window.eliminarCiu=async function(id){
  if(!confirm('¬øEliminar?'))return;
  await deleteData('ciudadanos',id);
  await registrarAuditoria('Ficha eliminada');
};

function renderBuscar(p){
  p.innerHTML=`<div class="flex" style="justify-content:space-between;margin-bottom:20px"><div><strong style="font-size:20px">üîç B√∫squeda Global</strong></div><button class="btn-ghost" onclick="closePanel()">Cerrar</button></div><input id="globalSearch" placeholder="Buscar..." style="font-size:16px;padding:14px;margin-bottom:16px"><div id="searchResults"></div>`;
  $('#globalSearch').oninput=()=>{
    const q=$('#globalSearch').value.toLowerCase(),r=$('#searchResults');
    if(q.length<2){r.innerHTML='<div class="muted small">Escriba al menos 2 caracteres</div>';return}
    const c=STATE.data.ciudadanos.filter(x=>(x.nombre||'').toLowerCase().includes(q)||(x.dni||'').toLowerCase().includes(q));
    const m=STATE.data.multas.filter(x=>(x.nombre||'').toLowerCase().includes(q)||(x.dni||'').toLowerCase().includes(q));
    const a=STATE.data.arrestos.filter(x=>(x.nombre||'').toLowerCase().includes(q)||(x.dni||'').toLowerCase().includes(q));
    const v=STATE.data.vehiculos.filter(x=>(x.matricula||'').toLowerCase().includes(q));
    let h='';
    if(c.length)h+=`<h4>üöì Fichas (${c.length})</h4><div class="list">${c.slice(0,5).map(x=>`<div class="item"><strong>${html(x.nombre)}</strong><div class="muted small">DNI: ${html(x.dni)}</div></div>`).join('')}</div>`;
    if(m.length)h+=`<h4 style="margin-top:16px">üìã Multas (${m.length})</h4><div class="list">${m.slice(0,5).map(x=>`<div class="item"><strong>${html(x.nombre)}</strong><div class="muted small">${html(x.tipo)}</div></div>`).join('')}</div>`;
    if(a.length)h+=`<h4 style="margin-top:16px">‚õìÔ∏è Arrestos (${a.length})</h4><div class="list">${a.slice(0,5).map(x=>`<div class="item"><strong>${html(x.nombre)}</strong><div class="muted small">${html(x.cargo)}</div></div>`).join('')}</div>`;
    if(v.length)h+=`<h4 style="margin-top:16px">üöó Veh√≠culos (${v.length})</h4><div class="list">${v.slice(0,5).map(x=>`<div class="item"><strong>${html(x.matricula)}</strong><div class="muted small">${html(x.marca)}</div></div>`).join('')}</div>`;
    r.innerHTML=h||'<div class="muted small">Sin resultados</div>';
  };
}

function renderCodigos(p){
  const codigos=[{code:'10-4',desc:'Mensaje recibido'},{code:'10-6',desc:'Ocupado'},{code:'10-8',desc:'En servicio'},{code:'10-15',desc:'Detenido'},{code:'10-20',desc:'Ubicaci√≥n'},{code:'10-23',desc:'En posici√≥n'},{code:'10-31',desc:'Crimen en progreso'},{code:'10-32',desc:'Persona armada'},{code:'10-99',desc:'Oficial ca√≠do'},{code:'C√≥digo 0',desc:'Oficial en peligro'},{code:'C√≥digo 1',desc:'Situaci√≥n bajo control'},{code:'C√≥digo 2',desc:'Respuesta urgente'},{code:'C√≥digo 3',desc:'Respuesta de emergencia'},{code:'C√≥digo 4',desc:'No se requiere asistencia'}];
  p.innerHTML=`<div class="flex" style="justify-content:space-between;margin-bottom:20px"><div><strong style="font-size:20px">üì° C√≥digos</strong></div><button class="btn-ghost" onclick="closePanel()">Cerrar</button></div><div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px">${codigos.map(c=>`<div class="item" style="text-align:center;padding:20px"><div style="font-size:24px;font-weight:900;color:var(--accent);margin-bottom:8px">${c.code}</div><div class="muted small">${c.desc}</div></div>`).join('')}</div>`;
}

function renderAdmin(p){
  if(!STATE.currentUser||STATE.currentUser.rol!=='admin'){p.innerHTML='<div class="item"><strong>Acceso Denegado</strong></div>';return;}
  p.innerHTML=`<div class="flex" style="justify-content:space-between;margin-bottom:20px"><div><strong style="font-size:20px">‚öôÔ∏è Admin</strong></div><button class="btn-ghost" onclick="closePanel()">Cerrar</button></div><div class="grid-2"><div><strong>Usuarios</strong><div id="listUsuarios" class="list" style="margin-top:12px"></div></div><div><strong>Crear Usuario</strong><div class="flex flex-col gap-2 mt-3"><input id="uUsername" placeholder="Usuario *"><input id="uPassword" type="password" placeholder="Contrase√±a *"><input id="uNombre" placeholder="Nombre *"><input id="uPlaca" placeholder="Placa"><select id="uRol"><option value="oficial">Oficial</option><option value="sargento">Sargento</option><option value="admin">Admin</option></select><button class="btn" onclick="window.crearUsuario()">Crear</button></div></div></div>`;
  loadUsuarios();
  supabase.channel('usuarios_changes').on('postgres_changes',{event:'*',schema:'public',table:'usuarios'},()=>{loadAllData();loadUsuarios();}).subscribe();
}

function loadUsuarios(){
  const l=$('#listUsuarios');
  if(!l)return;
  l.innerHTML=STATE.data.usuarios.length?STATE.data.usuarios.map(u=>`<div class="item"><div style="flex:1"><strong>${html(u.nombre)}</strong><div class="muted small">${html(u.username)} ‚Ä¢ ${html(u.rol)}</div></div><button class="btn-danger btn-ghost" onclick="window.eliminarUsuario(${u.id})" ${u.username==='admin'?'disabled':''}>X</button></div>`).join(''):'<div class="muted small">Sin usuarios</div>';
}

window.crearUsuario=async function(){
  const u=$('#uUsername')?.value.trim(),p=$('#uPassword')?.value.trim(),n=$('#uNombre')?.value.trim();
  if(!u||!p||!n)return showNotif('Complete campos','error');
  if(STATE.data.usuarios.find(us=>us.username===u))return showNotif('Usuario existe','error');
  await saveData('usuarios',{username:u,password:p,nombre:n,placa:$('#uPlaca')?.value,rol:$('#uRol').value,fechaCreacion:new Date().toISOString()});
  await registrarAuditoria(`Usuario creado: ${u}`);
  $('#uUsername').value=$('#uPassword').value=$('#uNombre').value=$('#uPlaca').value='';
};

window.eliminarUsuario=async function(id){
  if(!confirm('¬øEliminar?'))return;
  await deleteData('usuarios',id);
  await registrarAuditoria('Usuario eliminado');
};

function renderAuditoria(p){
  p.innerHTML=`<div class="flex" style="justify-content:space-between;margin-bottom:20px"><div><strong style="font-size:20px">üìú Auditor√≠a</strong></div><button class="btn-ghost" onclick="closePanel()">Cerrar</button></div><div id="listAuditoria" class="list"></div>`;
  loadAuditoria();
  supabase.channel('auditoria_changes').on('postgres_changes',{event:'*',schema:'public',table:'auditoria'},()=>{loadAllData();loadAuditoria();}).subscribe();
}

function loadAuditoria(){
  const l=$('#listAuditoria');
  if(!l)return;
  l.innerHTML=STATE.data.auditoria.length?STATE.data.auditoria.slice(0,100).map(a=>`<div class="item"><div style="flex:1"><strong>${html(a.accion)}</strong><div class="muted small">${html(a.usuario)}</div><div class="muted small">${new Date(a.fecha).toLocaleString()}</div></div></div>`).join(''):'<div class="muted small">Sin registros</div>';
}

window.closePanel=function(){$('#expandedArea').innerHTML='';updateCardBadges();};

function updateUI(){
  $('#userDisplay').textContent=STATE.currentUser?`${STATE.currentUser.nombre} (${STATE.currentUser.rol})`:'No conectado';
  $('#btnLogin').style.display=STATE.currentUser?'none':'inline-block';
  $('#btnLogout').style.display=STATE.currentUser?'inline-block':'none';
  $('#adminIndicator').style.display=STATE.currentUser&&STATE.currentUser.rol==='admin'?'inline-block':'none';
  renderCards();
}

$('#btnLogin').onclick=()=>$('#loginModal').classList.add('show');
$('#btnCancelLogin').onclick=()=>$('#loginModal').classList.remove('show');
$('#btnLogout').onclick=()=>{STATE.currentUser=null;updateUI();$('#expandedArea').innerHTML='';showNotif('Sesi√≥n cerrada','info');};
$('#btnDoLogin').onclick=async()=>{
  const u=$('#loginUser').value.trim(),p=$('#loginPass').value.trim();
  if(!u||!p){$('#loginError').textContent='Complete campos';$('#loginError').style.display='block';return}
  const user=STATE.data.usuarios.find(us=>us.username===u&&us.password===p);
  if(!user){$('#loginError').textContent='Usuario o contrase√±a incorrectos';$('#loginError').style.display='block';return}
  STATE.currentUser=user;
  updateUI();
  $('#loginModal').classList.remove('show');
  $('#loginUser').value=$('#loginPass').value='';
  $('#loginError').style.display='none';
  showNotif(`Bienvenido ${user.nombre}`,'success');
  await registrarAuditoria(`Login: ${user.username}`);
};

// Inicializaci√≥n
(async()=>{
  try{
    await initAdmin();
    await loadAllData();
    updateUI();
    showNotif('‚úì Sistema conectado','success');
  }catch(e){
    console.error('Error de inicializaci√≥n:',e);
    showNotif('Error al conectar con Supabase','error');
  }
})();
</script>
</body>
</html>
