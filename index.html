<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sistema Policial</title>

    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            background: #111;
            color: #fff;
        }

        header {
            background: #181818;
            padding: 14px 20px;
            border-bottom: 1px solid #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .container {
            padding: 20px;
        }

        .cards {
            display: grid;
            grid-template-columns: repeat(auto-fit,minmax(240px,1fr));
            gap: 16px;
        }

        .card {
            background: #1a1a1a;
            padding: 18px;
            border-radius: 10px;
            cursor: pointer;
            border: 1px solid #333;
            transition: .2s;
        }

        .card:hover {
            border-color: #555;
            background: #222;
        }

        .list{
            margin-top:14px;
            padding-left:0;
        }

        .item{
            padding:8px 0;
            border-bottom:1px solid #333;
            display:flex;
            justify-content:space-between;
            align-items:center;
        }

        .badge{
            background:#444;
            padding:3px 8px;
            border-radius:5px;
            margin-right:6px;
        }

        .btn{
            padding:7px 10px;
            border-radius:6px;
            border:none;
            cursor:pointer;
            font-weight:bold;
        }

        .btn-danger{
            background:#a32626;
            color:white;
        }

        .btn-primary{
            background:#2463c6;
            color:white;
        }

        .muted{
            color:#aaa;
        }

        .small{
            font-size:13px;
        }

        /* Notificaciones */
        #notifBox{
            position:fixed;
            top:24px;
            right:24px;
            z-index:9999;
            width:280px;
        }

        .notif{
            background:#222;
            border-left:4px solid #2a7bf6;
            padding:10px 14px;
            margin-top:10px;
            border-radius:6px;
            animation:fadein .3s ease;
        }

        .notif.error{
            border-color:#e63939;
        }

        @keyframes fadein{
            from{opacity:0; transform:translateY(-6px);}
            to{opacity:1; transform:translateY(0);}
        }
    </style>
</head>

<body>

<header>
    <h2>üöì Sistema Policial</h2>
    <div id="userBox" class="small muted">No autenticado</div>
</header>

<div id="notifBox"></div>

<div class="container">
    <div id="cards" class="cards"></div>
    <div id="panel"></div>
</div>

<script type="module">
import { createClient } from "https://esm.sh/@supabase/supabase-js";

const supabaseUrl = "TU_URL_AQUI";
const supabaseKey = "TU_KEY_AQUI";

const supabase = createClient(supabaseUrl, supabaseKey);

const STATE = {
    currentUser: null,
    servicioActual: null
};

function showNotif(msg, type="info"){
    const box = document.getElementById("notifBox");
    const div = document.createElement("div");
    div.className = "notif " + (type === "error" ? "error" : "");
    div.innerHTML = msg;
    box.appendChild(div);
    setTimeout(()=>div.remove(), 3500);
}
/******************************************
 *     TARJETAS (CARDS) DEL SISTEMA
 ******************************************/
const CARDS = [
    { id: 'usuarios', title: 'Usuarios', desc: 'Gesti√≥n de usuarios', icon: 'üë§' },
    { id: 'codigos', title: 'C√≥digos', desc: 'C√≥digos policiales', icon: 'üì°' },

    /* üîµ NUEVA CARD: EN SERVICIO */
    { id: 'servicio', title: 'En servicio', desc: 'Usuarios activos', icon: 'üü¢' },
];

function renderCards(){
    const cards = document.getElementById("cards");
    cards.innerHTML = CARDS.map(c => `
        <div class="card" data-id="${c.id}">
            <h3>${c.icon} ${c.title}</h3>
            <p class="muted small">${c.desc}</p>
        </div>
    `).join("");

    document.querySelectorAll(".card").forEach(card=>{
        card.onclick = ()=>{
            openPanel(card.getAttribute("data-id"));
        };
    });
}

function openPanel(id){
    const panel = document.getElementById("panel");

    if(id === "codigos"){
        renderCodigos(panel);
    }
    else if(id === "servicio"){
        renderServicio(panel);
    }
    else{
        panel.innerHTML = "<p class='muted'>Panel no implementado.</p>";
    }
}

/******************************************
 *          LOGIN SIMPLIFICADO
 ******************************************/
async function fakeLogin(){
    const { data, error } = await supabase
        .from("usuarios")
        .select("*")
        .limit(1);

    if(data && data.length){
        STATE.currentUser = data[0];
        document.getElementById("userBox").textContent =
            `Conectado como ${STATE.currentUser.username}`;
    } else {
        showNotif("No existe ning√∫n usuario en la tabla usuarios.", "error");
    }

    /* Cargar estado actual EN SERVICIO */
    await loadServicio();
}

fakeLogin();

/******************************************
 *      PARTE 1 ‚Äî SISTEMA EN SERVICIO
 ******************************************/
async function loadServicio(){
    if(!STATE.currentUser) return;

    const { data } = await supabase
        .from("servicio")
        .select("*")
        .eq("usuario_id", STATE.currentUser.id)
        .is("fecha_salida", null)
        .order("fecha_entrada", { ascending: false });

    STATE.servicioActual = (data && data.length) ? data[0] : null;
}

async function loadServicioLista(){
    const list = document.getElementById("usuariosEnServicio");
    if(!list) return;

    const { data, error } = await supabase
        .from("servicio")
        .select("username, nombre, fecha_entrada")
        .is("fecha_salida", null)
        .order("fecha_entrada", { ascending: true });

    if(error){
        list.innerHTML = `<div class="muted small">Error cargando usuarios en servicio</div>`;
        return;
    }

    list.innerHTML = data && data.length
        ? data.map(u => `
            <div class="item">
                <strong>${u.nombre || u.username}</strong>
                <span class="muted small">${
                    (new Date(u.fecha_entrada)).toLocaleTimeString()
                }</span>
            </div>
        `).join("")
        : `<div class="muted small">Nadie en servicio</div>`;
}

function renderServicio(panel){
    const enServicio = STATE.servicioActual && !STATE.servicioActual.fecha_salida;

    panel.innerHTML = `
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px">
            <strong style="font-size:20px">üü¢ Usuarios en servicio</strong>
            <button class="btn ${enServicio ? 'btn-danger' : 'btn-primary'}" id="btnTglServ">
                ${enServicio ? 'Salir de servicio' : 'Entrar en servicio'}
            </button>
        </div>

        <div id="usuariosEnServicio" class="list small"></div>
    `;

    document.getElementById("btnTglServ").onclick = async ()=>{

        if(!STATE.currentUser) return;

        if(!enServicio){
            /* ENTRAR */
            await supabase.from("servicio").insert([{
                usuario_id: STATE.currentUser.id,
                username: STATE.currentUser.username,
                nombre: STATE.currentUser.nombre || STATE.currentUser.username
            }]);
        } else {
            /* SALIR */
            await supabase.from("servicio")
                .update({
                    fecha_salida: new Date().toISOString(),
                    en_servicio: false
                })
                .eq("id", STATE.servicioActual.id);
        }

        await loadServicio();
        renderServicio(panel);
    };

    loadServicioLista();
}
      /* ============================
         PANEL: EN SERVICIO
      ============================ */

      async function loadServicio() {
        if (STATE.currentUser) {
          const { data, error } = await supabase
            .from("servicio")
            .select("*")
            .eq("usuario_id", STATE.currentUser.id)
            .is("fecha_salida", null)
            .order("fecha_entrada", { ascending: false });

          STATE.servicioActual = data && data.length > 0 ? data[0] : null;
        }
      }

      async function loadServicioLista() {
        const list = document.getElementById("usuariosEnServicio");
        if (!list) return;

        const { data, error } = await supabase
          .from("servicio")
          .select("username, nombre, fecha_entrada")
          .is("fecha_salida", null)
          .order("fecha_entrada", { ascending: true });

        if (error) {
          list.innerHTML =
            '<div class="muted small">Error cargando usuarios en servicio</div>';
          return;
        }

        list.innerHTML =
          data && data.length
            ? data
                .map(
                  (u) => `
            <div class="item">
              <strong>${u.nombre || u.username}</strong>
              <span class="muted small">${new Date(
                u.fecha_entrada
              ).toLocaleTimeString()}</span>
            </div>
          `
                )
                .join("")
            : '<div class="muted small">Nadie en servicio</div>';
      }

      function renderServicio(panel) {
        const enServicio =
          STATE.servicioActual && !STATE.servicioActual.fecha_salida;

        panel.innerHTML = `
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px">
            <strong style="font-size:20px">üü¢ Usuarios en servicio</strong>
            <button class="btn${enServicio ? " btn-danger" : ""}" id="btnTglServ">
              ${enServicio ? "Salir de servicio" : "Entrar en servicio"}
            </button>
          </div>
          <div id="usuariosEnServicio" class="list small"></div>
        `;

        document.getElementById("btnTglServ").onclick = async () => {
          if (!STATE.currentUser) return;

          if (!enServicio) {
            await supabase.from("servicio").insert([
              {
                usuario_id: STATE.currentUser.id,
                username: STATE.currentUser.username,
                nombre:
                  STATE.currentUser.nombre || STATE.currentUser.username,
              },
            ]);
          } else {
            await supabase
              .from("servicio")
              .update({
                fecha_salida: new Date().toISOString(),
                en_servicio: false,
              })
              .eq("id", STATE.servicioActual.id);
          }

          await loadServicio();
          renderServicio(panel);
        };

        loadServicioLista();
      }

      /* ============================
         PANEL: C√ìDIGOS POLICIALES
      ============================ */

      function renderCodigos(p) {
        const codigos = [
          { code: "10-4", desc: "Mensaje recibido" },
          { code: "10-6", desc: "Ocupado" },
          { code: "10-8", desc: "En servicio" },
          { code: "10-15", desc: "Detenido" },
          { code: "10-20", desc: "Ubicaci√≥n" },
          { code: "10-23", desc: "En el sitio" },
          { code: "10-31", desc: "Crimen en progreso" },
          { code: "10-99", desc: "Situaci√≥n peligrosa" },
        ];

        p.innerHTML = `
        <div>
          <strong style="font-size:20px">üì° C√≥digos Policiales</strong>
          <div id="codigosList" class="list" style="margin-top:14px">
            ${codigos
              .map(
                (c) => `
              <div class="item" style="cursor:pointer" data-code="${c.code}">
                <strong><span class="badge">${c.code}</span> ${c.desc}</strong>
              </div>
            `
              )
              .join("")}
          </div>
        </div>
      `;

        document.querySelectorAll("#codigosList .item").forEach((item) => {
          item.onclick = async () => {
            if (!STATE.currentUser)
              return showNotif("Debes iniciar sesi√≥n", "error");

            await supabase.from("auditoria").insert([
              {
                accion: `C√≥digo emitido: ${item.getAttribute("data-code")}`,
                usuario:
                  STATE.currentUser.nombre ||
                  STATE.currentUser.username,
                fecha: new Date().toISOString(),
              },
            ]);

            showNotif(
              `üõ°Ô∏è <b>${
                STATE.currentUser.nombre || STATE.currentUser.username
              }</b> envi√≥ el c√≥digo <b>${item.getAttribute("data-code")}</b>`,
              "info"
            );
          };
        });
      }
        <!-- ============================== -->
        <!-- üì° SISTEMA DE C√ìDIGOS REPARADO -->
        <!-- ============================== -->

        <script>
        function renderCodigos(p){
            const codigos = [
                {code:'10-4',desc:'Mensaje recibido'},
                {code:'10-6',desc:'Ocupado'},
                {code:'10-8',desc:'En servicio'},
                {code:'10-15',desc:'Detenido'},
                {code:'10-20',desc:'Ubicaci√≥n'},
                {code:'10-23',desc:'En el sitio'},
                {code:'10-31',desc:'Crimen en progreso'},
                {code:'10-99',desc:'Situaci√≥n peligrosa'}
            ];

            p.innerHTML = `
                <div>
                    <strong style="font-size:20px">üì° C√≥digos Policiales</strong>
                    <div id="codigosList" class="list" style="margin-top:14px">
                        ${codigos
                            .map(c => `
                                <div class="item" style="cursor:pointer" data-code="${c.code}">
                                    <strong><span class="badge">${c.code}</span> ${c.desc}</strong>
                                </div>
                            `)
                            .join("")}
                    </div>
                </div>
            `;

            document.querySelectorAll('#codigosList .item').forEach(item => {
                item.onclick = async () => {
                    if (!STATE.currentUser) {
                        return showNotif('Debes iniciar sesi√≥n', 'error');
                    }

                    const codigo = item.getAttribute('data-code');

                    await supabase.from('auditoria').insert([
                        {
                            accion: `C√≥digo emitido: ${codigo}`,
                            usuario: STATE.currentUser.nombre || STATE.currentUser.username,
                            fecha: new Date().toISOString()
                        }
                    ]);

                    showNotif(
                        `üõ°Ô∏è <b>${STATE.currentUser.nombre || STATE.currentUser.username}</b> envi√≥ el c√≥digo <b>${codigo}</b>`,
                        'info'
                    );
                };
            });
        }
        </script>
        <!-- ============================== -->
        <!-- üîö CIERRE DEL SCRIPT PRINCIPAL -->
        <!-- ============================== -->

        <script>
        // =============================
        // üîÑ RENDERIZADOR GENERAL
        // =============================
        function renderPanel(id) {
            const panel = document.getElementById("panel");
            panel.innerHTML = "";

            const card = CARDS.find(c => c.id === id);
            if (!card) return;

            if (card.id === "servicio") renderServicio(panel);
            else if (card.id === "codigos") renderCodigos(panel);
            else if (card.render) card.render(panel);
        }

        // =============================
        // üåê INICIALIZACI√ìN GLOBAL
        // =============================
        async function init() {
            await loadUser();
            await loadServicio();

            const menu = document.getElementById("menu");
            menu.innerHTML = CARDS.map(c =>
                `<div class="card" data-id="${c.id}">
                    <div class="icon">${c.icon}</div>
                    <div class="title">${c.title}</div>
                    <div class="desc">${c.desc}</div>
                </div>`
            ).join("");

            document.querySelectorAll(".card").forEach(card => {
                card.onclick = () => renderPanel(card.getAttribute("data-id"));
            });
        }

        init();
        </script>

    </body>
</html>
