<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Sistema Policial</title>
<style>
:root{--bg-1:#06121a;--bg-2:#071729;--muted:#9fb3bd;--text:#e6f0f6;--accent:#7c3aed;--accent-2:#06b6a4;--danger:#ff6b6b;--glass:rgba(255,255,255,0.03);--card-grad:linear-gradient(180deg,rgba(255,255,255,0.014),rgba(255,255,255,0.006));--radius:12px;--shadow:0 14px 40px rgba(2,6,10,0.6);font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Arial}
*{box-sizing:border-box;margin:0;padding:0;user-select:none;-webkit-user-select:none}
html,body{height:100%;background:radial-gradient(800px 300px at 12% 8%,rgba(124,58,237,0.06),transparent),linear-gradient(180deg,var(--bg-2) 0%,var(--bg-1) 60%);color:var(--text);-webkit-font-smoothing:antialiased;overflow-x:hidden;overflow-y:auto}
.bg{position:fixed;inset:0;z-index:0;pointer-events:none;overflow:hidden}.nebula{position:absolute;width:60vmax;height:60vmax;left:-10vmin;top:-8vmin;background:radial-gradient(circle at 30% 30%,rgba(124,58,237,0.24),transparent 30%),radial-gradient(circle at 70% 70%,rgba(6,182,164,0.12),transparent 25%);filter:blur(56px) saturate(120%);animation:float 12s ease-in-out infinite}.nebula.r{right:-10vmin;left:auto;top:6vmin;background:radial-gradient(circle at 70% 20%,rgba(255,80,120,0.20),transparent 30%),radial-gradient(circle at 30% 80%,rgba(110,231,183,0.12),transparent 25%);filter:blur(56px) saturate(120%);animation-duration:10s;animation-direction:reverse}@keyframes float{0%,100%{transform:translateY(-8px)}50%{transform:translateY(8px)}}

/* --- ESTRUCTURA PRINCIPAL RESPONSIVE --- */
#header{position:fixed;top:0;left:0;right:0;height:70px;background:var(--bg-2);box-shadow:var(--shadow);z-index:100}
#headerContent{max-width:1200px;margin:0 auto;height:100%;display:flex;justify-content:space-between;align-items:center;padding:0 20px;gap:18px}
#appContainer{max-width:1200px;margin:0 auto;padding:20px;padding-top:100px;min-height:100vh}

.brand{display:flex;gap:12px;align-items:center}.logo{width:40px;height:40px;border-radius:8px;background:linear-gradient(135deg,var(--accent-2),var(--accent));display:flex;align-items:center;justify-content:center;font-weight:900;color:#031018;font-size:18px}
.header-title-text{font-size:16px}
.subtitle{color:var(--muted);font-size:11px}
.top-right{display:flex;gap:10px;align-items:center;flex-wrap:wrap}

h1{font-size:2.2rem;font-weight:700;color:var(--text);margin-bottom:30px}

/* --- ESTILOS GENERALES --- */
.pill{background:var(--glass);padding:8px 12px;border-radius:999px;font-weight:700;color:var(--muted);font-size:13px}.btn{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#031018;padding:8px 16px;border-radius:10px;border:none;cursor:pointer;font-weight:800;transition:all .2s;font-size:13px}.btn:hover{transform:translateY(-2px);opacity:0.9}.btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.08);color:var(--muted);padding:7px 12px;border-radius:10px;cursor:pointer;transition:all .2s;font-weight:600;font-size:13px}.btn-ghost:hover{border-color:var(--accent);color:var(--text)}.btn-danger{background:linear-gradient(90deg,#ef4444,#dc2626);color:white}.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:16px;padding-bottom:100px}
.card{background:var(--card-grad);border-radius:var(--radius);padding:20px;border:1px solid rgba(255,255,255,0.04);box-shadow:var(--shadow);min-height:140px;transition:all .18s;cursor:pointer;position:relative}.card:hover{transform:translateY(-8px);box-shadow:0 30px 60px rgba(0,0,0,0.7);border-color:rgba(140,80,240,0.12)}.card .icon{font-size:42px;margin-bottom:12px}.card .title{font-weight:900;font-size:18px;margin-bottom:4px}.card .desc{color:var(--muted);font-size:13px}.card .badge{position:absolute;top:12px;right:12px;background:rgba(124,58,237,0.2);padding:4px 10px;border-radius:12px;font-size:11px;font-weight:800;color:var(--accent)}.expanded{margin-top:20px;border-radius:12px;padding:24px;background:linear-gradient(180deg,rgba(255,255,255,0.012),rgba(255,255,255,0.006));border:1px solid rgba(255,255,255,0.04);box-shadow:0 16px 44px rgba(0,0,0,0.55);animation:slideUp .3s ease}@keyframes slideUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:none}}.list{display:flex;flex-direction:column;gap:10px;max-height:500px;overflow-y:auto;padding-right:4px}.list::-webkit-scrollbar{width:6px}.list::-webkit-scrollbar-track{background:rgba(0,0,0,0.2);border-radius:10px}.list::-webkit-scrollbar-thumb{background:rgba(124,58,237,0.3);border-radius:10px}.item{padding:14px;border-radius:10px;background:rgba(255,255,255,0.012);border:1px solid rgba(255,255,255,0.03);transition:all .2s;display:flex;justify-content:space-between;align-items:center;gap:12px}.item:hover{background:rgba(255,255,255,0.02);border-color:rgba(140,80,240,0.08)}.clickable-code{cursor:pointer}.clickable-code:hover{background:rgba(124,58,237,0.1);border-color:var(--accent)}.clickable-code:active{transform:translateY(1px);opacity:0.9}input,textarea,select{background:rgba(0,0,0,0.25);border:1px solid rgba(255,255,255,0.06);padding:10px 12px;border-radius:8px;color:var(--text);font:inherit;transition:all .2s;width:100%;user-select:text;-webkit-user-select:text}input:focus,textarea:focus,select:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px rgba(124,58,237,0.1)}textarea{min-height:100px;resize:vertical}label{display:block;margin-bottom:6px;font-size:13px;font-weight:600;color:var(--muted)}.overlay{position:fixed;inset:0;background:rgba(2,6,10,0.92);backdrop-filter:blur(12px);display:none;align-items:center;justify-content:center;z-index:9999}.overlay.show{display:flex}.modal{width:480px;max-width:95%;background:linear-gradient(180deg,#0a1628,#061421);padding:32px;border-radius:14px;border:1px solid rgba(255,255,255,0.08);box-shadow:0 25px 70px rgba(0,0,0,0.9)}.modal h3{font-size:24px;margin-bottom:8px}.muted{color:var(--muted)}.small{font-size:13px}.mt-2{margin-top:8px}.mt-3{margin-top:12px}.flex{display:flex}.flex-col{flex-direction:column}.gap-2{gap:8px}.grid-2{display:grid;grid-template-columns:2fr 1fr;gap:20px}.sync-indicator{position:fixed;bottom:20px;right:20px;background:var(--glass);backdrop-filter:blur(10px);padding:10px 16px;border-radius:999px;border:1px solid rgba(255,255,255,0.1);display:flex;align-items:center;gap:8px;z-index:1000}.sync-dot{width:8px;height:8px;background:#4ade80;border-radius:50%;animation:pulse 2s infinite}@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.5}}footer{margin-top:40px;text-align:center;color:var(--muted);font-size:12px;padding-bottom:20px}@keyframes slideIn{from{transform:translateX(100%)}to{transform:translateX(0)}}@keyframes slideOut{from{transform:translateX(0)}to{transform:translateX(100%)}}

/* --- OPTIMIZACI√ìN M√ìVIL (media query) --- */
@media (max-width: 768px) {
  #appContainer {
    padding: 10px; 
    padding-top: 80px;
  }
  #headerContent {
    padding: 0 10px;
  }
  .header-title-text{
    font-size: 14px;
  }
  h1 {
    font-size: 1.8rem;
    margin-bottom: 20px;
  }
  .grid {
    grid-template-columns: 1fr;
    gap: 15px;
  }
  .grid-2 {
    grid-template-columns: 1fr;
  }
  .modal{
    padding: 20px;
  }
}
</style>
</head>
<body>

<div class="bg"><div class="nebula"></div><div class="nebula r"></div></div>

<div id="header">
    <div id="headerContent">
        <div class="brand">
            <div class="logo">üõ°Ô∏è</div>
            <div>
                <div class="header-title-text"> ùêíùê¢ùê¨ùê≠ùêûùê¶ùêö ùêèùêÉùêÄ ùêèùê®ùê•ùê¢ùêúùê¢ùêöùê• </div>
                <div class="subtitle">¬© Creado por Perety</div>
            </div>
        </div>
        <div class="top-right">
            <div id="userDisplay" class="pill">Conectando...</div>
            <button id="btnLogin" class="btn-ghost">Entrar</button>
            <button id="btnLogout" class="btn-ghost" style="display:none">Salir</button>
            <div id="adminIndicator" style="display:none" class="pill">üëë Administrador</div>
        </div>
    </div>
</div>

<div id="appContainer">
    <h1 id="mainTitle">Centro de Mando</h1>
    <div class="grid" id="cardsGrid"></div>
    <div id="expandedArea"></div>
    <footer> ¬© </footer>
</div>
<div class="sync-indicator"><div class="sync-dot"></div><span class="small">Sincronizado</span></div>

<div id="loginModal" class="overlay">
    <div class="modal">
        <h3>Iniciar Sesi√≥n</h3>
        <div class="muted small">‚ö†Ô∏è Acceso solo para usuarios autorizados</div>
        <div style="margin-top:24px">
            <label>Usuario</label>
            <input id="loginUser" placeholder="Usuario">
            <label style="margin-top:12px">Contrase√±a</label>
            <input id="loginPass" type="password" placeholder="Contrase√±a">
            <div class="flex gap-2 mt-3">
                <button id="btnDoLogin" class="btn" style="flex:1">Entrar</button>
                <button id="btnCancelLogin" class="btn-ghost">Cancelar</button>
            </div>
            <div id="loginError" class="muted small mt-2" style="color:var(--danger);display:none"></div>
        </div>
        <div style="margin-top:24px;padding-top:16px;border-top:1px solid rgba(255,255,255,0.05)">
            <div class="muted small">‚ö†Ô∏è Solo usuarios autorizados. Contacte al administrador para obtener acceso.</div>
        </div>
    </div>
</div>

<script type="module">

/*
* ----------------------------------------------------------------------
* CL√ÅUSULA DE COPYRIGHT ESTRICTO
* ----------------------------------------------------------------------
* Derechos de Autor (c) 2024-2025 Perety.
* Reservados todos los derechos.
*
* Este c√≥digo fuente es Propiedad Intelectual de su autor.
* Queda estrictamente prohibida su copia, reproducci√≥n total o parcial,
* modificaci√≥n, distribuci√≥n y/o uso comercial sin el permiso expreso
* y escrito del autor.
* ----------------------------------------------------------------------
*/

document.addEventListener("contextmenu",e=>e.preventDefault());document.onkeydown=e=>{if(123==e.keyCode||e.ctrlKey&&e.shiftKey&&73==e.keyCode||e.ctrlKey&&e.shiftKey&&74==e.keyCode||e.ctrlKey&&85==e.keyCode||e.ctrlKey&&83==e.keyCode)return!1};import{createClient}from'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';const U='https://lqwyoobsvfbetqqjjdkt.supabase.co';const K='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imxxd3lvb2JzdmZiZXRxcWpqZGt0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMzOTczMTIsImV4cCI6MjA3ODk3MzMxMn0.F80qOvvwWnj_HquIM4B3LDBSDVU3_9zmKUVaCfAwXcc';const db=createClient(U,K);const S={cu:null,l:false,la:false,d:{usuarios:[],ciudadanos:[],multas:[],arrestos:[],vehiculos:[],denuncias:[],investigaciones:[],llamadas:[],bolo:[],alertas:[],auditoria:[],servicio:[]}};const $=(s,r=document)=>r.querySelector(s);const html=s=>(s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));async function HP(pass){const e=new TextEncoder();const d=e.encode(pass+'POLICE_SECURE_SALT_2024_X9Z');const h=await crypto.subtle.digest('SHA-256',d);return Array.from(new Uint8Array(h)).map(b=>b.toString(16).padStart(2,'0')).join('')}async function LD(t){try{const{data,error}=await db.from(t).select('*').order('id',{ascending:false});if(error)throw error;return data||[]}catch(e){console.error(`Error cargando ${t}:`,e);return[]}}async function SD(t,i){S.l=true;try{const{error}=await db.from(t).insert([i]);if(error)throw error;N('‚úì Guardado correctamente','success');await LAD();return true}catch(e){console.error('Error:',e);N('‚úó Error: '+(e.message||e),'error');return false}finally{S.l=false}}async function UD(t,id,upd){if(S.l)return false;S.l=true;try{const{error}=await db.from(t).update(upd).eq('id',id);if(error)throw error;N('‚úì Actualizado correctamente','success');await LAD();return true}catch(e){console.error('Error:',e);N('‚úó Error al actualizar','error');return false}finally{S.l=false}}async function DD(t,id){S.l=true;try{const{error}=await db.from(t).delete().eq('id',id);if(error)throw error;N('‚úì Eliminado','success');await LAD();return true}catch(e){console.error('Error:',e);N('‚úó Error al eliminar','error');return false}finally{S.l=false}}async function RA(a){try{await db.from('auditoria').insert([{accion:a,usuario:S.cu?.nombre||'Sistema',fecha:new Date().toISOString()}])}catch(e){console.error('Error auditor√≠a:',e)}}async function LAD(){if(S.la){let w=0;while(S.la&&w<3000){await new Promise(r=>setTimeout(r,50));w+=50}if(!S.la)return}S.la=true;S.l=true;try{const[u,c,m,a,v,d,i,l,b,al,au,se]=await Promise.all([LD('usuarios'),LD('ciudadanos'),LD('multas'),LD('arrestos'),LD('vehiculos'),LD('denuncias'),LD('investigaciones'),LD('llamadas'),LD('bolo'),LD('alertas'),LD('auditoria'),LD('servicio')]);S.d={usuarios:u||[],ciudadanos:c||[],multas:m||[],arrestos:a||[],vehiculos:v||[],denuncias:d||[],investigaciones:i||[],llamadas:l||[],bolo:b||[],alertas:al||[],auditoria:au||[],servicio:se||[]};updateCardBadges()}catch(e){console.error('Error cargando datos:',e)}finally{S.l=false;S.la=false}}function N(m,t='info'){const n=document.createElement('div');n.style.cssText=`position:fixed;top:80px;right:20px;z-index:10000;padding:14px 24px;border-radius:10px;background:${t==='success'?'linear-gradient(90deg,#10b981,#059669)':t==='danger'?'linear-gradient(90deg,#ef4444,#dc2626)':'linear-gradient(90deg,var(--accent),var(--accent-2))'};color:white;font-weight:700;box-shadow:0 10px 40px rgba(0,0,0,0.6);animation:slideIn 0.3s ease`;n.textContent=m;document.body.appendChild(n);setTimeout(()=>{n.style.animation='slideOut 0.3s ease';setTimeout(()=>n.remove(),300)},t==='danger'?6000:3000)}function updateCardBadges(){const b={ciudadanos:S.d.ciudadanos.length,servicio:S.d.servicio.length,multas:S.d.multas.length,arrestos:S.d.arrestos.length,vehiculos:S.d.vehiculos.length,denuncias:S.d.denuncias.length,investigaciones:S.d.investigaciones.length,llamadas:S.d.llamadas.length,bolo:S.d.bolo.length,alertas:S.d.alertas.length,auditoria:S.d.auditoria.length};Object.keys(b).forEach(id=>{const c=document.querySelector(`[data-card="${id}"]`);if(c&&b[id]>0){let bg=c.querySelector('.badge');if(!bg){bg=document.createElement('div');bg.className='badge';c.appendChild(bg)}bg.textContent=b[id]}else if(c){const bg=c.querySelector('.badge');if(bg)bg.remove()}})}async function SCA(code,desc){if(!S.cu){N('Debe estar logueado para enviar c√≥digos.','error');return}const payload={type:'broadcast',event:'code_alert',payload:{code:code,desc:desc,user:S.cu.nombre,placa:S.cu.placa||'N/A'}};await db.channel('police_channel').send(payload);N(`üì° C√≥digo ${code} enviado: ${desc}`,'info');await RA(`C√≥digo emitido: ${code} - ${desc}`)}function IR(){db.channel('police_channel').on('broadcast',{event:'code_alert'},payload=>{const d=payload.payload;const m=`üö® C√ìDIGO ${d.code} | ${d.desc} (Por: ${d.user} - ${d.placa})`;N(m,'danger')}).subscribe()}

const P={GENERAL:['oficial','dispatch','detective','narcoticos','sargento','capitan','admin'],COMMAND:['sargento','capitan','admin'],DISPATCH:['dispatch','sargento','capitan','admin'],INVESTIGATIVE:['detective','narcoticos','sargento','capitan','admin'],NARCOTICS:['narcoticos','sargento','capitan','admin'],ADMIN:['admin']};
const CARDS=[
    {id:'ciudadanos',title:'PDA / Fichas',desc:'Base de datos de ciudadanos',icon:'üöì',roles:P.GENERAL},
    {id:'servicio',title:'En Servicio',desc:'Oficiales Activos',icon:'üü¢',roles:P.GENERAL},
    {id:'llamadas',title:'Llamadas',desc:'Dispatch de llamadas',icon:'üìû',roles:P.DISPATCH},
    {id:'buscar',title:'B√∫squeda',desc:'Consultar en todas las bases',icon:'üîç',roles:P.GENERAL},
    {id:'multas',title:'Multas',desc:'Registro de Infracciones',icon:'üìã',roles:P.GENERAL},
    {id:'arrestos',title:'Arrestos',desc:'Registro de Detenciones',icon:'‚õìÔ∏è',roles:P.GENERAL},
    {id:'vehiculos',title:'Veh√≠culos',desc:'Registro vehicular',icon:'üöó',roles:P.GENERAL},
    {id:'bolo',title:'BOLO',desc:'Sujetos/Veh√≠culos buscados',icon:'üö®',roles:P.GENERAL},
    {id:'denuncias',title:'Denuncias',desc:'Reportes de cr√≠menes',icon:'üìù',roles:P.GENERAL},
    {id:'investigaciones',title:'Investigaciones',desc:'Casos abiertos',icon:'üî¨',roles:P.INVESTIGATIVE},
    {id:'casos_gn',title:'Casos G&N',desc:'Gangs y Narc√≥ticos',icon:'üåø',roles:P.NARCOTICS},
    {id:'alertas',title:'Alertas',desc:'Avisos de Mando',icon:'‚ö†Ô∏è',roles:P.COMMAND},
    {id:'codigos',title:'C√≥digos',desc:'Se√±ales de radio/alerta',icon:'üì°',roles:P.GENERAL},
    {id:'auditoria',title:'Auditor√≠a',desc:'Registro de actividades',icon:'üìú',roles:P.ADMIN},
    {id:'admin',title:'Admin',desc:'Gesti√≥n de usuarios',icon:'‚öôÔ∏è',roles:P.ADMIN}
];

function renderCards(){
    const g=$('#cardsGrid');
    if(!g)return;
    g.innerHTML='';
    CARDS.forEach(c=>{
        // REGLA DE PERMISOS: Si no est√° logueado o el rol no est√° en la lista de roles requeridos, no renderizar.
        if(!S.cu || (c.roles && !c.roles.includes(S.cu.rol))) return; 

        const e=document.createElement('div');
        e.className='card';
        e.setAttribute('data-card',c.id);
        e.innerHTML=`<div class="icon">${c.icon}</div><div class="title">${c.title}</div><div class="desc">${c.desc}</div>`;
        e.onclick=()=>openPanel(c.id);
        g.appendChild(e);
    });
    updateCardBadges()
}

function openPanel(id){const a=$('#expandedArea');if(!a)return;a.innerHTML='';const p=document.createElement('div');p.className='expanded';a.appendChild(p);switch(id){case'ciudadanos':RC(p);break;case'servicio':RS(p);break;case'multas':RM(p);break;case'arrestos':RArr(p);break;case'vehiculos':RV(p);break;case'llamadas':RL(p);break;case'bolo':RB(p);break;case'denuncias':RD(p);break;case'investigaciones':RI(p);break;case'alertas':RAl(p);break;case'codigos':RCod(p);break;case'casos_gn':RGN(p);break;case'admin':RAdm(p);break;case'auditoria':RAud(p);break;case'buscar':RBus(p);break;default:break}setTimeout(()=>p.scrollIntoView({behavior:'smooth',block:'start'}),100)}

function RC(p){p.innerHTML=`<div class="flex" style="justify-content:space-between;margin-bottom:20px"><div><strong style="font-size:20px">üöì PDA / Fichas</strong></div><button class="btn-ghost" onclick="closePanel()">Cerrar</button></div><div class="grid-2"><div><input id="searchCiu" placeholder="Buscar por nombre o DNI..." style="margin-bottom:12px"><div id="listCiu" class="list"></div></div><div><strong>Nueva Ficha</strong><div class="flex flex-col gap-2 mt-3"><input id="cNombre" placeholder="Nombre completo *"><input id="cDNI" placeholder="DNI *"><input id="cFecha" type="date"><input id="cDir" placeholder="Direcci√≥n"><input id="cTel" placeholder="Tel√©fono"><button class="btn" onclick="window.crearCiu()">Registrar Ficha</button></div></div></div>`;LC();const s=$('#searchCiu');if(s)s.oninput=LC}function LC(){const l=$('#listCiu');if(!l)return;const q=($('#searchCiu')?.value||'').toLowerCase();const items=S.d.ciudadanos.filter(c=>(c.nombre||'').toLowerCase().includes(q)||(c.dni||'').toLowerCase().includes(q));const isA=S.cu&&S.cu.rol==='admin';l.innerHTML=items.length?items.map(c=>`<div class="item"><div style="flex:1"><strong>${html(c.nombre)}</strong><div class="muted small">DNI: ${html(c.dni)}${c.telefono?' ‚Ä¢ Tel: '+html(c.telefono):''}</div>${c.direccion?`<div class="muted small">üìç ${html(c.direccion)}</div>`:''}${c.fechaNacimiento?`<div class="muted small">üéÇ ${html(c.fechaNacimiento)}</div>`:''}</div>${isA?`<button class="btn-danger btn-ghost" onclick="window.eliminarCiu(${c.id})">Eliminar</button>`:''}</div>`).join(''):'<div class="muted small">No hay fichas registradas</div>'}window.crearCiu=async function(){const n=$('#cNombre')?.value.trim(),d=$('#cDNI')?.value.trim();if(!n||!d){N('Complete nombre y DNI','error');return}const ok=await SD('ciudadanos',{nombre:n,dni:d,fechaNacimiento:$('#cFecha')?.value||null,direccion:$('#cDir')?.value.trim()||null,telefono:$('#cTel')?.value.trim()||null,oficialRegistro:S.cu?.nombre||'Sistema',fechaRegistro:new Date().toISOString()});if(ok){await RA(`Ficha creada: ${n} (${d})`);$('#cNombre').value=$('#cDNI').value=$('#cFecha').value=$('#cDir').value=$('#cTel').value='';LC()}};window.eliminarCiu=async function(id){if(!confirm('¬øEliminar esta ficha permanentemente?'))return;const c=S.d.ciudadanos.find(x=>x.id===id);const ok=await DD('ciudadanos',id);if(ok){await RA(`Ficha eliminada: ${c?.nombre}`);LC()}};function RS(p){if(!S.cu){p.innerHTML='<div class="item"><strong>‚õî Acceso Denegado</strong><div class="muted small">Debe iniciar sesi√≥n</div></div>';return}const enServicio=S.d.servicio.find(s=>s.usuario_id===S.cu.id);p.innerHTML=`<div class="flex" style="justify-content:space-between;margin-bottom:20px"><div><strong style="font-size:20px">üü¢ Oficiales En Servicio</strong></div><button class="btn-ghost" onclick="closePanel()">Cerrar</button></div><div style="display:flex;justify-content:center;margin-bottom:20px;gap:12px;flex-wrap:wrap"><button id="btnToggleServicio" class="btn ${enServicio?'btn-danger':''}" onclick="window.toggleServicio()">${enServicio?'Salir de Servicio':'Entrar en Servicio'}</button><div id="statusServicio" class="pill" style="font-size:16px;padding:10px 18px;background:${enServicio?'rgba(6,182,164,0.2)':'rgba(255,107,107,0.2)'};color:${enServicio?'var(--accent-2)':'var(--danger)'}">${enServicio?`EN SERVICIO (${enServicio.estado||'Patrulla'})`:'FUERA DE SERVICIO'}</div></div><h4 style="margin-top:20px;border-bottom:1px solid rgba(255,255,255,0.08);padding-bottom:8px">Lista de Oficiales Activos (${S.d.servicio.length})</h4><div id="listServicio" class="list" style="max-height:350px;margin-top:12px"></div>`;LServ()}function LServ(){const l=$('#listServicio');if(!l)return;const items=S.d.servicio.sort((a,b)=>new Date(a.horaInicio)-new Date(b.horaInicio));l.innerHTML=items.length?items.map(s=>`<div class="item" style="border-color:${s.usuario_id===S.cu.id?'var(--accent)':'rgba(255,255,255,0.03)'}"><div style="flex:1"><strong>${html(s.nombre)} <span class="pill" style="font-size:10px;padding:4px 8px">${html(s.rol)}</span></strong>${s.placa?`<div class="muted small">üéñÔ∏è Placa: ${html(s.placa)}</div>`:''}<div class="muted small">Estado: <strong>${html(s.estado||'Patrulla')}</strong> ‚Ä¢ Desde: ${new Date(s.horaInicio).toLocaleTimeString()}</div></div></div>`).join(''):'<div class="muted small">No hay oficiales en servicio</div>'}window.toggleServicio=async function(){const enServicio=S.d.servicio.find(s=>s.usuario_id===S.cu.id);if(!S.cu.id){N('Error: El usuario no tiene ID. Reintente el login.','error');return}if(enServicio){if(!confirm('¬øSeguro que quiere salir de servicio?'))return;const ok=await DD('servicio',enServicio.id);if(ok){await RA(`Sali√≥ de servicio`)}}else{const ok=await SD('servicio',{usuario_id:S.cu.id,nombre:S.cu.nombre,placa:S.cu.placa||null,rol:S.cu.rol||'oficial',estado:'Patrulla',horaInicio:new Date().toISOString()});if(ok){await RA(`Entr√≥ en servicio`)}}openPanel('servicio')};function RM(p){p.innerHTML=`<div class="flex" style="justify-content:space-between;margin-bottom:20px"><div><strong style="font-size:20px">üìã Multas</strong></div><button class="btn-ghost" onclick="closePanel()">Cerrar</button></div><div class="grid-2"><div><input id="searchMulta" placeholder="Buscar..." style="margin-bottom:12px"><div id="listMultas" class="list"></div></div><div><strong>Nueva Multa</strong><div class="flex flex-col gap-2 mt-3"><input id="mNombre" placeholder="Nombre *"><input id="mDNI" placeholder="DNI *"><select id="mTipo"><option value="">Seleccione tipo</option><option>Exceso velocidad</option><option>Estacionamiento prohibido</option><option>Conducci√≥n temeraria</option><option>Sin licencia</option><option>Documentaci√≥n caducada</option><option>Otro</option></select><input id="mImporte" type="number" placeholder="Importe ‚Ç¨"><textarea id="mDesc" placeholder="Descripci√≥n"></textarea><button class="btn" onclick="window.crearMulta()">Registrar Multa</button></div></div></div>`;LM();const s=$('#searchMulta');if(s)s.oninput=LM}function LM(){const l=$('#listMultas');if(!l)return;const q=($('#searchMulta')?.value||'').toLowerCase();const items=S.d.multas.filter(m=>(m.nombre||'').toLowerCase().includes(q)||(m.dni||'').toLowerCase().includes(q)||(m.tipo||'').toLowerCase().includes(q));const isA=S.cu&&S.cu.rol==='admin';l.innerHTML=items.length?items.map(m=>`<div class="item"><div style="flex:1"><strong>${html(m.nombre)}</strong><div class="muted small">DNI: ${html(m.dni)} ‚Ä¢ ${html(m.tipo)}</div><div class="muted small">üí∞ ${m.importe}‚Ç¨${m.descripcion?' ‚Ä¢ '+html(m.descripcion):''}</div><div class="muted small">üìÖ ${new Date(m.fecha).toLocaleString()}</div></div>${isA?`<button class="btn-danger btn-ghost" onclick="window.eliminarMulta(${m.id})">Eliminar</button>`:''}</div>`).join(''):'<div class="muted small">No hay multas registradas</div>'}window.crearMulta=async function(){const n=$('#mNombre')?.value.trim(),d=$('#mDNI')?.value.trim(),t=$('#mTipo').value;if(!n||!d||!t){N('Complete campos obligatorios','error');return}const ok=await SD('multas',{nombre:n,dni:d,tipo:t,importe:parseFloat($('#mImporte')?.value)||0,descripcion:$('#mDesc')?.value.trim()||null,oficial:S.cu?.nombre||'Sistema',fecha:new Date().toISOString()});if(ok){await RA(`Multa registrada: ${n} - ${t}`);$('#mNombre').value=$('#mDNI').value=$('#mTipo').value=$('#mImporte').value=$('#mDesc').value='';LM()}};window.eliminarMulta=async function(id){if(!confirm('¬øEliminar esta multa?'))return;const ok=await DD('multas',id);if(ok){await RA('Multa eliminada');LM()}};function RArr(p){p.innerHTML=`<div class="flex" style="justify-content:space-between;margin-bottom:20px"><div><strong style="font-size:20px">‚õìÔ∏è Arrestos</strong></div><button class="btn-ghost" onclick="closePanel()">Cerrar</button></div><div class="grid-2"><div><input id="searchArresto" placeholder="Buscar..." style="margin-bottom:12px"><div id="listArrestos" class="list"></div></div><div><strong>Nuevo Arresto</strong><div class="flex flex-col gap-2 mt-3"><input id="aNombre" placeholder="Nombre *"><input id="aDNI" placeholder="DNI *"><input id="aCargo" placeholder="Cargo/Delito *"><input id="aFianza" type="number" placeholder="Fianza ‚Ç¨"><select id="aEstado"><option value="detenido">Detenido</option><option value="procesado">Procesado</option><option value="liberado">Liberado</option></select><textarea id="aDesc" placeholder="Detalles del arresto"></textarea><button class="btn" onclick="window.crearArresto()">Registrar Arresto</button></div></div></div>`;LArr();const s=$('#searchArresto');if(s)s.oninput=LArr}function LArr(){const l=$('#listArrestos');if(!l)return;const q=($('#searchArresto')?.value||'').toLowerCase();const items=S.d.arrestos.filter(a=>(a.nombre||'').toLowerCase().includes(q)||(a.dni||'').toLowerCase().includes(q)||(a.cargo||'').toLowerCase().includes(q));const isA=S.cu&&S.cu.rol==='admin';l.innerHTML=items.length?items.map(a=>`<div class="item"><div style="flex:1"><strong>${html(a.nombre)}</strong><div class="muted small">DNI: ${html(a.dni)} ‚Ä¢ ‚öñÔ∏è ${html(a.cargo)}</div><div class="muted small">Estado: ${html(a.estado)}${a.fianza?' ‚Ä¢ Fianza: '+a.fianza+'‚Ç¨':''}</div>${a.descripcion?`<div class="muted small">${html(a.descripcion)}</div>`:''}<div class="muted small">üìÖ ${new Date(a.fecha).toLocaleString()}</div></div>${isA?`<button class="btn-danger btn-ghost" onclick="window.eliminarArresto(${a.id})">Eliminar</button>`:''}</div>`).join(''):'<div class="muted small">No hay arrestos registrados</div>'}window.crearArresto=async function(){const n=$('#aNombre')?.value.trim(),d=$('#aDNI')?.value.trim(),c=$('#aCargo')?.value.trim();if(!n||!d||!c){N('Complete campos obligatorios','error');return}const ok=await SD('arrestos',{nombre:n,dni:d,cargo:c,fianza:parseFloat($('#aFianza')?.value)||0,estado:$('#aEstado').value,descripcion:$('#aDesc')?.value.trim()||null,oficial:S.cu?.nombre||'Sistema',fecha:new Date().toISOString()});if(ok){await RA(`Arresto registrado: ${n} - ${c}`);$('#aNombre').value=$('#aDNI').value=$('#aCargo').value=$('#aFianza').value=$('#aDesc').value='';LArr()}};window.eliminarArresto=async function(id){if(!confirm('¬øEliminar este arresto?'))return;const ok=await DD('arrestos',id);if(ok){await RA('Arresto eliminado');LArr()}};function RV(p){p.innerHTML=`<div class="flex" style="justify-content:space-between;margin-bottom:20px"><div><strong style="font-size:20px">üöó Veh√≠culos</strong></div><button class="btn-ghost" onclick="closePanel()">Cerrar</button></div><div class="grid-2"><div><input id="searchVehiculo" placeholder="Buscar por matr√≠cula..." style="margin-bottom:12px"><div id="listVehiculos" class="list"></div></div><div><strong>Registrar Veh√≠culo</strong><div class="flex flex-col gap-2 mt-3"><input id="vMatricula" placeholder="Matr√≠cula *"><input id="vMarca" placeholder="Marca"><input id="vModelo" placeholder="Modelo"><input id="vColor" placeholder="Color"><input id="vPropietario" placeholder="Propietario"><input id="vDNI" placeholder="DNI Propietario"><select id="vEstado"><option value="legal">Legal</option><option value="buscado">Buscado</option><option value="incautado">Incautado</option></select><button class="btn" onclick="window.crearVehiculo()">Registrar</button></div></div></div>`;LV();const s=$('#searchVehiculo');if(s)s.oninput=LV}function LV(){const l=$('#listVehiculos');if(!l)return;const q=($('#searchVehiculo')?.value||'').toLowerCase();const items=S.d.vehiculos.filter(v=>(v.matricula||'').toLowerCase().includes(q)||(v.propietario||'').toLowerCase().includes(q));const isA=S.cu&&S.cu.rol==='admin';l.innerHTML=items.length?items.map(v=>`<div class="item"><div style="flex:1"><strong>üöó ${html(v.matricula)}</strong><div class="muted small">${html(v.marca||'')} ${html(v.modelo||'')}${v.color?' ‚Ä¢ Color: '+html(v.color):''}</div>${v.propietario?`<div class="muted small">üë§ ${html(v.propietario)}${v.dniPropietario?' ('+html(v.dniPropietario)+')':''}</div>`:''}<div class="muted small">Estado: <strong>${html(v.estado)}</strong></div></div>${isA?`<button class="btn-danger btn-ghost" onclick="window.eliminarVehiculo(${v.id})">Eliminar</button>`:''}</div>`).join(''):'<div class="muted small">No hay veh√≠culos registrados</div>'}window.crearVehiculo=async function(){const m=$('#vMatricula')?.value.trim();if(!m){N('Ingrese la matr√≠cula','error');return}const ok=await SD('vehiculos',{matricula:m,marca:$('#vMarca')?.value.trim()||null,modelo:$('#vModelo')?.value.trim()||null,color:$('#vColor')?.value.trim()||null,propietario:$('#vPropietario')?.value.trim()||null,dniPropietario:$('#vDNI')?.value.trim()||null,estado:$('#vEstado').value,oficial:S.cu?.nombre||'Sistema',fecha:new Date().toISOString()});if(ok){await RA(`Veh√≠culo registrado: ${m}`);$('#vMatricula').value=$('#vMarca').value=$('#vModelo').value=$('#vColor').value=$('#vPropietario').value=$('#vDNI').value='';LV()}};window.eliminarVehiculo=async function(id){if(!confirm('¬øEliminar este veh√≠culo?'))return;const ok=await DD('vehiculos',id);if(ok){await RA('Veh√≠culo eliminado');LV()}};function RL(p){p.innerHTML=`<div class="flex" style="justify-content:space-between;margin-bottom:20px"><div><strong style="font-size:20px">üìû Llamadas / Dispatch</strong></div><button class="btn-ghost" onclick="closePanel()">Cerrar</button></div><div class="grid-2"><div><div id="listLlamadas" class="list"></div></div><div><strong>Nueva Llamada</strong><div class="flex flex-col gap-2 mt-3"><select id="lTipo"><option value="">Tipo</option><option>10-31 Crimen en progreso</option><option>10-32 Persona armada</option><option>Accidente tr√°fico</option><option>Alteraci√≥n orden p√∫blico</option><option>Robo</option><option>Violencia dom√©stica</option><option>Otra emergencia</option></select><input id="lUbicacion" placeholder="Ubicaci√≥n *"><input id="lReportante" placeholder="Quien reporta"><textarea id="lDetalles" placeholder="Detalles de la llamada"></textarea><button class="btn" onclick="window.crearLlamada()">Registrar Llamada</button></div></div></div>`;LL()}function LL(){const l=$('#listLlamadas');if(!l)return;const items=S.d.llamadas;const isA=S.cu&&S.cu.rol==='admin';l.innerHTML=items.length?items.map(ll=>`<div class="item"><div style="flex:1"><strong>üìû ${html(ll.tipo)}</strong><div class="muted small">üìç ${html(ll.ubicacion)}${ll.reportante?' ‚Ä¢ Reporta: '+html(ll.reportante):''}</div>${ll.detalles?`<div class="muted small">${html(ll.detalles)}</div>`:''}<div class="muted small">üìÖ ${new Date(ll.fecha).toLocaleString()}</div></div>${isA?`<button class="btn-danger btn-ghost" onclick="window.eliminarLlamada(${ll.id})">Eliminar</button>`:''}</div>`).join(''):'<div class="muted small">No hay llamadas registradas</div>'}window.crearLlamada=async function(){const t=$('#lTipo').value,u=$('#lUbicacion')?.value.trim();if(!t||!u){N('Complete tipo y ubicaci√≥n','error');return}const ok=await SD('llamadas',{tipo:t,ubicacion:u,reportante:$('#lReportante')?.value.trim()||null,detalles:$('#lDetalles')?.value.trim()||null,oficial:S.cu?.nombre||'Sistema',fecha:new Date().toISOString()});if(ok){await RA(`Llamada registrada: ${t} en ${u}`);$('#lTipo').value=$('#lUbicacion').value=$('#lReportante').value=$('#lDetalles').value='';LL()}};window.eliminarLlamada=async function(id){if(!confirm('¬øEliminar esta llamada?'))return;const ok=await DD('llamadas',id);if(ok){await RA('Llamada eliminada');LL()}};function RB(p){p.innerHTML=`<div class="flex" style="justify-content:space-between;margin-bottom:20px"><div><strong style="font-size:20px">üö® BOLO (Be On the Look Out)</strong></div><button class="btn-ghost" onclick="closePanel()">Cerrar</button></div><div class="grid-2"><div><div id="listBolo" class="list"></div></div><div><strong>Nuevo BOLO</strong><div class="flex flex-col gap-2 mt-3"><input id="bNombre" placeholder="Nombre/Alias *"><input id="bDNI" placeholder="DNI"><select id="bTipo"><option value="">Tipo</option><option>Sospechoso armado</option><option>Fugitivo</option><option>Veh√≠culo robado</option><option>Persona desaparecida</option><option>Otro</option></select><textarea id="bDescripcion" placeholder="Descripci√≥n f√≠sica, vestimenta, veh√≠culo..."></textarea><input id="bUltimaVez" placeholder="√öltima vez visto"><button class="btn" onclick="window.crearBolo()">Emitir BOLO</button></div></div></div>`;LB()}function LB(){const l=$('#listBolo');if(!l)return;const items=S.d.bolo;const isA=S.cu&&S.cu.rol==='admin';l.innerHTML=items.length?items.map(b=>`<div class="item" style="border-color:rgba(255,107,107,0.3)"><div style="flex:1"><strong>üö® ${html(b.nombre)}</strong>${b.dni?`<div class="muted small">DNI: ${html(b.dni)}</div>`:''}${b.tipo?`<div class="muted small">Tipo: ${html(b.tipo)}</div>`:''}${b.descripcion?`<div class="muted small">${html(b.descripcion)}</div>`:''}${b.ultimaVez?`<div class="muted small">√öltima vez: ${html(b.ultimaVez)}</div>`:''}<div class="muted small">üìÖ ${new Date(b.fecha).toLocaleString()}</div></div>${isA?`<button class="btn-danger btn-ghost" onclick="window.eliminarBolo(${b.id})">Eliminar</button>`:''}</div>`).join(''):'<div class="muted small">No hay BOLOs activos</div>'}window.crearBolo=async function(){const n=$('#bNombre')?.value.trim();if(!n){N('Ingrese nombre o alias','error');return}const ok=await SD('bolo',{nombre:n,dni:$('#bDNI')?.value.trim()||null,tipo:$('#bTipo').value||null,descripcion:$('#bDescripcion')?.value.trim()||null,ultimaVez:$('#bUltimaVez')?.value.trim()||null,oficial:S.cu?.nombre||'Sistema',fecha:new Date().toISOString()});if(ok){await RA(`BOLO emitido: ${n}`);$('#bNombre').value=$('#bDNI').value=$('#bTipo').value=$('#bDescripcion').value=$('#bUltimaVez').value='';LB()}};window.eliminarBolo=async function(id){if(!confirm('¬øEliminar este BOLO?'))return;const ok=await DD('bolo',id);if(ok){await RA('BOLO eliminado');LB()}};function RD(p){p.innerHTML=`<div class="flex" style="justify-content:space-between;margin-bottom:20px"><div><strong style="font-size:20px">üìù Denuncias</strong></div><button class="btn-ghost" onclick="closePanel()">Cerrar</button></div><div class="grid-2"><div><div id="listDenuncias" class="list"></div></div><div><strong>Nueva Denuncia</strong><div class="flex flex-col gap-2 mt-3"><input id="dDenunciante" placeholder="Denunciante *"><input id="dDNIDenunciante" placeholder="DNI Denunciante"><input id="dDenunciado" placeholder="Denunciado"><select id="dTipo"><option value="">Tipo</option><option>Robo</option><option>Agresi√≥n</option><option>Amenazas</option><option>Da√±os</option><option>Estafa</option><option>Otro</option></select><textarea id="dHechos" placeholder="Hechos relatados..."></textarea><button class="btn" onclick="window.crearDenuncia()">Registrar Denuncia</button></div></div></div>`;LDe()}function LDe(){const l=$('#listDenuncias');if(!l)return;const items=S.d.denuncias;const isA=S.cu&&S.cu.rol==='admin';l.innerHTML=items.length?items.map(d=>`<div class="item"><div style="flex:1"><strong>${html(d.tipo||'Denuncia')}</strong><div class="muted small">Denunciante: ${html(d.denunciante)}${d.dniDenunciante?' ('+html(d.dniDenunciante)+')':''}</div>${d.denunciado?`<div class="muted small">Denunciado: ${html(d.denunciado)}</div>`:''}${d.hechos?`<div class="muted small">${html(d.hechos)}</div>`:''}<div class="muted small">üìÖ ${new Date(d.fecha).toLocaleString()}</div></div>${isA?`<button class="btn-danger btn-ghost" onclick="window.eliminarDenuncia(${d.id})">Eliminar</button>`:''}</div>`).join(''):'<div class="muted small">No hay denuncias registradas</div>'}window.crearDenuncia=async function(){const den=$('#dDenunciante')?.value.trim();if(!den){N('Ingrese denunciante','error');return}const ok=await SD('denuncias',{denunciante:den,dniDenunciante:$('#dDNIDenunciante')?.value.trim()||null,denunciado:$('#dDenunciado')?.value.trim()||null,tipo:$('#dTipo').value||null,hechos:$('#dHechos')?.value.trim()||null,oficial:S.cu?.nombre||'Sistema',fecha:new Date().toISOString()});if(ok){await RA(`Denuncia registrada: ${den}`);$('#dDenunciante').value=$('#dDNIDenunciante').value=$('#dDenunciado').value=$('#dTipo').value=$('#dHechos').value='';LDe()}};window.eliminarDenuncia=async function(id){if(!confirm('¬øEliminar esta denuncia?'))return;const ok=await DD('denuncias',id);if(ok){await RA('Denuncia eliminada');LDe()}};function RI(p){p.innerHTML=`<div class="flex" style="justify-content:space-between;margin-bottom:20px"><div><strong style="font-size:20px">üî¨ Investigaciones</strong></div><button class="btn-ghost" onclick="closePanel()">Cerrar</button></div><div class="grid-2"><div><div id="listInvestigaciones" class="list"></div></div><div><strong>Nueva Investigaci√≥n</strong><div class="flex flex-col gap-2 mt-3"><input id="iCaso" placeholder="Nombre del caso *"><select id="iEstado"><option value="abierta">Abierta</option><option value="en_curso">En curso</option><option value="cerrada">Cerrada</option></select><textarea id="iDetalles" placeholder="Detalles de la investigaci√≥n..."></textarea><input id="iSospechosos" placeholder="Sospechosos"><button class="btn" onclick="window.crearInvestigacion()">Crear Investigaci√≥n</button></div></div></div>`;LI()}function LI(){const l=$('#listInvestigaciones');if(!l)return;const items=S.d.investigaciones;const isA=S.cu&&S.cu.rol==='admin';l.innerHTML=items.length?items.map(i=>`<div class="item"><div style="flex:1"><strong>üî¨ ${html(i.caso)}</strong><div class="muted small">Estado: ${html(i.estado)}${i.sospechosos?' ‚Ä¢ Sospechosos: '+html(i.sospechosos):''}</div>${i.detalles?`<div class="muted small">${html(i.detalles)}</div>`:''}<div class="muted small">üìÖ ${new Date(i.fecha).toLocaleString()}</div></div>${isA?`<button class="btn-danger btn-ghost" onclick="window.eliminarInvestigacion(${i.id})">Eliminar</button>`:''}</div>`).join(''):'<div class="muted small">No hay investigaciones activas</div>'}window.crearInvestigacion=async function(){const c=$('#iCaso')?.value.trim();if(!c){N('Ingrese nombre del caso','error');return}const ok=await SD('investigaciones',{caso:c,estado:$('#iEstado').value,detalles:$('#iDetalles')?.value.trim()||null,sospechosos:$('#iSospechosos')?.value.trim()||null,investigador:S.cu?.nombre||'Sistema',fecha:new Date().toISOString()});if(ok){await RA(`Investigaci√≥n creada: ${c}`);$('#iCaso').value=$('#iDetalles').value=$('#iSospechosos').value='';LI()}};window.eliminarInvestigacion=async function(id){if(!confirm('¬øEliminar esta investigaci√≥n?'))return;const ok=await DD('investigaciones',id);if(ok){await RA('Investigaci√≥n eliminada');LI()}};function RAl(p){p.innerHTML=`<div class="flex" style="justify-content:space-between;margin-bottom:20px"><div><strong style="font-size:20px">‚ö†Ô∏è Alertas</strong></div><button class="btn-ghost" onclick="closePanel()">Cerrar</button></div><div class="grid-2"><div><div id="listAlertas" class="list"></div></div><div><strong>Nueva Alerta</strong><div class="flex flex-col gap-2 mt-3"><select id="aTipo"><option value="">Tipo</option><option>‚ö†Ô∏è General</option><option>üö® Emergencia</option><option>‚ÑπÔ∏è Informaci√≥n</option><option>‚ö° Urgente</option></select><input id="aTitulo" placeholder="T√≠tulo *"><textarea id="aMensaje" placeholder="Mensaje de la alerta..."></textarea><button class="btn" onclick="window.crearAlerta()">Emitir Alerta</button></div></div></div>`;LAl()}function LAl(){const l=$('#listAlertas');if(!l)return;const items=S.d.alertas;const isA=S.cu&&S.cu.rol==='admin';l.innerHTML=items.length?items.map(a=>`<div class="item" style="border-color:rgba(255,165,0,0.3)"><div style="flex:1"><strong>${html(a.tipo||'‚ö†Ô∏è')} ${html(a.titulo)}</strong>${a.mensaje?`<div class="muted small">${html(a.mensaje)}</div>`:''}<div class="muted small">üìÖ ${new Date(a.fecha).toLocaleString()}</div></div>${isA?`<button class="btn-danger btn-ghost" onclick="window.eliminarAlerta(${a.id})">Eliminar</button>`:''}</div>`).join(''):'<div class="muted small">No hay alertas activas</div>'}window.crearAlerta=async function(){const t=$('#aTitulo')?.value.trim();if(!t){N('Ingrese t√≠tulo','error');return}const ok=await SD('alertas',{tipo:$('#aTipo').value||'‚ö†Ô∏è General',titulo:t,mensaje:$('#aMensaje')?.value.trim()||null,oficial:S.cu?.nombre||'Sistema',fecha:new Date().toISOString()});if(ok){await RA(`Alerta emitida: ${t}`);$('#aTipo').value=$('#aTitulo').value=$('#aMensaje').value='';LAl()}};window.eliminarAlerta=async function(id){if(!confirm('¬øEliminar esta alerta?'))return;const ok=await DD('alertas',id);if(ok){await RA('Alerta eliminada');LAl()}};function RBus(p){p.innerHTML=`<div class="flex" style="justify-content:space-between;margin-bottom:20px"><div><strong style="font-size:20px">üîç B√∫squeda Global</strong></div><button class="btn-ghost" onclick="closePanel()">Cerrar</button></div><input id="globalSearch" placeholder="Buscar en todas las bases de datos..." style="font-size:16px;padding:14px;margin-bottom:16px"><div id="searchResults"></div>`;$('#globalSearch').oninput=()=>{const q=$('#globalSearch').value.toLowerCase(),r=$('#searchResults');if(q.length<2){r.innerHTML='<div class="muted small">Escriba al menos 2 caracteres para buscar</div>';return}const c=S.d.ciudadanos.filter(x=>(x.nombre||'').toLowerCase().includes(q)||(x.dni||'').toLowerCase().includes(q));const m=S.d.multas.filter(x=>(x.nombre||'').toLowerCase().includes(q)||(x.dni||'').toLowerCase().includes(q));const a=S.d.arrestos.filter(x=>(x.nombre||'').toLowerCase().includes(q)||(x.dni||'').toLowerCase().includes(q));const v=S.d.vehiculos.filter(x=>(x.matricula||'').toLowerCase().includes(q)||(x.propietario||'').toLowerCase().includes(q));const b=S.d.bolo.filter(x=>(x.nombre||'').toLowerCase().includes(q)||(x.dni||'').toLowerCase().includes(q));let h='';if(c.length)h+=`<h4 style="margin-top:12px">üöì Fichas (${c.length})</h4><div class="list">${c.slice(0,5).map(x=>`<div class="item"><strong>${html(x.nombre)}</strong><div class="muted small">DNI: ${html(x.dni)}</div></div>`).join('')}</div>`;if(m.length)h+=`<h4 style="margin-top:16px">üìã Multas (${m.length})</h4><div class="list">${m.slice(0,5).map(x=>`<div class="item"><strong>${html(x.nombre)}</strong><div class="muted small">${html(x.tipo)} ‚Ä¢ ${x.importe}‚Ç¨</div></div>`).join('')}</div>`;if(a.length)h+=`<h4 style="margin-top:16px">‚õìÔ∏è Arrestos (${a.length})</h4><div class="list">${a.slice(0,5).map(x=>`<div class="item"><strong>${html(x.nombre)}</strong><div class="muted small">${html(x.cargo)}</div></div>`).join('')}</div>`;if(v.length)h+=`<h4 style="margin-top:16px">üöó Veh√≠culos (${v.length})</h4><div class="list">${v.slice(0,5).map(x=>`<div class="item"><strong>${html(x.matricula)}</strong><div class="muted small">${html(x.marca||'')} ${html(x.modelo||'')}</div></div>`).join('')}</div>`;if(b.length)h+=`<h4 style="margin-top:16px">üö® BOLO (${b.length})</h4><div class="list">${b.slice(0,5).map(x=>`<div class="item"><strong>${html(x.nombre)}</strong><div class="muted small">${html(x.tipo||'')}</div></div>`).join('')}</div>`;r.innerHTML=h||'<div class="muted small">Sin resultados</div>'}}

function RCod(p){p.innerHTML=`<div class="flex" style="justify-content:space-between;margin-bottom:20px"><div><strong style="font-size:20px">üì° C√≥digos Policiales</strong><div class="muted small">Click para enviar Alerta Global (Realtime)</div></div><button class="btn-ghost" onclick="closePanel()">Cerrar</button></div><input id="searchCod" placeholder="Buscar por c√≥digo o descripci√≥n..." style="margin-bottom:12px"><div id="listCodigos" class="list"></div>`;LCod();const s=$('#searchCod');if(s)s.oninput=LCod}
function LCod(){const l=$('#listCodigos');if(!l)return;const q=($('#searchCod')?.value||'').toLowerCase();const codigos=[
    {code:'10-4',desc:'Mensaje recibido, entendido'},
    {code:'10-6',desc:'Ocupado, no disponible'},
    {code:'10-8',desc:'En servicio, disponible'},
    {code:'10-10',desc:'Alerta, sujeto armado'},
    {code:'10-15',desc:'Detenido en custodia'},
    {code:'10-19',desc:'Regresando a la estaci√≥n'},
    {code:'10-20',desc:'Ubicaci√≥n actual'},
    {code:'10-23',desc:'En posici√≥n, esperando'},
    {code:'10-28',desc:'Chequear registro de veh√≠culo'},
    {code:'10-29',desc:'Chequear registro de persona'},
    {code:'10-31',desc:'Crimen en progreso, emergencia'},
    {code:'10-32',desc:'Persona armada con arma de fuego'},
    {code:'10-33',desc:'Necesito ayuda (silencioso)'},
    {code:'10-36',desc:'Informaci√≥n confidencial (privado)'},
    {code:'10-37',desc:'Necesito unidad de remolque'},
    {code:'10-99',desc:'Oficial ca√≠do o en peligro grave'},
    {code:'C√≥digo 0',desc:'Oficial en peligro inminente (prioridad)'},
    {code:'C√≥digo 1',desc:'Situaci√≥n bajo control'},
    {code:'C√≥digo 2',desc:'Respuesta urgente (sin sirenas)'},
    {code:'C√≥digo 3',desc:'Respuesta de emergencia (sirenas y luces)'},
    {code:'C√≥digo 4',desc:'No se requiere asistencia adicional'}
];const items=codigos.filter(c=>(c.code||'').toLowerCase().includes(q)||(c.desc||'').toLowerCase().includes(q));l.innerHTML=items.length?items.map(c=>`<div class="item clickable-code" onclick="window.SCA('${html(c.code)}', '${html(c.desc)}')"><div style="font-size:1.2rem;font-weight:900;color:var(--accent);margin-bottom:4px">${html(c.code)}</div><div class="muted small">${html(c.desc)}</div></div>`).join(''):'<div class="muted small">No se encontraron c√≥digos.</div>'}
window.SCA = SCA;
window.LCod = LCod;

function RGN(p){
    p.innerHTML=`<div class="flex" style="justify-content:space-between;margin-bottom:20px"><div><strong style="font-size:20px">üåø Casos Gangs & Narc√≥ticos</strong><div class="muted small">Base de datos altamente restringida.</div></div><button class="btn-ghost" onclick="closePanel()">Cerrar</button></div><div class="grid-2"><div><div id="listGN" class="list"><div class="muted small" style="padding:10px">M√≥dulo de Casos G&N. Este panel solo es visible para roles de Narc√≥ticos, Sargento, Capit√°n y Administrador.</div><div class="muted small" style="padding:10px;color:var(--accent)">Nota: Funcionalidad de base de datos no implementada en este m√≥dulo de demostraci√≥n.</div></div></div><div><strong>Nuevo Caso G&N</strong><div class="flex flex-col gap-2 mt-3"><input id="gnNombre" placeholder="Nombre del caso/operaci√≥n *"><input id="gnSospechosos" placeholder="Sospechosos/Organizaci√≥n"><textarea id="gnDetalles" placeholder="Detalles, informantes, drogas incautadas..."></textarea><button class="btn" onclick="window.crearGN()">Registrar Caso</button></div></div></div>`;
}
window.crearGN=async function(){
    const n=$('#gnNombre')?.value.trim();
    if(!n){N('Ingrese el nombre del caso','error');return}
    N(`‚úì Caso G&N "${n}" registrado (DEMO)`,'success');
    await RA(`Caso G&N registrado: ${n}`);
    $('#gnNombre').value=$('#gnSospechosos').value=$('#gnDetalles').value='';
}


function RAdm(p){if(!S.cu||S.cu.rol!=='admin'){p.innerHTML='<div class="item"><strong>‚õî Acceso Denegado</strong><div class="muted small">Solo administradores</div></div>';return}p.innerHTML=`<div class="flex" style="justify-content:space-between;margin-bottom:20px"><div><strong style="font-size:20px">‚öôÔ∏è Administraci√≥n</strong></div><button class="btn-ghost" onclick="closePanel()">Cerrar</button></div><div class="grid-2"><div><strong>Usuarios del Sistema</strong><div id="listUsuarios" class="list" style="margin-top:12px"></div></div><div><strong>Crear Usuario</strong><div class="flex flex-col gap-2 mt-3"><input id="uUsername" placeholder="Usuario *"><input id="uPassword" type="password" placeholder="Contrase√±a *"><input id="uNombre" placeholder="Nombre completo *"><input id="uPlaca" placeholder="N√∫mero de placa"><select id="uRol"><option value="oficial">Oficial</option><option value="dispatch">Dispatch/Central</option><option value="detective">Detective</option><option value="narcoticos">Gang & Narcotics</option><option value="sargento">Sargento</option><option value="capitan">Capit√°n</option><option value="admin">Administrador</option></select><button class="btn" onclick="window.crearUsuario()">Crear Usuario</button></div><div class="muted small mt-3">‚ö†Ô∏è Las contrase√±as se almacenan hasheadas</div></div></div>`;LU()}function LU(){const l=$('#listUsuarios');if(!l)return;l.innerHTML=S.d.usuarios.length?S.d.usuarios.map(u=>`<div class="item"><div style="flex:1"><strong>${html(u.nombre)}</strong><div class="muted small">üë§ ${html(u.username)} ‚Ä¢ ${html(u.rol)}</div>${u.placa?`<div class="muted small">üéñÔ∏è Placa: ${html(u.placa)}</div>`:''}<div class="muted small">üìÖ ${new Date(u.fechacreacion).toLocaleString()}</div></div>${u.username!=='admin'?`<button class="btn-danger btn-ghost" onclick="window.eliminarUsuario(${u.id})">Eliminar</button>`:`<div class="pill" style="font-size:11px">Protegido</div>`}</div>`).join(''):'<div class="muted small">No hay usuarios</div>'}window.crearUsuario=async function(){const u=$('#uUsername')?.value.trim(),p=$('#uPassword')?.value.trim(),n=$('#uNombre')?.value.trim();if(!u||!p||!n){N('Complete todos los campos obligatorios','error');return}if(p.length<6){N('La contrase√±a debe tener al menos 6 caracteres','error');return}if(S.d.usuarios.find(us=>us.username===u)){N('El usuario ya existe','error');return}const hp=await HP(p);const ok=await SD('usuarios',{username:u,password:hp,nombre:n,placa:$('#uPlaca')?.value.trim()||null,rol:$('#uRol').value,fechacreacion:new Date().toISOString()});if(ok){await RA(`Usuario creado: ${u} (${$('#uRol').value})`);$('#uUsername').value=$('#uPassword').value=$('#uNombre').value=$('#uPlaca').value='';N(`‚úì Usuario ${u} creado correctamente`,'success');LU()}};window.eliminarUsuario=async function(id){const u=S.d.usuarios.find(us=>us.id===id);if(u?.username==='admin'){N('No se puede eliminar el usuario admin','error');return}if(!confirm(`¬øEliminar usuario ${u?.username}?`))return;const ok=await DD('usuarios',id);if(ok){await RA(`Usuario eliminado: ${u?.username}`);LU()}};function RAud(p){if(!S.cu||S.cu.rol!=='admin'){p.innerHTML='<div class="item"><strong>‚õî Acceso Denegado</strong><div class="muted small">Solo administradores</div></div>';return}p.innerHTML=`<div class="flex" style="justify-content:space-between;margin-bottom:20px"><div><strong style="font-size:20px">üìú Registro de Auditor√≠a</strong></div><button class="btn-ghost" onclick="closePanel()">Cerrar</button></div><div class="muted small mb-2">Registro completo de todas las acciones del sistema</div><div id="listAuditoria" class="list"></div>`;LAud()}function LAud(){const l=$('#listAuditoria');if(!l)return;l.innerHTML=S.d.auditoria.length?S.d.auditoria.slice(0,200).map(a=>`<div class="item"><div style="flex:1"><strong>${html(a.accion)}</strong><div class="muted small">üë§ ${html(a.usuario)}</div><div class="muted small">üìÖ ${new Date(a.fecha).toLocaleString()}</div></div></div>`).join(''):'<div class="muted small">No hay registros de auditor√≠a</div>'}window.closePanel=function(){const a=$('#expandedArea');if(a)a.innerHTML='';updateCardBadges()};function UUI(){const ud=$('#userDisplay'),bl=$('#btnLogin'),bo=$('#btnLogout'),ai=$('#adminIndicator');if(!S.cu){const m=$('#loginModal');if(m)m.classList.add('show');const cg=$('#cardsGrid'),ea=$('#expandedArea');if(cg)cg.innerHTML='';if(ea)ea.innerHTML='';if(ud)ud.textContent='Sin conexi√≥n';if(bl)bl.style.display='inline-block';if(bo)bo.style.display='none';if(ai)ai.style.display='none';return}if(ud)ud.textContent=S.cu?`${S.cu.nombre} (${S.cu.rol})`:'Sin conexi√≥n';if(bl)bl.style.display=S.cu?'none':'inline-block';if(bo)bo.style.display=S.cu?'inline-block':'none';if(ai)ai.style.display=S.cu&&S.cu.rol==='admin'?'inline-block':'none';renderCards()}const lBtn=$('#btnLogin');if(lBtn)lBtn.onclick=()=>{const m=$('#loginModal');if(m)m.classList.add('show')};const cBtn=$('#btnCancelLogin');if(cBtn)cBtn.onclick=()=>{const m=$('#loginModal');if(m)m.classList.remove('show')};const loBtn=$('#btnLogout');if(loBtn)loBtn.onclick=()=>{if(confirm('¬øCerrar sesi√≥n?')){const es=S.d.servicio.find(s=>s.usuario_id===S.cu.id);if(es)DD('servicio',es.id);S.cu=null;UUI();const a=$('#expandedArea');if(a)a.innerHTML='';N('Sesi√≥n cerrada','info')}};const dlBtn=$('#btnDoLogin');if(dlBtn)dlBtn.onclick=async()=>{const u=$('#loginUser')?.value.trim(),p=$('#loginPass')?.value.trim(),err=$('#loginError');if(!u||!p){if(err){err.textContent='Complete todos los campos';err.style.display='block'}return}const hp=await HP(p);const user=S.d.usuarios.find(us=>String(us.username)===u&&String(us.password)===hp);if(!user){if(err){err.textContent='Usuario o contrase√±a incorrectos';err.style.display='block'}return}if(!user.id){if(err){err.textContent='Error: El usuario no tiene ID registrado. Contacte a soporte.';err.style.display='block'}return}S.cu=user;UUI();const m=$('#loginModal');if(m)m.classList.remove('show');const lu=$('#loginUser'),lp=$('#loginPass');if(lu)lu.value='';if(lp)lp.value='';if(err)err.style.display='none';N(`‚úì Bienvenido ${user.nombre}`,'success');await RA(`Login: ${user.username}`)};(async()=>{try{N('Conectando con Supabase...','info');await IA();await LAD();UUI();IR();N('‚úì Sistema conectado correctamente','success')}catch(e){console.error('Error de inicializaci√≥n:',e);N('‚úó Error al conectar con Supabase','error')}})()
</script>

</body>
</html>
