<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Sistema Policial Global - Seguro</title>
<style>
:root{--bg-1:#06121a;--bg-2:#071729;--muted:#9fb3bd;--text:#e6f0f6;--accent:#7c3aed;--accent-2:#06b6a4;--danger:#ff6b6b;--glass:rgba(255,255,255,0.03);--card-grad:linear-gradient(180deg,rgba(255,255,255,0.014),rgba(255,255,255,0.006));--radius:12px;--shadow:0 14px 40px rgba(2,6,10,0.6);font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Arial}
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%;background:radial-gradient(800px 300px at 12% 8%,rgba(124,58,237,0.06),transparent),linear-gradient(180deg,var(--bg-2) 0%,var(--bg-1) 60%);color:var(--text);-webkit-font-smoothing:antialiased}
.bg{position:fixed;inset:0;z-index:0;pointer-events:none;overflow:hidden}
.nebula{position:absolute;width:60vmax;height:60vmax;left:-10vmin;top:-8vmin;background:radial-gradient(circle at 30% 30%,rgba(124,58,237,0.24),transparent 30%),radial-gradient(circle at 70% 70%,rgba(6,182,164,0.12),transparent 25%);filter:blur(56px) saturate(120%);animation:float 12s ease-in-out infinite}
.nebula.r{right:-10vmin;left:auto;top:6vmin;background:radial-gradient(circle at 70% 20%,rgba(255,80,120,0.20),transparent 30%),radial-gradient(circle at 30% 80%,rgba(110,231,183,0.12),transparent 25%);animation-duration:10s;animation-direction:reverse}
@keyframes float{0%,100%{transform:translateY(-8px)}50%{transform:translateY(8px)}}
.wrap{max-width:1200px;margin:22px auto;padding:20px;position:relative;z-index:2}
header{display:flex;align-items:center;justify-content:space-between;gap:18px;margin-bottom:20px;flex-wrap:wrap}
.brand{display:flex;gap:12px;align-items:center}
.logo{width:60px;height:60px;border-radius:12px;background:linear-gradient(135deg,var(--accent-2),var(--accent));display:flex;align-items:center;justify-content:center;font-weight:900;color:#031018;font-size:28px}
h1{font-size:18px}
.subtitle{color:var(--muted);font-size:13px}
.top-right{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.pill{background:var(--glass);padding:8px 12px;border-radius:999px;font-weight:700;color:var(--muted);font-size:13px}
.btn{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#031018;padding:8px 16px;border-radius:10px;border:none;cursor:pointer;font-weight:800;transition:all .2s;font-size:13px}
.btn:hover{transform:translateY(-2px);opacity:0.9}
.btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.08);color:var(--muted);padding:7px 12px;border-radius:10px;cursor:pointer;transition:all .2s;font-weight:600;font-size:13px}
.btn-ghost:hover{border-color:var(--accent);color:var(--text)}
.btn-danger{background:linear-gradient(90deg,#ef4444,#dc2626);color:white}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:16px;margin-top:20px}
.card{background:var(--card-grad);border-radius:var(--radius);padding:20px;border:1px solid rgba(255,255,255,0.04);box-shadow:var(--shadow);min-height:140px;transition:all .18s;cursor:pointer;position:relative}
.card:hover{transform:translateY(-8px);box-shadow:0 30px 60px rgba(0,0,0,0.7);border-color:rgba(140,80,240,0.12)}
.card .icon{font-size:42px;margin-bottom:12px}
.card .title{font-weight:900;font-size:18px;margin-bottom:4px}
.card .desc{color:var(--muted);font-size:13px}
.card .badge{position:absolute;top:12px;right:12px;background:rgba(124,58,237,0.2);padding:4px 10px;border-radius:12px;font-size:11px;font-weight:800;color:var(--accent)}
.expanded{margin-top:20px;border-radius:12px;padding:24px;background:linear-gradient(180deg,rgba(255,255,255,0.012),rgba(255,255,255,0.006));border:1px solid rgba(255,255,255,0.04);box-shadow:0 16px 44px rgba(0,0,0,0.55);animation:slideUp .3s ease}
@keyframes slideUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:none}}
.list{display:flex;flex-direction:column;gap:10px;max-height:500px;overflow-y:auto;padding-right:4px}
.list::-webkit-scrollbar{width:6px}
.list::-webkit-scrollbar-track{background:rgba(0,0,0,0.2);border-radius:10px}
.list::-webkit-scrollbar-thumb{background:rgba(124,58,237,0.3);border-radius:10px}
.item{padding:14px;border-radius:10px;background:rgba(255,255,255,0.012);border:1px solid rgba(255,255,255,0.03);transition:all .2s;display:flex;justify-content:space-between;align-items:center;gap:12px}
.item:hover{background:rgba(255,255,255,0.02);border-color:rgba(140,80,240,0.08)}
input,textarea,select{background:rgba(0,0,0,0.25);border:1px solid rgba(255,255,255,0.06);padding:10px 12px;border-radius:8px;color:var(--text);font:inherit;transition:all .2s;width:100%}
input:focus,textarea:focus,select:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px rgba(124,58,237,0.1)}
textarea{min-height:100px;resize:vertical}
label{display:block;margin-bottom:6px;font-size:13px;font-weight:600;color:var(--muted)}
.overlay{position:fixed;inset:0;background:rgba(2,6,10,0.92);backdrop-filter:blur(12px);display:none;align-items:center;justify-content:center;z-index:9999}
.overlay.show{display:flex}
.modal{width:480px;max-width:95%;background:linear-gradient(180deg,#0a1628,#061421);padding:32px;border-radius:14px;border:1px solid rgba(255,255,255,0.08);box-shadow:0 25px 70px rgba(0,0,0,0.9)}
.modal h3{font-size:24px;margin-bottom:8px}
.muted{color:var(--muted)}
.small{font-size:13px}
.mt-2{margin-top:8px}
.mt-3{margin-top:12px}
.flex{display:flex}
.flex-col{flex-direction:column}
.gap-2{gap:8px}
.grid-2{display:grid;grid-template-columns:2fr 1fr;gap:20px}
.sync-indicator{position:fixed;bottom:20px;right:20px;background:var(--glass);backdrop-filter:blur(10px);padding:10px 16px;border-radius:999px;border:1px solid rgba(255,255,255,0.1);display:flex;align-items:center;gap:8px;z-index:1000}
.sync-dot{width:8px;height:8px;background:#4ade80;border-radius:50%;animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.5}}
footer{margin-top:40px;text-align:center;color:var(--muted);font-size:12px;padding-bottom:20px}
@keyframes slideIn{from{transform:translateX(100%)}to{transform:translateX(0)}}
@keyframes slideOut{from{transform:translateX(0)}to{transform:translateX(100%)}}
</style>
</head>
<body>
<div class="bg"><div class="nebula"></div><div class="nebula r"></div></div>
<div class="wrap">
<header>
<div class="brand">
<div class="logo">üõ°Ô∏è</div>
<div><h1>Sistema Policial Global</h1><div class="subtitle">üåç Sincronizaci√≥n mundial con Supabase</div></div>
</div>
<div class="top-right">
<div id="userDisplay" class="pill">Conectando...</div>
<button id="btnLogin" class="btn-ghost">Entrar</button>
<button id="btnLogout" class="btn-ghost" style="display:none">Salir</button>
<div id="adminIndicator" style="display:none" class="pill">üëë Admin</div>
</div>
</header>
<div class="grid" id="cardsGrid"></div>
<div id="expandedArea"></div>
<footer>Sistema Policial Global ‚Ä¢ Sincronizado con Supabase ‚Ä¢ 100% Gratis ‚Ä¢ Seguro</footer>
</div>
<div class="sync-indicator">
<div class="sync-dot"></div>
<span class="small">Sincronizado</span>
</div>
<div id="loginModal" class="overlay">
<div class="modal">
<h3>Iniciar Sesi√≥n</h3>
<div class="muted small">‚ö†Ô∏è Acceso solo para usuarios autorizados</div>
<div style="margin-top:24px">
<label>Usuario</label>
<input id="loginUser" placeholder="Usuario">
<label style="margin-top:12px">Contrase√±a</label>
<input id="loginPass" type="password" placeholder="Contrase√±a">
<div class="flex gap-2 mt-3">
<button id="btnDoLogin" class="btn" style="flex:1">Entrar</button>
<button id="btnCancelLogin" class="btn-ghost">Cancelar</button>
</div>
<div id="loginError" class="muted small mt-2" style="color:var(--danger);display:none"></div>
</div>
<div style="margin-top:24px;padding-top:16px;border-top:1px solid rgba(255,255,255,0.05)">
<div class="muted small">‚ö†Ô∏è Solo usuarios autorizados. Contacte al administrador para obtener acceso.</div>
</div>
</div>
</div>
<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

const SUPABASE_URL = 'https://lqwyoobsvfbetqqjjdkt.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imxxd3lvb2JzdmZiZXRxcWpqZGt0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMzOTczMTIsImV4cCI6MjA3ODk3MzMxMn0.F80qOvvwWnj_HquIM4B3LDBSDVU3_9zmKUVaCfAwXcc';

const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);
const STATE={currentUser:null,loading:false,data:{usuarios:[],ciudadanos:[],multas:[],arrestos:[],vehiculos:[],denuncias:[],investigaciones:[],llamadas:[],bolo:[],alertas:[],auditoria:[]}};
const $=(s,r=document)=>r.querySelector(s);
const html=s=>(s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));

async function hashPassword(pass){
  const encoder=new TextEncoder();
  const data=encoder.encode(pass+'POLICE_SECURE_SALT_2024_X9Z');
  const hash=await crypto.subtle.digest('SHA-256',data);
  return Array.from(new Uint8Array(hash)).map(b=>b.toString(16).padStart(2,'0')).join('');
}

async function loadData(table){
  if(STATE.loading)return[];
  try{
    const {data,error}=await supabase.from(table).select('*').order('id',{ascending:false});
    if(error)throw error;
    return data||[];
  }catch(e){
    console.error(`Error cargando ${table}:`,e);
    return[];
  }
}

async function saveData(table,item){
  if(STATE.loading)return false;
  STATE.loading=true;
  try{
    const {error}=await supabase.from(table).insert([item]);
    if(error)throw error;
    showNotif('‚úì Guardado correctamente','success');
    await loadAllData();
    return true;
  }catch(e){
    console.error('Error:',e);
    showNotif('‚úó Error: '+e.message,'error');
    return false;
  }finally{
    STATE.loading=false;
  }
}

async function deleteData(table,id){
  if(STATE.loading)return false;
  STATE.loading=true;
  try{
    const {error}=await supabase.from(table).delete().eq('id',id);
    if(error)throw error;
    showNotif('‚úì Eliminado','success');
    await loadAllData();
    return true;
  }catch(e){
    console.error('Error:',e);
    showNotif('‚úó Error al eliminar','error');
    return false;
  }finally{
    STATE.loading=false;
  }
}

async function registrarAuditoria(a){
  try{
    await supabase.from('auditoria').insert([{accion:a,usuario:STATE.currentUser?.nombre||'Sistema',fecha:new Date().toISOString()}]);
  }catch(e){
    console.error('Error auditor√≠a:',e);
  }
}

async function loadAllData(){
  if(STATE.loading)return;
  STATE.loading=true;
  try{
    const [usuarios,ciudadanos,multas,arrestos,vehiculos,denuncias,investigaciones,llamadas,bolo,alertas,auditoria]=await Promise.all([
      loadData('usuarios'),
      loadData('ciudadanos'),
      loadData('multas'),
      loadData('arrestos'),
      loadData('vehiculos'),
      loadData('denuncias'),
      loadData('investigaciones'),
      loadData('llamadas'),
      loadData('bolo'),
      loadData('alertas'),
      loadData('auditoria')
    ]);
    STATE.data={usuarios,ciudadanos,multas,arrestos,vehiculos,denuncias,investigaciones,llamadas,bolo,alertas,auditoria};
    updateCardBadges();
  }catch(e){
    console.error('Error cargando datos:',e);
  }finally{
    STATE.loading=false;
  }
}

function showNotif(m,t='info'){
  const n=document.createElement('div');
  n.style.cssText=`position:fixed;top:80px;right:20px;z-index:10000;padding:14px 24px;border-radius:10px;background:${t==='success'?'linear-gradient(90deg,#10b981,#059669)':'linear-gradient(90deg,#ef4444,#dc2626)'};color:white;font-weight:700;box-shadow:0 10px 40px rgba(0,0,0,0.6);animation:slideIn 0.3s ease`;
  n.textContent=m;
  document.body.appendChild(n);
  setTimeout(()=>{n.style.animation='slideOut 0.3s ease';setTimeout(()=>n.remove(),300)},3000);
}

function updateCardBadges(){
  const b={ciudadanos:STATE.data.ciudadanos.length,multas:STATE.data.multas.length,arrestos:STATE.data.arrestos.length,vehiculos:STATE.data.vehiculos.length,denuncias:STATE.data.denuncias.length,investigaciones:STATE.data.investigaciones.length,llamadas:STATE.data.llamadas.length,bolo:STATE.data.bolo.length,alertas:STATE.data.alertas.length,auditoria:STATE.data.auditoria.length};
  Object.keys(b).forEach(id=>{
    const c=document.querySelector(`[data-card="${id}"]`);
    if(c&&b[id]>0){
      let badge=c.querySelector('.badge');
      if(!badge){badge=document.createElement('div');badge.className='badge';c.appendChild(badge);}
      badge.textContent=b[id];
    }
  });
}

async function initAdmin(){
  try{
    const users=await loadData('usuarios');
    if(users.length===0){
      const hashedPass=await hashPassword('PoliceSecure2024!');
      await supabase.from('usuarios').insert([{
        username:'admin',
        password:hashedPass,
        nombre:'Administrador del Sistema',
        rol:'admin',
        placa:'ADMIN-001',
        fechaCreacion:new Date().toISOString()
      }]);
      console.log('‚úì Usuario admin creado');
      console.log('Credenciales: admin / PoliceSecure2024!');
    }
  }catch(e){
    console.error('Error inicializando admin:',e);
  }
}

const CARDS=[
  {id:'ciudadanos',title:'PDA / Fichas',desc:'Base de datos',icon:'üöì'},
  {id:'llamadas',title:'Llamadas',desc:'Dispatch',icon:'üìû'},
  {id:'buscar',title:'B√∫squeda',desc:'Consultar',icon:'üîç'},
  {id:'multas',title:'Multas',desc:'Infracciones',icon:'üìã'},
  {id:'arrestos',title:'Arrestos',desc:'Detenciones',icon:'‚õìÔ∏è'},
  {id:'vehiculos',title:'Veh√≠culos',desc:'Registro',icon:'üöó'},
  {id:'bolo',title:'BOLO',desc:'Buscados',icon:'üö®'},
  {id:'denuncias',title:'Denuncias',desc:'Reportes',icon:'üìù'},
  {id:'investigaciones',title:'Investigaciones',desc:'Casos',icon:'üî¨'},
  {id:'alertas',title:'Alertas',desc:'Avisos',icon:'‚ö†Ô∏è'},
  {id:'codigos',title:'C√≥digos',desc:'Se√±ales',icon:'üì°'},
  {id:'auditoria',title:'Auditor√≠a',desc:'Registro',icon:'üìú',adminOnly:true},
  {id:'admin',title:'Admin',desc:'Usuarios',icon:'‚öôÔ∏è',adminOnly:true}
];

function renderCards(){
  const g=$('#cardsGrid');
  if(!g)return;
  g.innerHTML='';
  CARDS.forEach(c=>{
    if(c.adminOnly&&(!STATE.currentUser||STATE.currentUser.rol!=='admin'))return;
    const e=document.createElement('div');
    e.className='card';
    e.setAttribute('data-card',c.id);
    e.innerHTML=`<div class="icon">${c.icon}</div><div class="title">${c.title}</div><div class="desc">${c.desc}</div>`;
    e.onclick=()=>openPanel(c.id);
    g.appendChild(e);
  });
  updateCardBadges();
}

function openPanel(id){
  const a=$('#expandedArea');
  if(!a)return;
  a.innerHTML='';
  const p=document.createElement('div');
  p.className='expanded';
  a.appendChild(p);
  
  switch(id){
    case'ciudadanos':renderCiudadanos(p);break;
    case'multas':renderMultas(p);break;
    case'arrestos':renderArrestos(p);break;
    case'vehiculos':renderVehiculos(p);break;
    case'llamadas':renderLlamadas(p);break;
    case'bolo':renderBolo(p);break;
    case'denuncias':renderDenuncias(p);break;
    case'investigaciones':renderInvestigaciones(p);break;
    case'alertas':renderAlertas(p);break;
    case'codigos':renderCodigos(p);break;
    case'admin':renderAdmin(p);break;
    case'auditoria':renderAuditoria(p);break;
    case'buscar':renderBuscar(p);break;
    default:break;
  }
  setTimeout(()=>p.scrollIntoView({behavior:'smooth',block:'start'}),100);
}

function renderCiudadanos(p){
  p.innerHTML=`<div class="flex" style="justify-content:space-between;margin-bottom:20px"><div><strong style="font-size:20px">üöì PDA / Fichas</strong></div><button class="btn-ghost" onclick="closePanel()">Cerrar</button></div><div class="grid-2"><div><input id="searchCiu" placeholder="Buscar por nombre o DNI..." style="margin-bottom:12px"><div id="listCiu" class="list"></div></div><div><strong>Nueva Ficha</strong><div class="flex flex-col gap-2 mt-3"><input id="cNombre" placeholder="Nombre completo *"><input id="cDNI" placeholder="DNI *"><input id="cFecha" type="date"><input id="cDir" placeholder="Direcci√≥n"><input id="cTel" placeholder="Tel√©fono"><button class="btn" onclick="window.crearCiu()">Registrar Ficha</button></div></div></div>`;
  loadCiu();
  const search=$('#searchCiu');
  if(search)search.oninput=loadCiu;
}

function loadCiu(){
  const l=$('#listCiu');
  if(!l)return;
  const q=($('#searchCiu')?.value||'').toLowerCase();
  const items=STATE.data.ciudadanos.filter(c=>(c.nombre||'').toLowerCase().includes(q)||(c.dni||'').toLowerCase().includes(q));
  const isA=STATE.currentUser&&STATE.currentUser.rol==='admin';
  l.innerHTML=items.length?items.map(c=>`<div class="item"><div style="flex:1"><strong>${html(c.nombre)}</strong><div class="muted small">DNI: ${html(c.dni)}${c.telefono?' ‚Ä¢ Tel: '+html(c.telefono):''}</div>${c.direccion?`<div class="muted small">üìç ${html(c.direccion)}</div>`:''}${c.fechaNacimiento?`<div class="muted small">üéÇ ${html(c.fechaNacimiento)}</div>`:''}</div>${isA?`<button class="btn-danger btn-ghost" onclick="window.eliminarCiu(${c.id})">Eliminar</button>`:''}</div>`).join(''):'<div class="muted small">No hay fichas registradas</div>';
}

window.crearCiu=async function(){
  const n=$('#cNombre')?.value.trim(),d=$('#cDNI')?.value.trim();
  if(!n||!d){showNotif('Complete nombre y DNI','error');return;}
  const ok=await saveData('ciudadanos',{
    nombre:n,
    dni:d,
    fechaNacimiento:$('#cFecha')?.value||null,
    direccion:$('#cDir')?.value.trim()||null,
    telefono:$('#cTel')?.value.trim()||null,
    oficialRegistro:STATE.currentUser?.nombre||'Sistema',
    fechaRegistro:new Date().toISOString()
  });
  if(ok){
    await registrarAuditoria(`Ficha creada: ${n} (${d})`);
    $('#cNombre').value=$('#cDNI').value=$('#cFecha').value=$('#cDir').value=$('#cTel').value='';
    loadCiu();
  }
};

window.eliminarCiu=async function(id){
  if(!confirm('¬øEliminar esta ficha permanentemente?'))return;
  const c=STATE.data.ciudadanos.find(x=>x.id===id);
  const ok=await deleteData('ciudadanos',id);
  if(ok){
    await registrarAuditoria(`Ficha eliminada: ${c?.nombre}`);
    loadCiu();
  }
};

function renderMultas(p){
  p.innerHTML=`<div class="flex" style="justify-content:space-between;margin-bottom:20px"><div><strong style="font-size:20px">üìã Multas</strong></div><button class="btn-ghost" onclick="closePanel()">Cerrar</button></div><div class="grid-2"><div><input id="searchMulta" placeholder="Buscar..." style="margin-bottom:12px"><div id="listMultas" class="list"></div></div><div><strong>Nueva Multa</strong><div class="flex flex-col gap-2 mt-3"><input id="mNombre" placeholder="Nombre *"><input id="mDNI" placeholder="DNI *"><select id="mTipo"><option value="">Seleccione tipo</option><option>Exceso velocidad</option><option>Estacionamiento prohibido</option><option>Conducci√≥n temeraria</option><option>Sin licencia</option><option>Documentaci√≥n caducada</option><option>Otro</option></select><input id="mImporte" type="number" placeholder="Importe ‚Ç¨"><textarea id="mDesc" placeholder="Descripci√≥n"></textarea><button class="btn" onclick="window.crearMulta()">Registrar Multa</button></div></div></div>`;
  loadMultas();
  const s=$('#searchMulta');
  if(s)s.oninput=loadMultas;
}

function loadMultas(){
  const l=$('#listMultas');
  if(!l)return;
  const q=($('#searchMulta')?.value||'').toLowerCase();
  const items=STATE.data.multas.filter(m=>(m.nombre||'').toLowerCase().includes(q)||(m.dni||'').toLowerCase().includes(q)||(m.tipo||'').toLowerCase().includes(q));
  const isA=STATE.currentUser&&STATE.currentUser.rol==='admin';
  l.innerHTML=items.length?items.map(m=>`<div class="item"><div style="flex:1"><strong>${html(m.nombre)}</strong><div class="muted small">DNI: ${html(m.dni)} ‚Ä¢ ${html(m.tipo)}</div><div class="muted small">üí∞ ${m.importe}‚Ç¨${m.descripcion?' ‚Ä¢ '+html(m.descripcion):''}</div><div class="muted small">üìÖ ${new Date(m.fecha).toLocaleString()}</div></div>${isA?`<button class="btn-danger btn-ghost" onclick="window.eliminarMulta(${m.id})">Eliminar</button>`:''}</div>`).join(''):'<div class="muted small">No hay multas registradas</div>';
}

window.crearMulta=async function(){
  const n=$('#mNombre')?.value.trim(),d=$('#mDNI')?.value.trim(),t=$('#mTipo').value;
  if(!n||!d||!t){showNotif('Complete campos obligatorios','error');return;}
  const ok=await saveData('multas',{
    nombre:n,
    dni:d,
    tipo:t,
    importe:parseFloat($('#mImporte')?.value)||0,
    descripcion:$('#mDesc')?.value.trim()||null,
    oficial:STATE.currentUser?.nombre||'Sistema',
    fecha:new Date().toISOString()
  });
  if(ok){
    await registrarAuditoria(`Multa registrada: ${n} - ${t}`);
    $('#mNombre').value=$('#mDNI').value=$('#mTipo').value=$('#mImporte').value=$('#mDesc').value='';
    loadMultas();
  }
};

window.eliminarMulta=async function(id){
  if(!confirm('¬øEliminar esta multa?'))return;
  const ok=await deleteData('multas',id);
  if(ok){
    await registrarAuditoria('Multa eliminada');
    loadMultas();
  }
};

function renderArrestos(p){
  p.innerHTML=`<div class="flex" style="justify-content:space-between;margin-bottom:20px"><div><strong style="font-size:20px">‚õìÔ∏è Arrestos</strong></div><button class="btn-ghost" onclick="closePanel()">Cerrar</button></div><div class="grid-2"><div><input id="searchArresto" placeholder="Buscar..." style="margin-bottom:12px"><div id="listArrestos" class="list"></div></div><div><strong>Nuevo Arresto</strong><div class="flex flex-col gap-2 mt-3"><input id="aNombre" placeholder="Nombre *"><input id="aDNI" placeholder="DNI *"><input id="aCargo" placeholder="Cargo/Delito *"><input id="aFianza" type="number" placeholder="Fianza ‚Ç¨"><select id="aEstado"><option value="detenido">Detenido</option><option value="procesado">Procesado</option><option value="liberado">Liberado</option></select><textarea id="aDesc" placeholder="Detalles del arresto"></textarea><button class="btn" onclick="window.crearArresto()">Registrar Arresto</button></div></div></div>`;
  loadArrestos();
  const s=$('#searchArresto');
  if(s)s.oninput=loadArrestos;
}

function loadArrestos(){
  const l=$('#listArrestos');
  if(!l)return;
  const q=($('#searchArresto')?.value||'').toLowerCase();
  const items=STATE.data.arrestos.filter(a=>(a.nombre||'').toLowerCase().includes(q)||(a.dni||'').toLowerCase().includes(q)||(a.cargo||'').toLowerCase().includes(q));
  const isA=STATE.currentUser&&STATE.currentUser.rol==='admin';
  l.innerHTML=items.length?items.map(a=>`<div class="item"><div style="flex:1"><strong>${html(a.nombre)}</strong><div class="muted small">DNI: ${html(a.dni)} ‚Ä¢ ‚öñÔ∏è ${html(a.cargo)}</div><div class="muted small">Estado: ${html(a.estado)}${a.fianza?' ‚Ä¢ Fianza: '+a.fianza+'‚Ç¨':''}</div>${a.descripcion?`<div class="muted small">${html(a.descripcion)}</div>`:''}<div class="muted small">üìÖ ${new Date(a.fecha).toLocaleString()}</div></div>${isA?`<button class="btn-danger btn-ghost" onclick="window.eliminarArresto(${a.id})">Eliminar</button>`:''}</div>`).join(''):'<div class="muted small">No hay arrestos registrados</div>';
}

window.crearArresto=async function(){
  const n=$('#aNombre')?.value.trim(),d=$('#aDNI')?.value.trim(),c=$('#aCargo')?.value.trim();
  if(!n||!d||!c){showNotif('Complete campos obligatorios','error');return;}
  const ok=await saveData('arrestos',{
    nombre:n,
    dni:d,
    cargo:c,
    fianza:parseFloat($('#aFianza')?.value)||0,
    estado:$('#aEstado').value,
    descripcion:$('#aDesc')?.value.trim()||null,
    oficial:STATE.currentUser?.nombre||'Sistema',
    fecha:new Date().toISOString()
  });
  if(ok){
    await registrarAuditoria(`Arresto registrado: ${n} - ${c}`);
    $('#aNombre').value=$('#aDNI').value=$('#aCargo').value=$('#aFianza').value=$('#aDesc').value='';
    loadArrestos();
  }
};

window.eliminarArresto=async function(id){
  if(!confirm('¬øEliminar este arresto?'))return;
  const ok=await deleteData('arrestos',id);
  if(ok){
    await registrarAuditoria('Arresto eliminado');
    loadArrestos();
  }
};

function renderVehiculos(p){
  p.innerHTML=`<div class="flex" style="justify-content:space-between;margin-bottom:20px"><div><strong style="font-size:20px">üöó Veh√≠culos</strong></div><button class="btn-ghost" onclick="closePanel()">Cerrar</button></div><div class="grid-2"><div><input id="searchVehiculo" placeholder="Buscar por matr√≠cula..." style="margin-bottom:12px"><div id="listVehiculos" class="list"></div></div><div><strong>Registrar Veh√≠culo</strong><div class="flex flex-col gap-2 mt-3"><input id="vMatricula" placeholder="Matr√≠cula *"><input id="vMarca" placeholder="Marca"><input id="vModelo" placeholder="Modelo"><input id="vColor" placeholder="Color"><input id="vPropietario" placeholder="Propietario"><input id="vDNI" placeholder="DNI Propietario"><select id="vEstado"><option value="legal">Legal</option><option value="buscado">Buscado</option><option value="incautado">Incautado</option></select><button class="btn" onclick="window.crearVehiculo()">Registrar</button></div></div></div>`;
  loadVehiculos();
  const s=$('#searchVehiculo');
  if(s)s.oninput=loadVehiculos;
}

function loadVehiculos(){
  const l=$('#listVehiculos');
  if(!l)return;
  const q=($('#searchVehiculo')?.value||'').toLowerCase();
  const items=STATE.data.vehiculos.filter(v=>(v.matricula||'').toLowerCase().includes(q)||(v.propietario||'').toLowerCase().includes(q));
  const isA=STATE.currentUser&&STATE.currentUser.rol==='admin';
  l.innerHTML=items.length?items.map(v=>`<div class="item"><div style="flex:1"><strong>üöó ${html(v.matricula)}</strong><div class="muted small">${html(v.marca||'')} ${html(v.modelo||'')}${v.color?' ‚Ä¢ Color: '+html(v.color):''}</div>${v.propietario?`<div class="muted small">üë§ ${html(v.propietario)}${v.dniPropietario?' ('+html(v.dniPropietario)+')':''}</div>`:''}<div class="muted small">Estado: <strong>${html(v.estado)}</strong></div></div>${isA?`<button class="btn-danger btn-ghost" onclick="window.eliminarVehiculo(${v.id})">Eliminar</button>`:''}</div>`).join(''):'<div class="muted small">No hay veh√≠culos registrados</div>';
}

window.crearVehiculo=async function(){
  const m=$('#vMatricula')?.value.trim();
  if(!m){showNotif('Ingrese la matr√≠cula','error');return;}
  const ok=await saveData('vehiculos',{
    matricula:m,
    marca:$('#vMarca')?.value.trim()||null,
    modelo:$('#vModelo')?.value.trim()||null,
    color:$('#vColor')?.value.trim()||null,
    propietario:$('#vPropietario')?.value.trim()||null,
    dniPropietario:$('#vDNI')?.value.trim()||null,
    estado:$('#vEstado').value,
    oficial:STATE.currentUser?.nombre||'Sistema',
    fecha:new Date().toISOString()
  });
  if(ok){
    await registrarAuditoria(`Veh√≠culo registrado: ${m}`);
    $('#vMatricula').value=$('#vMarca').value=$('#vModelo').value=$('#vColor').value=$('#vPropietario').value=$('#vDNI').value='';
    loadVehiculos();
  }
};

window.eliminarVehiculo=async function(id){
  if(!confirm('¬øEliminar este veh√≠culo?'))return;
  const ok=await deleteData('vehiculos',id);
  if(ok){
    await registrarAuditoria('Veh√≠culo eliminado');
    loadVehiculos();
  }
};

function renderLlamadas(p){
  p.innerHTML=`<div class="flex" style="justify-content:space-between;margin-bottom:20px"><div><strong style="font-size:20px">üìû Llamadas / Dispatch</strong></div><button class="btn-ghost" onclick="closePanel()">Cerrar</button></div><div class="grid-2"><div><div id="listLlamadas" class="list"></div></div><div><strong>Nueva Llamada</strong><div class="flex flex-col gap-2 mt-3"><select id="lTipo"><option value="">Tipo</option><option>10-31 Crimen en progreso</option><option>10-32 Persona armada</option><option>Accidente tr√°fico</option><option>Alteraci√≥n orden p√∫blico</option><option>Robo</option><option>Violencia dom√©stica</option><option>Otra emergencia</option></select><input id="lUbicacion" placeholder="Ubicaci√≥n *"><input id="lReportante" placeholder="Quien reporta"><textarea id="lDetalles" placeholder="Detalles de la llamada"></textarea><button class="btn" onclick="window.crearLlamada()">Registrar Llamada</button></div></div></div>`;
  loadLlamadas();
}

function loadLlamadas(){
  const l=$('#listLlamadas');
  if(!l)return;
  const items=STATE.data.llamadas;
  const isA=STATE.currentUser&&STATE.currentUser.rol==='admin';
  l.innerHTML=items.length?items.map(ll=>`<div class="item"><div style="flex:1"><strong>üìû ${html(ll.tipo)}</strong><div class="muted small">üìç ${html(ll.ubicacion)}${ll.reportante?' ‚Ä¢ Reporta: '+html(ll.reportante):''}</div>${ll.detalles?`<div class="muted small">${html(ll.detalles)}</div>`:''}<div class="muted small">üìÖ ${new Date(ll.fecha).toLocaleString()}</div></div>${isA?`<button class="btn-danger btn-ghost" onclick="window.eliminarLlamada(${ll.id})">Eliminar</button>`:''}</div>`).join(''):'<div class="muted small">No hay llamadas registradas</div>';
}

window.crearLlamada=async function(){
  const t=$('#lTipo').value,u=$('#lUbicacion')?.value.trim();
  if(!t||!u){showNotif('Complete tipo y ubicaci√≥n','error');return;}
  const ok=await saveData('llamadas',{
    tipo:t,
    ubicacion:u,
    reportante:$('#lReportante')?.value.trim()||null,
    detalles:$('#lDetalles')?.value.trim()||null,
    oficial:STATE.currentUser?.nombre||'Sistema',
    fecha:new Date().toISOString()
  });
  if(ok){
    await registrarAuditoria(`Llamada registrada: ${t} en ${u}`);
    $('#lTipo').value=$('#lUbicacion').value=$('#lReportante').value=$('#lDetalles').value='';
    loadLlamadas();
  }
};

window.eliminarLlamada=async function(id){
  if(!confirm('¬øEliminar esta llamada?'))return;
  const ok=await deleteData('llamadas',id);
  if(ok){
    await registrarAuditoria('Llamada eliminada');
    loadLlamadas();
  }
};

function renderBolo(p){
  p.innerHTML=`<div class="flex" style="justify-content:space-between;margin-bottom:20px"><div><strong style="font-size:20px">üö® BOLO (Be On the Look Out)</strong></div><button class="btn-ghost" onclick="closePanel()">Cerrar</button></div><div class="grid-2"><div><div id="listBolo" class="list"></div></div><div><strong>Nuevo BOLO</strong><div class="flex flex-col gap-2 mt-3"><input id="bNombre" placeholder="Nombre/Alias *"><input id="bDNI" placeholder="DNI"><select id="bTipo"><option value="">Tipo</option><option>Sospechoso armado</option><option>Fugitivo</option><option>Veh√≠culo robado</option><option>Persona desaparecida</option><option>Otro</option></select><textarea id="bDescripcion" placeholder="Descripci√≥n f√≠sica, vestimenta, veh√≠culo..."></textarea><input id="bUltimaVez" placeholder="√öltima vez visto"><button class="btn" onclick="window.crearBolo()">Emitir BOLO</button></div></div></div>`;
  loadBolo();
}

function loadBolo(){
  const l=$('#listBolo');
  if(!l)return;
  const items=STATE.data.bolo;
  const isA=STATE.currentUser&&STATE.currentUser.rol==='admin';
  l.innerHTML=items.length?items.map(b=>`<div class="item" style="border-color:rgba(255,107,107,0.3)"><div style="flex:1"><strong>üö® ${html(b.nombre)}</strong>${b.dni?`<div class="muted small">DNI: ${html(b.dni)}</div>`:''}${b.tipo?`<div class="muted small">Tipo: ${html(b.tipo)}</div>`:''}${b.descripcion?`<div class="muted small">${html(b.descripcion)}</div>`:''}${b.ultimaVez?`<div class="muted small">√öltima vez: ${html(b.ultimaVez)}</div>`:''}<div class="muted small">üìÖ ${new Date(b.fecha).toLocaleString()}</div></div>${isA?`<button class="btn-danger btn-ghost" onclick="window.eliminarBolo(${b.id})">Eliminar</button>`:''}</div>`).join(''):'<div class="muted small">No hay BOLOs activos</div>';
}

window.crearBolo=async function(){
  const n=$('#bNombre')?.value.trim();
  if(!n){showNotif('Ingrese nombre o alias','error');return;}
  const ok=await saveData('bolo',{
    nombre:n,
    dni:$('#bDNI')?.value.trim()||null,
    tipo:$('#bTipo').value||null,
    descripcion:$('#bDescripcion')?.value.trim()||null,
    ultimaVez:$('#bUltimaVez')?.value.trim()||null,
    oficial:STATE.currentUser?.nombre||'Sistema',
    fecha:new Date().toISOString()
  });
  if(ok){
    await registrarAuditoria(`BOLO emitido: ${n}`);
    $('#bNombre').value=$('#bDNI').value=$('#bTipo').value=$('#bDescripcion').value=$('#bUltimaVez').value='';
    loadBolo();
  }
};

window.eliminarBolo=async function(id){
  if(!confirm('¬øEliminar este BOLO?'))return;
  const ok=await deleteData('bolo',id);
  if(ok){
    await registrarAuditoria('BOLO eliminado');
    loadBolo();
  }
};

function renderDenuncias(p){
  p.innerHTML=`<div class="flex" style="justify-content:space-between;margin-bottom:20px"><div><strong style="font-size:20px">üìù Denuncias</strong></div><button class="btn-ghost" onclick="closePanel()">Cerrar</button></div><div class="grid-2"><div><div id="listDenuncias" class="list"></div></div><div><strong>Nueva Denuncia</strong><div class="flex flex-col gap-2 mt-3"><input id="dDenunciante" placeholder="Denunciante *"><input id="dDNIDenunciante" placeholder="DNI Denunciante"><input id="dDenunciado" placeholder="Denunciado"><select id="dTipo"><option value="">Tipo</option><option>Robo</option><option>Agresi√≥n</option><option>Amenazas</option><option>Da√±os</option><option>Estafa</option><option>Otro</option></select><textarea id="dHechos" placeholder="Hechos relatados..."></textarea><button class="btn" onclick="window.crearDenuncia()">Registrar Denuncia</button></div></div></div>`;
  loadDenuncias();
}

function loadDenuncias(){
  const l=$('#listDenuncias');
  if(!l)return;
  const items=STATE.data.denuncias;
  const isA=STATE.currentUser&&STATE.currentUser.rol==='admin';
  l.innerHTML=items.length?items.map(d=>`<div class="item"><div style="flex:1"><strong>${html(d.tipo||'Denuncia')}</strong><div class="muted small">Denunciante: ${html(d.denunciante)}${d.dniDenunciante?' ('+html(d.dniDenunciante)+')':''}</div>${d.denunciado?`<div class="muted small">Denunciado: ${html(d.denunciado)}</div>`:''}${d.hechos?`<div class="muted small">${html(d.hechos)}</div>`:''}<div class="muted small">üìÖ ${new Date(d.fecha).toLocaleString()}</div></div>${isA?`<button class="btn-danger btn-ghost" onclick="window.eliminarDenuncia(${d.id})">Eliminar</button>`:''}</div>`).join(''):'<div class="muted small">No hay denuncias registradas</div>';
}

window.crearDenuncia=async function(){
  const den=$('#dDenunciante')?.value.trim();
  if(!den){showNotif('Ingrese denunciante','error');return;}
  const ok=await saveData('denuncias',{
    denunciante:den,
    dniDenunciante:$('#dDNIDenunciante')?.value.trim()||null,
    denunciado:$('#dDenunciado')?.value.trim()||null,
    tipo:$('#dTipo').value||null,
    hechos:$('#dHechos')?.value.trim()||null,
    oficial:STATE.currentUser?.nombre||'Sistema',
    fecha:new Date().toISOString()
  });
  if(ok){
    await registrarAuditoria(`Denuncia registrada: ${den}`);
    $('#dDenunciante').value=$('#dDNIDenunciante').value=$('#dDenunciado').value=$('#dTipo').value=$('#dHechos').value='';
    loadDenuncias();
  }
};

window.eliminarDenuncia=async function(id){
  if(!confirm('¬øEliminar esta denuncia?'))return;
  const ok=await deleteData('denuncias',id);
  if(ok){
    await registrarAuditoria('Denuncia eliminada');
    loadDenuncias();
  }
};

function renderInvestigaciones(p){
  p.innerHTML=`<div class="flex" style="justify-content:space-between;margin-bottom:20px"><div><strong style="font-size:20px">üî¨ Investigaciones</strong></div><button class="btn-ghost" onclick="closePanel()">Cerrar</button></div><div class="grid-2"><div><div id="listInvestigaciones" class="list"></div></div><div><strong>Nueva Investigaci√≥n</strong><div class="flex flex-col gap-2 mt-3"><input id="iCaso" placeholder="Nombre del caso *"><select id="iEstado"><option value="abierta">Abierta</option><option value="en_curso">En curso</option><option value="cerrada">Cerrada</option></select><textarea id="iDetalles" placeholder="Detalles de la investigaci√≥n..."></textarea><input id="iSospechosos" placeholder="Sospechosos"><button class="btn" onclick="window.crearInvestigacion()">Crear Investigaci√≥n</button></div></div></div>`;
  loadInvestigaciones();
}

function loadInvestigaciones(){
  const l=$('#listInvestigaciones');
  if(!l)return;
  const items=STATE.data.investigaciones;
  const isA=STATE.currentUser&&STATE.currentUser.rol==='admin';
  l.innerHTML=items.length?items.map(i=>`<div class="item"><div style="flex:1"><strong>üî¨ ${html(i.caso)}</strong><div class="muted small">Estado: ${html(i.estado)}${i.sospechosos?' ‚Ä¢ Sospechosos: '+html(i.sospechosos):''}</div>${i.detalles?`<div class="muted small">${html(i.detalles)}</div>`:''}<div class="muted small">üìÖ ${new Date(i.fecha).toLocaleString()}</div></div>${isA?`<button class="btn-danger btn-ghost" onclick="window.eliminarInvestigacion(${i.id})">Eliminar</button>`:''}</div>`).join(''):'<div class="muted small">No hay investigaciones activas</div>';
}

window.crearInvestigacion=async function(){
  const c=$('#iCaso')?.value.trim();
  if(!c){showNotif('Ingrese nombre del caso','error');return;}
  const ok=await saveData('investigaciones',{
    caso:c,
    estado:$('#iEstado').value,
    detalles:$('#iDetalles')?.value.trim()||null,
    sospechosos:$('#iSospechosos')?.value.trim()||null,
    investigador:STATE.currentUser?.nombre||'Sistema',
    fecha:new Date().toISOString()
  });
  if(ok){
    await registrarAuditoria(`Investigaci√≥n creada: ${c}`);
    $('#iCaso').value=$('#iDetalles').value=$('#iSospechosos').value='';
    loadInvestigaciones();
  }
};

window.eliminarInvestigacion=async function(id){
  if(!confirm('¬øEliminar esta investigaci√≥n?'))return;
  const ok=await deleteData('investigaciones',id);
  if(ok){
    await registrarAuditoria('Investigaci√≥n eliminada');
    loadInvestigaciones();
  }
};

function renderAlertas(p){
  p.innerHTML=`<div class="flex" style="justify-content:space-between;margin-bottom:20px"><div><strong style="font-size:20px">‚ö†Ô∏è Alertas</strong></div><button class="btn-ghost" onclick="closePanel()">Cerrar</button></div><div class="grid-2"><div><div id="listAlertas" class="list"></div></div><div><strong>Nueva Alerta</strong><div class="flex flex-col gap-2 mt-3"><select id="aTipo"><option value="">Tipo</option><option>‚ö†Ô∏è General</option><option>üö® Emergencia</option><option>‚ÑπÔ∏è Informaci√≥n</option><option>‚ö° Urgente</option></select><input id="aTitulo" placeholder="T√≠tulo *"><textarea id="aMensaje" placeholder="Mensaje de la alerta..."></textarea><button class="btn" onclick="window.crearAlerta()">Emitir Alerta</button></div></div></div>`;
  loadAlertas();
}

function loadAlertas(){
  const l=$('#listAlertas');
  if(!l)return;
  const items=STATE.data.alertas;
  const isA=STATE.currentUser&&STATE.currentUser.rol==='admin';
  l.innerHTML=items.length?items.map(a=>`<div class="item" style="border-color:rgba(255,165,0,0.3)"><div style="flex:1"><strong>${html(a.tipo||'‚ö†Ô∏è')} ${html(a.titulo)}</strong>${a.mensaje?`<div class="muted small">${html(a.mensaje)}</div>`:''}<div class="muted small">üìÖ ${new Date(a.fecha).toLocaleString()}</div></div>${isA?`<button class="btn-danger btn-ghost" onclick="window.eliminarAlerta(${a.id})">Eliminar</button>`:''}</div>`).join(''):'<div class="muted small">No hay alertas activas</div>';
}

window.crearAlerta=async function(){
  const t=$('#aTitulo')?.value.trim();
  if(!t){showNotif('Ingrese t√≠tulo','error');return;}
  const ok=await saveData('alertas',{
    tipo:$('#aTipo').value||'‚ö†Ô∏è General',
    titulo:t,
    mensaje:$('#aMensaje')?.value.trim()||null,
    oficial:STATE.currentUser?.nombre||'Sistema',
    fecha:new Date().toISOString()
  });
  if(ok){
    await registrarAuditoria(`Alerta emitida: ${t}`);
    $('#aTipo').value=$('#aTitulo').value=$('#aMensaje').value='';
    loadAlertas();
  }
};

window.eliminarAlerta=async function(id){
  if(!confirm('¬øEliminar esta alerta?'))return;
  const ok=await deleteData('alertas',id);
  if(ok){
    await registrarAuditoria('Alerta eliminada');
    loadAlertas();
  }
};

function renderBuscar(p){
  p.innerHTML=`<div class="flex" style="justify-content:space-between;margin-bottom:20px"><div><strong style="font-size:20px">üîç B√∫squeda Global</strong></div><button class="btn-ghost" onclick="closePanel()">Cerrar</button></div><input id="globalSearch" placeholder="Buscar en todas las bases de datos..." style="font-size:16px;padding:14px;margin-bottom:16px"><div id="searchResults"></div>`;
  $('#globalSearch').oninput=()=>{
    const q=$('#globalSearch').value.toLowerCase(),r=$('#searchResults');
    if(q.length<2){r.innerHTML='<div class="muted small">Escriba al menos 2 caracteres para buscar</div>';return}
    const c=STATE.data.ciudadanos.filter(x=>(x.nombre||'').toLowerCase().includes(q)||(x.dni||'').toLowerCase().includes(q));
    const m=STATE.data.multas.filter(x=>(x.nombre||'').toLowerCase().includes(q)||(x.dni||'').toLowerCase().includes(q));
    const a=STATE.data.arrestos.filter(x=>(x.nombre||'').toLowerCase().includes(q)||(x.dni||'').toLowerCase().includes(q));
    const v=STATE.data.vehiculos.filter(x=>(x.matricula||'').toLowerCase().includes(q)||(x.propietario||'').toLowerCase().includes(q));
    const b=STATE.data.bolo.filter(x=>(x.nombre||'').toLowerCase().includes(q)||(x.dni||'').toLowerCase().includes(q));
    let h='';
    if(c.length)h+=`<h4 style="margin-top:12px">üöì Fichas (${c.length})</h4><div class="list">${c.slice(0,5).map(x=>`<div class="item"><strong>${html(x.nombre)}</strong><div class="muted small">DNI: ${html(x.dni)}</div></div>`).join('')}</div>`;
    if(m.length)h+=`<h4 style="margin-top:16px">üìã Multas (${m.length})</h4><div class="list">${m.slice(0,5).map(x=>`<div class="item"><strong>${html(x.nombre)}</strong><div class="muted small">${html(x.tipo)} ‚Ä¢ ${x.importe}‚Ç¨</div></div>`).join('')}</div>`;
    if(a.length)h+=`<h4 style="margin-top:16px">‚õìÔ∏è Arrestos (${a.length})</h4><div class="list">${a.slice(0,5).map(x=>`<div class="item"><strong>${html(x.nombre)}</strong><div class="muted small">${html(x.cargo)}</div></div>`).join('')}</div>`;
    if(v.length)h+=`<h4 style="margin-top:16px">üöó Veh√≠culos (${v.length})</h4><div class="list">${v.slice(0,5).map(x=>`<div class="item"><strong>${html(x.matricula)}</strong><div class="muted small">${html(x.marca||'')} ${html(x.modelo||'')}</div></div>`).join('')}</div>`;
    if(b.length)h+=`<h4 style="margin-top:16px">üö® BOLO (${b.length})</h4><div class="list">${b.slice(0,5).map(x=>`<div class="item"><strong>${html(x.nombre)}</strong><div class="muted small">${html(x.tipo||'')}</div></div>`).join('')}</div>`;
    r.innerHTML=h||'<div class="muted small">Sin resultados</div>';
  };
}

function renderCodigos(p){
  const codigos=[{code:'10-4',desc:'Mensaje recibido'},{code:'10-6',desc:'Ocupado'},{code:'10-8',desc:'En servicio'},{code:'10-15',desc:'Detenido'},{code:'10-20',desc:'Ubicaci√≥n'},{code:'10-23',desc:'En posici√≥n'},{code:'10-31',desc:'Crimen en progreso'},{code:'10-32',desc:'Persona armada'},{code:'10-99',desc:'Oficial ca√≠do'},{code:'C√≥digo 0',desc:'Oficial en peligro'},{code:'C√≥digo 1',desc:'Situaci√≥n bajo control'},{code:'C√≥digo 2',desc:'Respuesta urgente'},{code:'C√≥digo 3',desc:'Respuesta de emergencia'},{code:'C√≥digo 4',desc:'No se requiere asistencia'}];
  p.innerHTML=`<div class="flex" style="justify-content:space-between;margin-bottom:20px"><div><strong style="font-size:20px">üì° C√≥digos Policiales</strong></div><button class="btn-ghost" onclick="closePanel()">Cerrar</button></div><div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:12px">${codigos.map(c=>`<div class="item" style="text-align:center;padding:20px;flex-direction:column;align-items:center"><div style="font-size:24px;font-weight:900;color:var(--accent);margin-bottom:8px">${c.code}</div><div class="muted small">${c.desc}</div></div>`).join('')}</div>`;
}

function renderAdmin(p){
  if(!STATE.currentUser||STATE.currentUser.rol!=='admin'){p.innerHTML='<div class="item"><strong>‚õî Acceso Denegado</strong><div class="muted small">Solo administradores</div></div>';return;}
  p.innerHTML=`<div class="flex" style="justify-content:space-between;margin-bottom:20px"><div><strong style="font-size:20px">‚öôÔ∏è Administraci√≥n</strong></div><button class="btn-ghost" onclick="closePanel()">Cerrar</button></div><div class="grid-2"><div><strong>Usuarios del Sistema</strong><div id="listUsuarios" class="list" style="margin-top:12px"></div></div><div><strong>Crear Usuario</strong><div class="flex flex-col gap-2 mt-3"><input id="uUsername" placeholder="Usuario *"><input id="uPassword" type="password" placeholder="Contrase√±a *"><input id="uNombre" placeholder="Nombre completo *"><input id="uPlaca" placeholder="N√∫mero de placa"><select id="uRol"><option value="oficial">Oficial</option><option value="sargento">Sargento</option><option value="capitan">Capit√°n</option><option value="admin">Administrador</option></select><button class="btn" onclick="window.crearUsuario()">Crear Usuario</button></div><div class="muted small mt-3">‚ö†Ô∏è Las contrase√±as se almacenan hasheadas</div></div></div>`;
  loadUsuarios();
}

function loadUsuarios(){
  const l=$('#listUsuarios');
  if(!l)return;
  l.innerHTML=STATE.data.usuarios.length?STATE.data.usuarios.map(u=>`<div class="item"><div style="flex:1"><strong>${html(u.nombre)}</strong><div class="muted small">üë§ ${html(u.username)} ‚Ä¢ ${html(u.rol)}</div>${u.placa?`<div class="muted small">üéñÔ∏è Placa: ${html(u.placa)}</div>`:''}<div class="muted small">üìÖ ${new Date(u.fechaCreacion).toLocaleString()}</div></div>${u.username!=='admin'?`<button class="btn-danger btn-ghost" onclick="window.eliminarUsuario(${u.id})">Eliminar</button>`:`<div class="pill" style="font-size:11px">Protegido</div>`}</div>`).join(''):'<div class="muted small">No hay usuarios</div>';
}

window.crearUsuario=async function(){
  const u=$('#uUsername')?.value.trim(),p=$('#uPassword')?.value.trim(),n=$('#uNombre')?.value.trim();
  if(!u||!p||!n){showNotif('Complete todos los campos obligatorios','error');return;}
  if(p.length<6){showNotif('La contrase√±a debe tener al menos 6 caracteres','error');return;}
  if(STATE.data.usuarios.find(us=>us.username===u)){showNotif('El usuario ya existe','error');return;}
  const hashedPass=await hashPassword(p);
  const ok=await saveData('usuarios',{
    username:u,
    password:hashedPass,
    nombre:n,
    placa:$('#uPlaca')?.value.trim()||null,
    rol:$('#uRol').value,
    fechaCreacion:new Date().toISOString()
  });
  if(ok){
    await registrarAuditoria(`Usuario creado: ${u} (${$('#uRol').value})`);
    $('#uUsername').value=$('#uPassword').value=$('#uNombre').value=$('#uPlaca').value='';
    showNotif(`‚úì Usuario ${u} creado correctamente`,'success');
    loadUsuarios();
  }
};

window.eliminarUsuario=async function(id){
  const u=STATE.data.usuarios.find(us=>us.id===id);
  if(u?.username==='admin'){showNotif('No se puede eliminar el usuario admin','error');return;}
  if(!confirm(`¬øEliminar usuario ${u?.username}?`))return;
  const ok=await deleteData('usuarios',id);
  if(ok){
    await registrarAuditoria(`Usuario eliminado: ${u?.username}`);
    loadUsuarios();
  }
};

function renderAuditoria(p){
  if(!STATE.currentUser||STATE.currentUser.rol!=='admin'){p.innerHTML='<div class="item"><strong>‚õî Acceso Denegado</strong><div class="muted small">Solo administradores</div></div>';return;}
  p.innerHTML=`<div class="flex" style="justify-content:space-between;margin-bottom:20px"><div><strong style="font-size:20px">üìú Registro de Auditor√≠a</strong></div><button class="btn-ghost" onclick="closePanel()">Cerrar</button></div><div class="muted small mb-2">Registro completo de todas las acciones del sistema</div><div id="listAuditoria" class="list"></div>`;
  loadAuditoria();
}

function loadAuditoria(){
  const l=$('#listAuditoria');
  if(!l)return;
  l.innerHTML=STATE.data.auditoria.length?STATE.data.auditoria.slice(0,200).map(a=>`<div class="item"><div style="flex:1"><strong>${html(a.accion)}</strong><div class="muted small">üë§ ${html(a.usuario)}</div><div class="muted small">üìÖ ${new Date(a.fecha).toLocaleString()}</div></div></div>`).join(''):'<div class="muted small">No hay registros de auditor√≠a</div>';
}

window.closePanel=function(){
  const area=$('#expandedArea');
  if(area)area.innerHTML='';
  updateCardBadges();
};

function updateUI(){
  const ud=$('#userDisplay'),bl=$('#btnLogin'),bo=$('#btnLogout'),ai=$('#adminIndicator');
  if(ud)ud.textContent=STATE.currentUser?`${STATE.currentUser.nombre} (${STATE.currentUser.rol})`:'Sin conexi√≥n';
  if(bl)bl.style.display=STATE.currentUser?'none':'inline-block';
  if(bo)bo.style.display=STATE.currentUser?'inline-block':'none';
  if(ai)ai.style.display=STATE.currentUser&&STATE.currentUser.rol==='admin'?'inline-block':'none';
  renderCards();
}

const loginBtn=$('#btnLogin');
if(loginBtn)loginBtn.onclick=()=>{
  const modal=$('#loginModal');
  if(modal)modal.classList.add('show');
};

const cancelBtn=$('#btnCancelLogin');
if(cancelBtn)cancelBtn.onclick=()=>{
  const modal=$('#loginModal');
  if(modal)modal.classList.remove('show');
};

const logoutBtn=$('#btnLogout');
if(logoutBtn)logoutBtn.onclick=()=>{
  if(confirm('¬øCerrar sesi√≥n?')){
    STATE.currentUser=null;
    updateUI();
    const area=$('#expandedArea');
    if(area)area.innerHTML='';
    showNotif('Sesi√≥n cerrada','info');
  }
};

const doLoginBtn=$('#btnDoLogin');
if(doLoginBtn)doLoginBtn.onclick=async()=>{
  const u=$('#loginUser')?.value.trim(),p=$('#loginPass')?.value.trim(),err=$('#loginError');
  if(!u||!p){
    if(err){err.textContent='Complete todos los campos';err.style.display='block';}
    return;
  }
  const hashedPass=await hashPassword(p);
  const user=STATE.data.usuarios.find(us=>us.username===u&&us.password===hashedPass);
  if(!user){
    if(err){err.textContent='Usuario o contrase√±a incorrectos';err.style.display='block';}
    return;
  }
  STATE.currentUser=user;
  updateUI();
  const modal=$('#loginModal');
  if(modal)modal.classList.remove('show');
  const lu=$('#loginUser'),lp=$('#loginPass');
  if(lu)lu.value='';
  if(lp)lp.value='';
  if(err)err.style.display='none';
  showNotif(`‚úì Bienvenido ${user.nombre}`,'success');
  await registrarAuditoria(`Login: ${user.username}`);
};

(async()=>{
  try{
    showNotif('Conectando con Supabase...','info');
    await initAdmin();
    await loadAllData();
    updateUI();
    showNotif('‚úì Sistema conectado correctamente','success');
  }catch(e){
    console.error('Error de inicializaci√≥n:',e);
    showNotif('‚úó Error al conectar con Supabase','error');
  }
})();
</script>
</body>
</html>
